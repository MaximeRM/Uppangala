---
title: Study of spatial structure of taxonomic and functional diversity in a tropical forest tree community
author: Sylvain Schmitt sylvain.schmitt@agroparistech.fr
output: 
  ioslides_presentation: default
  beamer_presentation:
    fig_caption: yes
    fonttheme: professionalfonts
  slidy_presentation: default
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 5, fig.width = 8,
  cache = T, cache.lazy = F)
```

## Functional ecology

```{r PFT scheme}
library(png)
library(grid)
img <- readPNG("RLQpres_files/figure-html/PFT.png")
 grid.raster(img)
```

## Community ecology

```{r Community scheme}
library(png)
library(grid)
img <- readPNG("RLQpres_files/figure-html/community.png")
 grid.raster(img)
```

## Analysis scheme

```{r Analysis scheme}
library(png)
library(grid)
img <- readPNG("RLQpres_files/figure-html/Uppangala6.png")
 grid.raster(img)
```

## Sampling

- 92 species over 117 (79%)
- Representing 98.8% of individuals
- 272 trees
- 1362 dried leaves
- 272 fresh leaves
- 250 fresh branch wood sample

## Direct measurements

- Tree crown exposure
- Leaf fresh weight
- Leaf thickness
- Leaf area
- Leaf dry weight
- Wood volume
- Wood dry weight

## Functional traits

```{r 1 Traits}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
table <- data.frame(
  traits = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  `mean (sd)` = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  unit = c('um', 'mm2', 'mg.g-1', 'm2.kg-1', 'g.cm-3'),
  strategy = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
kable(table,  label="traits", row.names = F)
```

Table 1: Functional traits measured.

## Traits coefficients of variation

*How vary functional traits ?*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$SP), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
```

Table 2: Coefficient of variation intra-individual, intra-specific and inter-specific.

## Functional traits PCA

*Do covariation in functional traits illustrate ecological strategy axes ?*

```{r 3 PCA PFT}
library(vegan)

PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
pca <- princomp(~ LA + WD + Thick + LDMC + SLA, data = PFT_sp, cor = T)

lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2] # Adding PCA axis in PFT values
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
     # xlab = paste('Axe 1 -', round(lambda[1]/sum(lambda)*100, 2), '%'),
     # ylab = paste('Axe 2 -', round(lambda[2]/sum(lambda)*100, 2), '%'))
     xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
# as.factor(Species[PFT_ind[row.names(pca$scores),2],6])
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
```

Figure 1: Principal component analysis on traits 

## Environment features PCA

*Do environment variables covariate ?*

```{r 4 env-com}
library(raster)
Env <- genEnv()
Env$Rivers <- readAll(Env$Rivers)
Trees <- genTrees()
Trees$SpCode <- tolower(Trees$SpCode)
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
com@data$id <- paste0('C', com@data$id)
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'))
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Rivers <- extract(Env$Rivers, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$BA <- aggregate(Trees$`2013_girth`, list(Trees$com), function(x){sum(x, na.rm = T)/2*pi})[,2]
com@data$StD <- aggregate(rep(1, length(Trees$SpCode)), list(Trees$com), sum)[,2]
rm(Deriv, XY)
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + Rivers + SW, data = com@data, cor = T)
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Figure 2: Principal component analysis performed on environment

## Communities definition

```{r 5 Com, fig.height=4}
com <- CWT(Trees, com)
```

```{r com ex}
plot(raster(com$abundance, 'WD.cwm'))
```

Figure 3: CWM for wood density in $20*20m^2$ communities

## Structural equation modelling

*Abiotic factors result of or influence functional traits ?*

```{r SEM}
library(lavaan)
m1 <- '
Abiotic =~ Slope + Curvature + Wetness + SW
Traits =~ WD.cwm + Thick.cwm + LA.cwm + LDMC.cwm + SLA.cwm
Biotic =~ BA + Canopy
Traits ~ Abiotic + Biotic
'
m2 <- '
Abiotic =~ Slope + Curvature + Wetness + SW
Traits =~ WD.cwm + Thick.cwm + LA.cwm + LDMC.cwm + SLA.cwm
Biotic =~ BA + Canopy
Biotic ~ Traits + Abiotic
'
fit1 <- sem(m1, data = com$abundance@data)
fit2 <- sem(m2, data = com$abundance@data)
semPlot::semPaths(fit1,
                  what = 'col',
                  whatLabels = 'std',
                  style = 'lisrel',
                  residuals = T,
                  nCharNodes = 0,
                  nCharEdges = 0,
                  groups='manlat',
                  pastel = T,
                  ask = F)
```

Figure 4: Path diagram for structural equation modelling.

```{r 6 lm & null models}
reg <- '~ Slope + Curvature + Wetness + SW + Canopy + BA'
LM <- lapply(com, function(x) {with(x@data, list(LES.cwm = lm(formula(paste('LES.cwm', reg))), # CWM
                                                 SLA.cwm = lm(formula(paste('SLA.cwm', reg))), 
                                                 WES.cwm = lm(formula(paste('WES.cwm', reg))),
                                                 WD.cwm = lm(formula(paste('WD.cwm', reg))),
                                                 LDMC.cwm = lm(formula(paste('LDMC.cwm', reg))),
                                                 LA.cwm = lm(formula(paste('LA.cwm', reg))),
                                                 Thick.cwm = lm(formula(paste('Thick.cwm', reg))),
                                                 LES.cwv = lm(formula(paste('LES.cwv', reg))), # CWV
                                                 SLA.cwv = lm(formula(paste('SLA.cwv', reg))), 
                                                 WES.cwv = lm(formula(paste('WES.cwv', reg))),
                                                 WD.cwv = lm(formula(paste('WD.cwv', reg))),
                                                 LDMC.cwv = lm(formula(paste('LDMC.cwv', reg))),
                                                 LA.cwv = lm(formula(paste('LA.cwv', reg))),
                                                 Thick.cwv = lm(formula(paste('Thick.cwv', reg)))))})
LM <- lapply(LM, function(y){lapply(y, function(x){step(x, direction = 'both', trace = 0)})})
Fval <- lapply(LM, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})
Fval <- lapply(Fval, function(x){do.call('rbind.data.frame', x)})
Fval <- data.frame(Fval)
names(Fval) <- names(LM)

n = 999
nPFT <- rep(list(PFT_sp), n)
nPFT <- lapply(nPFT, function(x){row.names(x) <- sample(row.names(x)) ; return(x)})
nPFT <- lapply(nPFT, function(x){x$Sp_Code <- SpCode[row.names(x)] ; return(x)})
nTrees <- rep(list(Trees[which(names(Trees) %in% c('SpCode', 'com', '2013_girth'))]), n)
nTrees <- lapply(nTrees, function(x){x$ID <- row.names(x) ; return(x)})
nTrees <- mapply(function(x,y){merge(x, y, by.x = 'SpCode', by.y = 'Sp_Code')}, x = nTrees, y = nPFT, SIMPLIFY = F)
nTrees <- lapply(nTrees, function(x){row.names(x) <- x$ID ; return(x)})
nTrees <- lapply(nTrees, function(x){x <- x[-which(names(x) == 'ID')] ; return(x)})
ncom <- lapply(nTrees, function(x){CWT(x, com[[1]])})
ncom <- lapply(ncom, `[`, names(ncom[[1]]))
ncom <- apply(do.call(rbind, ncom), 2, as.list) 
nLM <- rep(list(LM), n)
nLM <- lapply(nLM, `[`, names(nLM[[1]]))
nLM <- apply(do.call(rbind, nLM), 2, as.list)
ncom <- lapply(ncom, function(c){lapply(c, function(x){x <- rep(list(x), 14) ; return(x)})})
nLM <- mapply(function(x,y){
  mapply(function(r,s){
    mapply(function(p,q){
      lm(p$call,q)
    }, p = r, q = s, SIMPLIFY = F)
  }, r = x, s = y, SIMPLIFY = F)
}, x = nLM, y = ncom, SIMPLIFY = F)
nFval <- lapply(nLM, function(lm){lapply(lm, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})})
nFval <- lapply(nFval, function(x){lapply(x, `[`, names(x[[1]])) ; apply(do.call(rbind, x), 2, as.list)})
nFval <- lapply(nFval, function(f){lapply(f, unlist)})
pval <- 1 - mapply(function(x,y){mapply(function(r,s){rank(c(r,s))[1]/(n+1)}, r = x, s= y)}, x = lapply(as.list(Fval), as.list), y = nFval)
row.names(pval) <- row.names(Fval)
```

## Null model: traits randomization

```{r null com ex}
library(raster)
comp <- stack(raster(com$abundance, 'WD.cwm'),raster(ncom$abundance[[100]][[1]], 'WD.cwm'))
names(comp) <- c('Uppangala communities', 'Null communities')
plot(comp)
```

Figure 5: CWM for wood density in $20*20m^2$ null communities

## Null model: model comparison

```{r null ex}
hist(nFval$abundance$WD.cwm, col = 'lightgrey', border = 'white', freq = F, main = 'Null models distribution for WD CWM in abundance', xlab = ' ')
lines(density(as.numeric(nFval$abundance$WD.cwm)))
lines(rep(Fval['WD.cwm','abundance'],2), c(0, 0.13), col = 'red', lwd = 2)
mtext(paste('p-value =', round(pval['WD.cwm','abundance'],3), '**'), col = 'red')
```

Figure 6: Null models example

## CWM in abundance

*Are functional composition of communities linked to the environment ?*

```{r CWM ab}
kable(regression_table(LM, reg, pval, weight = 'abundance', metric = '.cwm'))
```

## CWM in presence-absence

*Are functional composition of communities linked to the environment ?*

```{r CWM pa}
kable(regression_table(LM, reg, pval, weight = 'presence-absence', metric = '.cwm'))
```

## Phylogenetic tree

```{r tree}
library(png)
library(grid)
img <- readPNG("RLQpres_files/figure-html/tree.png")
 grid.raster(img)
```

## Phylosignal

*Are functionnal traits phylogenetically conserved ?*

```{r Phylosignal}
data <- l
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(l$WD))]
phy <- list(full = drop.tip(tree, tips), `-WD` = tree)
data <- list(full = data[phy$full$tip.label,c(2:5,7)], `-WD` = data[phy$`-WD`$tip.label,c(3:5,7)])
p4d <- mapply(function(p,d){phylo4d(p,d)}, p = phy, d = data)
# lapply(p4d, barplot)
phyloS <- lapply(p4d, phyloSignal, methods = 'I')
phyloS <- lapply(phyloS, function(x){cbind(x$stat, x$pvalue)})
phyloS <- rbind(phyloS$`-WD`, phyloS$full['WD',])
names(phyloS) <- c('Moran\'s I', 'p-value')
phyloS$` ` <- lapply(as.list(phyloS$`p-value`), stars)
phyCor <- mapply(function(d,p){lapply(as.list(names(d)), function(x){phyloCorrelogram(p, trait = as.character(x))})}, d = data, p = p4d)
phyCor <- c(phyCor$`-WD`, list(phyCor$full[[1]]))
names(phyCor) <- unlist(lapply(phyCor, function(x){x$trait}))
lipa <- lapply(p4d, lipaMoran)
# mapply(function(x,y){barplot.phylo4d(x, bar.col=(y$p.value < 0.05) + 1)}, x = p4d, y = lipa)
kable(phyloS)
```

Table 7: Phylogenetic tree autoccorelation with Moran's I.

## Phylosignal variograms

*Are functionnal traits phylogenetically conserved ?*

```{r phylosignal plots}
par(mfrow = c(2,3))
invisible(lapply(phyCor, function(x){plot(x, main = x$trait)}))
```

## Phylosignal variograms

```{r lipa plot}
phylosignal::barplot.phylo4d(p4d$full, bar.col=(lipa$full$p.value < 0.05) + 1)
```

```{r Phylo RLQ, fig.height=4}
library(adephylo)
library(spacodiR)

# RLQ
for(i in 1:2) phy[[i]]$tip.label <- gsub('_', ' ', phy[[i]]$tip.label, fixed = T)
for(i in 1:2) phy[[i]]$tip.label <- as.character(l$Sp_Code[match(phy[[i]]$tip.label, row.names(l))])
Lm <- lapply(phy, function(x){Lm[intersect(names(Lm), x$tip.label)]})
L <- lapply(Lm, dudi.coa, scannf = F)
R <- mapply(function(x,y){dudi.pca(x, scannf = F, row.w = y$lw)}, x = rep(list(Rm), 2), y = L, SIMPLIFY = F)
phyRLQ <- mapply(function(x,y){drop.tip(x,setdiff(x$tip.label, names(y)))}, x = phy, y = Lm, SIMPLIFY = F)
Qd <- lapply(phyRLQ, distTips)
Q <- mapply(function(x,y){dudi.pco(x, scannf = F, row.w = y$cw)}, x = Qd, y = L, SIMPLIFY = F)
rlq <- mapply(function(x,y,z){rlq(x, y, z, scannf = F)}, x = R, y = L, z = Q, SIMPLIFY = F)

# Random RLQs
phyRD <- lapply(phy, function(x){x$node.label <- NULL ; return(x)})
phyRD <- lapply(phyRD, function(x){rep(list(x), 999)})
phyRD <- lapply(phyRD, function(x){lapply(x, resamp.phy)})
LmRD <- lapply(Lm, function(x){rep(list(x), 999)})
LmRD <- mapply(function(x,y){mapply(function(r,s){r[intersect(names(r), s$tip.label)]}, r = x, s = y, SIMPLIFY = F)}, x = LmRD, y = phyRD, SIMPLIFY = F)
phyRD <- mapply(function(x,y){mapply(function(r,s){drop.tip(r, setdiff(r$tip.label, names(s)))}, r = x, s= y, SIMPLIFY = F)}, x = phyRD, y = LmRD, SIMPLIFY = F)
QdRD <- lapply(phyRD, function(x){lapply(x, distTips)})
LRD <- lapply(LmRD, function(x){lapply(x, dudi.coa, scannf = F)})
RmRD <- lapply(rep(list(full = Rm, `-WD` = Rm)), function(x){rep(list(x), 999)})
RRD <- mapply(function(x,y){mapply(function(r,s){dudi.pca(r, scannf = F, row.w = s$lw)}, r = x, s = y, SIMPLIFY = F)}, x = RmRD, y = LRD, SIMPLIFY = F)
QRD <- mapply(function(x,y){mapply(function(r,s){dudi.pco(r, scannf = F, row.w = s$cw)}, r = x, s = y, SIMPLIFY = F)}, x = QdRD, y = LRD, SIMPLIFY = F)
rlqRD <- mapply(function(x,y,z){mapply(function(r,s,t){rlq(r, s, t, scannf = F)}, r = x, s = y, t = z, SIMPLIFY = F)}, x = RRD, y = LRD, z = QRD, SIMPLIFY = F)
 
# Randtest
pval <- mapply(function(x,y){rank(c(sum(x$eig), unlist(lapply(y, function(z){sum(z$eig)}))))[1]/1000}, x = rlq, y = rlqRD)
par(mfrow = c(1,2))  
invisible(mapply(function(x,y,z,l){
  hist(unlist(lapply(y, function(r){sum(r$eig)})), main = paste('Model', l, ':', 'pval =', round(z, 3)), xlab = 'Coinertia', col = 'lightgrey', border = 'white')
  lines(c(sum(x$eig), sum(x$eig)), c(0,500), col = 'red', lwd = 2)
}, x = rlq, y = rlqRD, z = as.list(pval), l = as.list(names(rlqRD))))
```

## Functional spatial structure

*Are functional composition of communities spatially structured ?*

```{r Functionnal spatial structure}
library(spacodiR)

# Traits structure
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0
Lm.l <- list(full = Lm, `-WD` = Lm)
Qm <- PFT_sp[c('SLA', 'LDMC', 'WD', 'Thick', 'LA')]
row.names(Qm) <- PFT_sp$Sp_Code
Qm.l <- list(full = Qm, `-WD` = Qm[-3])
Qm.l <- mapply(function(x,y){x[intersect(row.names(x), names(y)),]}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
Qm.l$full <- Qm.l$full[-which(is.na(Qm.l$full$WD)),]
Lm.l <- mapply(function(x,y){y[intersect(row.names(x), names(y))]}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
spafun <- mapply(function(x,y){spacodi.calc(sp.plot = t(y), sp.traits = x)}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
spafun <- do.call('rbind.data.frame', lapply(spafun, function(x){x[1:4]}))

Qm.lRD <- lapply(Qm.l, function(x){rep(list(x),999)})
Qm.lRD <- lapply(Qm.lRD, function(x){lapply(x, function(y){y[sample(row.names(y)),]})})
Lm.lRD <- lapply(Lm.l, function(x){rep(list(x),999)})
Lm.lRD <- mapply(function(x,y){mapply(function(r,s){r[row.names(s)]}, r = x, s = y, SIMPLIFY = F)}, x = Lm.lRD, y = Qm.lRD, SIMPLIFY = F)
spafun.l <- mapply(function(x,y){mapply(function(r,s){spacodi.calc(sp.plot = t(s), sp.traits = r)}, r = x, s = y, SIMPLIFY = F)}, x = Qm.lRD, y = Lm.lRD, SIMPLIFY = F)
spafun.l <- lapply(spafun.l, function(x){lapply(x, function(y){y[1:4]})})
spafunRD <- list(Ist = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Ist}))}),
                 Tst = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Tst}))}),
                 Ust = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Ust}))}),
                 TAUst = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$TAUst}))}))
pvalues <- mapply(function(obs,rd){
  mapply(function(o,r){rank(c(o, r))[1]/1000}, o = obs, r = rd)
  }, obs = lapply(as.list(spafun), as.list), rd = spafunRD)
row.names(pvalues) <- row.names(spafun)

pvalues <- as.data.frame(pvalues)[3:4]
pvalues$Ust <-  1- pvalues$Ust
spafun.res <- format(spafun[3:4], scientific = T, digits = 2)
pvalues <- data.frame(apply(pvalues, c(1,2), function(y){paste(y, stars(y, ns = ' '))}))
spafun.res$Ust <- paste(spafun.res$Ust, '/', pvalues$Ust)
spafun.res$TAUst <- paste(spafun.res$TAUst, '/', pvalues$TAUst)
kable(spafun.res)
```

Table 9: Functional spatial structure with Hardy's I Ust and TAUst.

## Phylogenetic spatial structure

*Are phylogenetic structure composition spatially structured ?*

```{r Phylogenetic spatial structure}
spaphy <- mapply(function(x,y){spacodi.calc(sp.plot = t(y), phy = x)}, x = phy, y = Lm.l, SIMPLIFY = F)
spaphy <- do.call('rbind.data.frame', lapply(spaphy, function(x){x[1:4]}))

spaphy.l <- mapply(function(x,y){mapply(function(r,s){spacodi.calc(t(r), s)}, r = x, s = y, SIMPLIFY = F)},x = LmRD, y = phyRD, SIMPLIFY = F)
spaphy.l <- lapply(spaphy.l, function(x){lapply(x, function(y){y[1:4]})})
spaphyRD <- list(Ist = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Ist}))}),
                 Tst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Tst}))}),
                 Bst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Bst}))}),
                 PIst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$PIst}))}))
pvalues <- mapply(function(obs,rd){
  mapply(function(o,r){rank(c(o, r))[1]/1000}, o = obs, r = rd)
  }, obs = lapply(as.list(spaphy), as.list), rd = spaphyRD)
row.names(pvalues) <- row.names(spaphy)

pvalues <- as.data.frame(pvalues)[3:4]
pvalues$Bst <-  rep(NaN,2)
spaphy.res <- format(spaphy[3:4], scientific = T, digits = 2)
pvalues <- data.frame(apply(pvalues, c(1,2), function(y){paste(y, stars(y, ns = ' '))}))
spaphy.res$Bst <- paste(spaphy.res$Bst, '/', pvalues$Bst)
spaphy.res$PIst <- paste(spaphy.res$PIst, '/', pvalues$PIst)
kable(spaphy.res)

# permut <- list(Bst = mapply(function(x,y){spacodi.by.nodes(sp.plot = t(y), x, sp.parm = "Bst", method = "1s")}, x = phy, y = Lm.l, SIMPLIFY = F), PIst = mapply(function(x,y){spacodi.by.nodes(sp.plot = t(y), x, sp.parm = "PIst", method = "1s")}, x = phy, y = Lm.l, SIMPLIFY = F))
# par(mfrow=c(2,2)) ; invisible(lapply(permut, function(x){lapply(x, spacodi.permutplot)}))
```

Table 10: Phylogenetic spatial structure with Hardy's I Bst and PIst.

## Discussion: Question 1

- *Are functional composition of communities linked to the environment ?*
    - **WD** increases with **SW** oriented and **concave** areas for **abundant**
    - **SLA** increases with **SW** oriented, **dry** and **convex** areas for **abundant**
    - **LA** decreases with **SW** oriented and **concave** areas for **rare**
    - **WES** increases with **SW** oriented areas for **rare**
    - Globally **environment filtering** is **weak** at this scale
    - *Do covariation in functional traits illustrate ecological strategy axes ?*
        - **Wood and leaf economic spectra**
    - *Are functional traits phylogenetically conserved ?*
        - **Short significant phylogenetic signal except for LDMC**

## Discussion: Question 1

- *Are functional composition of communities linked to the environment ?*
    - **Abundant** species on **SW** slopes have a **denser wood** increasing with **concave** surfaces and a **higher SLA** increasing with **convex** surfaces
    - **Rare** species on **SW** slopes have **smaller leaves** reducing with **concave** surfaces and **acquisitive wood strategy**
    - Globally **environment filtering** is **weak** at this scale
    - *Do covariation in functional traits illustrate ecological strategy axes ?*
        - **Wood and leaf economic spectra**
    - *Are functional traits phylogenetically conserved ?*
        - **Short significant** phylogenetic **signal** except for LDMC
        
## Discussion: Question 2

- *Are communities spatially structured ?*
    - Globally **not**
    - *Are functional composition of communities spatially structured ?*
        - A small **divergence** for **abundant** species 
    - *Are phylogenetic structure composition spatially structured ?*
        - **Not** for abundant nor for rare species
