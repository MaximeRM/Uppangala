---
title: "TopoSpecies"
author: "Sylvain Schmitt"
date: "May 26, 2016"
output: html_document
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = T, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

# Data
```{r Data}
rm(list = ls()); invisible(gc())
library(Uppangala)
library(raster)
Env <- genEnv()
Trees <- genTrees()
Species <- genSpecies()
Trees$SpCode <- as.factor(tolower(as.character(Trees$SpCode))) # Should be treated in gen functions
row.names(Species) <- tolower(row.names(Species))
Trees <- Trees[-which(is.na(Trees$X)),]
```

# Community definition
```{r Community}
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
```

# Adding topo to communities

```{r com topo}
com@data$id <- paste0('C', com@data$id)
com@data$DEM <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 2), c('slope', 'curvature', 'aspect'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
```

# Classes assignation
```{r Plot pop}
com@data$topo <- as.factor(with(com@data, topo_classes(Slope, Curvature, Aspect)))
Trees$topo <- (XY %over% com)[,6]
```

# Species habitat association table
```{r Sp habitat table, echo = F}
habitat_association <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$SpCode, Trees$topo), sum))
habitat_association <- round(habitat_association / rowSums(habitat_association, na.rm = T) * 100)
habitat_association[is.na(habitat_association)] <- 0
knitr::kable(habitat_association)
```


# Species - Habitats plots
```{r Plot sp habitat, echo = F}
SpCode <- levels(Trees$SpCode)
col <- c("#008B00", "#00CD00", "#009ACD", "#00BFFF", "#CD9B1D", "#FFC125")
# col <- terrain.colors(7)[c(1,2,5,6,3,4)]
for(Sp in SpCode){
  main <- Sp
  if(Sp %in% row.names(Species)){
    main <- paste(Species[as.character(Sp),2], Species[as.character(Sp),3], sep = ', ')
  }
  plot(raster(com, 'topo'), col = col, legend = F, main = main)
  contour(Env$DEM, add = T)
  legend('bottomleft', fill = col, legend = levels(com@data$topo), cex = 0.7)
  points(Y ~ X, Trees[Trees$SpCode == Sp,], pch = 20)
}
```
