---
title: 'Fine scale determinants of wood and leaf strategies in a low-elevation rainforest of India: vertical stratification reflects guild-dependent dynamics'
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output: pdf_document
csl: mee.csl
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
library(Uppangala)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

Built with `Uppangala` package version `r packageVersion('Uppangala')`.

# Abstract

## Keywords

functional trait; rainforest; dry season; forest strata; Western Ghats; ...

# Introduction

Understanding the determinants of species occurrence and co-occurrence is a long standing issue in ecology [@diamond_ecology_1975]. Tropical rainforests have especially fascinated ecologists due to their outstanding diversity [@connell_diversity_1978]. Many theories have been proposed to explain how species coexistence can be maintained in ecological communities . Among them, two have been hotly debated and tested those last years. First niche theory states that the niche differences of species determine wether they can establish and coexist in communities [@weiher_assembly_1995; @lortie_rethinking_2004], while neutral theory shows that species coexistence is possible even when species are functionaly equivalent, under the sole influence of stochasticity in life, death, reproduction and dispersal [@hubbell_unified_2001]. Both theory can provide realistic expectations of taxonomic diversity [@chave_comparing_2002], and some recent approaches have advocated investigating patterns of functional [@westoby_land-plant_2006; @mcgill_rebuilding_2006] and phylogenetic diversity [@mouquet_ecophylogenetics:_2012] to trace the signature of ecological processes related to specific biological attributes and adaptations. 
These approaches have been applied to resolve the conundrum of high tree diversity in tropical forests [@kraft_functional_2010; @baraloto_using_2012; @hardy_phylogenetic_2012], but studies on these ecosystems still remain scarce. We here investigate taxonomic, functional and phylogenetic diversity in a low elevation rainforest of the Western Ghats biodiversity hotspot [@myers_biodiversity_2000], where few studies have assessed the relative influence of neutral and niche-based processes on local forest composition.

The variation in functional traits among species reflect different abilities to grow, survive and reproduce in a given environment [@violle_let_2007]. These variation thus reflect fundamental trade-offs in ecological strategies along environmental gradients [@mark_westoby_plant_2002]. For instance, specific leaf area varies along a soil fertility-shade index and represent a trade-off between resource acquisition by photosynthesis and leaf investment in defense and leaf lifespan [@hodgson_is_2011]. Due to shared ecological strategies, functional traits will covary along basic leaf [@wright_worldwide_2004 but see @osnas_global_2013 and @lloyd_photosynthetically_2013] and wood [@chave_towards_2009] economics spectra. The leaf economics spectrum opposes productive ecological strategy to conservative persistent strategy. The wood economics spectrum distinguish species strategies over three axes spanning the basic CSR strategies of @grime_evidence_1977 : (i) competitive species, wiht high conductive efficiency, (ii) stress tolerant species, resistant to embolism, and (iii) disturbance tolerant species, with high mechanical strength [@chave_towards_2009]. @baraloto_decoupled_2010 highlighted decoupled wood and leaf strategies allowing independant variation of these strategies, but @reich_world-wide_2014 conversely advocated that the two spectra have to integrated in a comprehensive whole plant economics spectrum [@freschet_evidence_2010] opposing fast growing species to more conservative ones. Here we address how varying wood and leaf ecological strategies determine species community assembly in an Indian rainforest. 

A major challenge in addressing community assembly is to relate local coexistence to a broader spatial context of species dynamics [@ricklefs_disintegration_2008; @munoz_neutral_2016]. Niche-based dynamics can entail community variation along broad environmental gradients, while local community dynamics can be neutral [@leibold_coexistence_2006]. Local community dynamics can further be influenced by niche differences under the influence of competition [@macarthur_limiting_1967]. In this perspective, @messier_trait_2016 have underlined that the significance of the leaf economics spectrum is basically scale-dependent, which can explain conflicting results across studies performed at different scales. In the same logic, a spatial hierarchy of ecological dynamics can entail a hierarchy of variation in functional traits from broad variation among species along large-scale environmental gradients, to intraspecific response to micro-environmental conditions at very fine scale [@albert_when_2011]. Therefore a multiscale framework is needed to represent the hierarchy of ecological processes from regional to local scale [@lortie_rethinking_2004]. Determining the extent of neutral and niche-based dynamics thus implies decomposing diversity patterns within and among communities [@ackerly_trait-based_2007], and designing appropriate statistical tests to disentangle the influence of local and larger-scale dynamics [@bernard-verdier_community_2012]. In this paper, we will decompose diversity patterns in a large rainforest plot into sources of variation within and between communities [@kraft_disentangling_2011], and investigate the fine-scale and plot-scale dynamics using appropriate null models. For instance, @messier_trait_2016 argued the scale to which traits are covarying in ecological strategy, more especially they challenged the existence of the leaf economics spectrum at community scale.

Apart from scale-dependent dynamics in space within and among communities, ecological guilds can coexist and occupy distinct niches within communities, while the species within guilds are ecologically similar [@wilson_guilds_1999; @vergnon_niches_2009]. The neutral theory has been basically applied in rainforests to adress diversity patterns in the guild of canopy trees [@hubbell_unified_2001], thus ignoring dynamics of understorey trees. However basic ecological constraints drive resource use strategies and biotic interactions in these ecosystems and imply considering functional strategies and relationship among guilds as well. Low elevation rainforests in South India are remarkably heterogeneous in vertical structure and encompass distinctive guilds across the vertical strata [@pascal_wet_1988]. It thus provide an ideal context to analyze guild-dependent dynamics and ecological strategies in tropical rainforests. We will thus address diversity patterns and community assembly at guild-level.

In this paper, we used a trait-based approach to adress within-guild community dynamics within and among local tree assemblages in a tropical rain forest from Western Ghats, India. Although considered as a wet evergreen forest, the forest undergoes a long dry season and an intense rainy season under the influence of monsoon. In this context, we expect water stress and competition for resource to be the key drivers of forest dynamics. We thus adressed two main questions:

1. Do variations and covariations in functional traits reflect distinct ecological strategies within and among species ?
    i. How functional traits vary among species ?
    ii. Do covariations in functional traits reflect axes of ecological strategy ?
2. Does functional composition depends on potential local abiotic and biotic drivers of community dynamics ?
    i. Do local functional composition ($\alpha$ scale) reflect the influence of abiotic and biotic drivers of community dynamics ?
    ii. Do functional composition variation between communities ($\beta$ scale) reflect the changing of abiotic and biotic conditions ?

# Material and methods

## Study site

The study was carried out in a 10-ha permanent plot established in 1990 by the French Institute of Pondicherry in an undisturbed, old-growth wet evergreen Dipterocarp forest [@pascal_structure_1996]. The plot is located near Uppangala village, and thus refers to as "Uppangala plot", in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India). Annual precipitation averages 5108 mm per year but is highly variable in time with heavy rainfall from June to October (90% of the rainfall during the monsoon) and a severe dry season (monthly rainfall $\leq 45$ mm) lasting 3.8 months [@pelissier_twenty_2011]. Mean annual temperature in the station of Sampaji (15 km from Uppangala) is about 27$^\circ C$, with a mean minimum about 25$^\circ C$ during July rainfall pick and a maximum mean temperature of 29$^\circ C$ in April [@pascal_structure_1996]. Climate and pedology of the 10-ha plot can be considered as homogeneous. The topography of the site is highly heterogeneous with a regular east-west alternation between thalwegs and ridges separated by steep slopes, so that topography can be assumed as a major source of environmental variation within the forest plot [@gimaret-carpentier_sampling_1998]. We hypothesized that topographic variation should influence community variation depending on tree ecological strategies [@condit_spatial_2000].

## Floristic and trait data

Since 1989, all trees $\geq 30$ cm in girth at breast height (gbh) have been monitored in an area progressively extended to a contiguous 10-ha plot up to 2014. <!-- Need to add Cedric Vega in Acknowledgments for that. --> All trees were identified, tagged and mapped over the plot [@pelissier_twenty_2011]. 111 different species were recorded. We collected trait data on 89 over 111 (80.1%) species, which represented 99.0% of the tree individuals present in the Uppangala plot. Note that the 32 most abundant species, represent  more than 80% of Uppangala tree individuals. We sampled five individuals per species for these 32 species, and sampled one to five individuals from the remaining species (in total 267 individuals were sampled). For each individual we collected 5 mature shadow leaves and one branch sample with a diameter close to 1 cm following recommendation from @perez-harguindeguy_new_2013. Individuals and leaves were selected in consistent light conditions, development stage and sanitary state. Dawkins crown exposure index [@dawkins_management_1958] was recorder for each tree sampled. Leaf and branch samples were kept in humidified ziplock filled with enriched $CO_{2}$ air inside a black bag untill their measurement in the following 24 hours. For some individuals, we were unable to collect an appropriate branch sample (11 missing species over 89 representing 1% of individuals present in the 10 ha plot).

## Trait measurements

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, area and thickness were measured, using a weighing scale, a bend scanner and a micrometer respectively. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 $^\circ C$. Once dried, the leaves were weighted directly after been extracted from the oven to avoid humidity bias. The bark and pit of branch samples were removed in order to keep only branch wood with no soft tissues. Branch wood samples were sink in water to evaluate their volume by water displacement. Samples were then dried for 48 hours at 80 $^\circ C$ and weighted. 

We calculated five functional traits of leaf and wood samples: leaf thickness (LT in $\mu m$ ), leaf area measured from scans (LA in $mm^2$), leaf dry matter content as the leaf dry weight divided by the leaf fresh weight (LDMC in $mg.g^-1$), specific leaf area as the leaf area divided by the leaf dry mass (SLA in $m^2.kg^-1$), and branch wood density  as the the wood sample dry weight divided by its volume (WD in $g.cm^-3$, see table 1). We choose those five traits because they have been widely used, in addition of there easier measurement, and they have been shown to be good indicator of species abilities to grow, survive and reproduce [@wilson_specific_1999].

Table 1: Functional traits measured. *Traits with their abbreviation, standard unit, and associated species strategy for functionning, survival and reproduction from @baraloto_decoupled_2010.*

```{r 1 Traits}
rm(list = ls()[-which(ls() == "cores")]); invisible(gc())
PFT <- genPFT()
table <- data.frame(
  Trait = c('Leaf thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  Abbreviation = c('LT', 'LA', 'LDMC', 'SLA', 'WD'),
  Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
  Strategy = c('Leaf defense vs. investment',
        'Leaf resource capture vs.investment',
        'Leaf defense vs. investment',
        'Leaf resource acquisiton vs. defense',
        'Stem transport, structure and defense')
)
kable(table, row.names = F)
rm(table)
```

## Environmental variables

Because topography was assumed as a major source of environmental variation [@gimaret-carpentier_sampling_1998], we selected 8 topographical variables representing the abiotic environment: elevation, slope, curvature, plan curvature, profile curvature, wetness (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west: $cos(aspect~in~degres + 225)$) derived from elevation data available within the plot using the RSAGA package [@brenning_statistical_2008], and distance to the nearest potential river computed using ArcGis [@desktop_arcgis_2011]. 

In order to identify the main sources of environmental variation and to avoid multi-colinearity in subsequent analyses, we performed a principal component analysis (PCA) of the environmental variables (see supplementary materials S1). We selected the less correlated variables having the most ecological meaning. Thus we reduced our explanatory variables to 4 variables: curvature representing the water flow paths and soil accumulation areas, wetness highlighting water accumulation areas, southwesterness representing aspect [@bunyan_effect_2015] and slope, which may have both a strong effect on forest dynamics and on mutrient/water availability **ref**.

We selected two biotic factors related to local forest structure: canopy height and basal area. Canopy height, i.e. the maximum local height of the canopy, was calculated from a digital canopy model built from a LiDAR (Light Detection And Ranging) campaign done in 2013 over the Uppangala plot with a resolution of $1*1 m^2$. Basal area was calculated from 2013 and 2014 girth inventories of Uppangala plot on stems with a diameter above 30 centimeters at breast height ($DBH>30~cm$). 

## Analyses

### Traits variation and covariation

To quantify trait variation whithin and between individuals and between species we calculated the coefficient of variation (ratio of the standard deviation to the mean) of trait values between leaves of the same individual (intra-individual), between trees of the same species (intra-specific for species with more than one individual), and between species (inter-specific). In addition, to assess the covariation of trait within species, and thus potential axes of strategy, we performed a principal component analysis (PCA) of the mean value of traits per species. Subsequent community-level analysis were based on trait values averaged per species.

### Community trait variability

Across the whole 10 hectare plot, $30*30 m^2$ quadrats were defined and represented 110 local communities. @pascal_wet_1988 defined four categories of strata groups: emergent below 39m, canopy tree between 25 and 39m, sub-canopy tree between 15 and 25m, and understorey tree below 15m. Due to topography, sub-canopy tree from Uppangala are often under light exposure and participates to canopy, especially in slopes. We defined two guilds to represent vertical stratification called canopy (C), composed of emergent, canopy and sub-canopy tree, and understorey (U) trees. The 110 local communities where split by those two guilds.

To characterize the local functional composition of canopy and understorey communities we used the community weighted mean (CWM), the community weighted variance (CWV), and the coefficient of variation from the nearest neighbour distance (CVNND) [CWM and CWV, sensu @violle_let_2007; CVNND, @jung_intraspecific_2010]. CWM for each trait $t$ was calculated as the mean of species trait values, $t_{i}$, of the $i$ species in the quadrat $j$, with each species, $i$, weighted by its relative abundance, $p_{i}$:
$$CWM_{j} = \sum_{i=1}^{S} p_{i,j} * t_{i,j} ~ (1)$$
We also calculated the average of trait values based on species presence-absence, to further emphasize the contribution of less abundant and rare species in community trait composition [@cingolani_filtering_2007]. CWV for each trait $t$ was calculated as the mean distance of trait values, $t_{i}$, to $CWM$, of the $S$ species in the quadrat $j$, with each species, $i$, weighted by its relative
abundance, $p_{i}$:
$$CWV_{j} = \sum_{i=1}^{S} p_{i,j} * (t_{i,j} - CWM_{j})^2 ~ (2)$$
CVNND for each trait $t$, was calculated as the standard deviation of the nearest neighbor distances (NND), $\sigma _{NND}$, of the $i$ individuals in each community, divided by the mean NND, $\mu _{NND}$; and NND for one individual $i$ is calculated as the minimal distance $d$ between the $j$ other individuals of the community :
$$CVNND = \frac{\sigma _{NND}}{\mu _{NND}} ~ , ~ ~ ~ NND = {NND_{i} = min(d_{i,j})_{i \neq j}} ~ (3)$$

To investigate functional composition of communities we used a null model approach. A first null model (NM1) randomized trait values among species in the whole plot (permuting raw in `Trait*Species` matrix). The second model (NM2) randomized abundances among species within each community but kept the observed list of species and trait values inside communities [@bernard-verdier_community_2012]. Linear regressions between CWMs and biotic and abiotic factors ($CWM_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$), after stepwise selection, were compared to corresponding 999 null linear regressions from NM1 with F-statistic. For both CWV and CVNND, we performed a two-tailed test of the proportion of of communities differing from null expectation with adjusted p-values by Benjamini-Hochberg correction. CWV lower than expected under a null model represented convergence of trait values within the community, whereas CWV higher than null evidenced divergence in trait distribution [@bernard-verdier_community_2012]. CVNND was used to detect niche differentiation among coexisting species, which occured when the observed CVNND was lower than under a null model [@jung_intraspecific_2010]. We then calculated the standardized effect size (SES) as: $$SES = \frac{(I_{obs} - I_{null})}{\sigma _{null}} (4)$$
where $I_{obs}$ was the observed metric and $I_{null}$ and $\sigma _{null}$ were the mean and standard deviation of null distributions of NM2 and NM1 for CWV and CVNND respectively.
The influence of environment on SES values was investigated by linear regression with biotic and abiotic factors ($SES_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$). Analyses were conducted on the five functional traits and the species scores obtained on the 2 first PCA axes.

### Taxonomic and functional variation among communities

To investigate taxonomic and functional variation among communities we calculated $I_{st}$, for taxonomic composition and $U_{st}$ and $\tau _{st}$, for functional composition in abundance and presence-absence respectively [@hardy_characterizing_2007]. $I_{st}$ measures species turnover accounting for local abundance. $U_{st}$ integrate only functional turnover, weighting species by their local abundances; whereas $\tau _{st}$ express functional turnover, without accounting for species local abundances.

Variation in composition between community pairs with those metrics was translated as a taxonomic, functional and phylogenetic distance, and compared to the corresponding environmental and spatial distances. Environmental distances were calculated as euclidean distances between communities on the plan composed by the two first axes of environmental variables PCA (see supplementary material S1). Correlations with environment and space were assessed with two Mantel tests successively with taxonomic and functional, community composition. The firt Mantel test consisted in assessing the correlation between each metric distance matrix and the environmental distance matrix (E) and the second test, a partial Mantel test, assessed the correlation between each metric distance matrix and the spatial distance matrix knowing environmental distance matrix (E|S). This second test thus test the remaining spatial dependency in community composition once the influence of environmental variation is removed.

We used null models to test if the observed correlations differed significantly from expectations under null hypothesis. $I_{st}$ correlations with environment and space were tested with 999 repetions of the nul model described by @myers_beta-diversity_2013 which randomizes individuals among quadrat while preserving the regional abundance of species, and the number of individuals per community. $U st$ and $\tau st$ were tested by the nul model NM1 which randomizes traits among species.

All analyses were conducted using the R 3.3.0  software environment [@r_core_team_r:_2016] with packages 
`ade4` [@dray_ade4_2007], 
`ape` [@paradis_ape:_2004], 
`phylosignal` [@keck_phylosignal:_2015], 
`spacodiR` [@eastman_spacodir:_2013],
and `vegan` [@oksanen_vegan:_2016].

# Results

## Traits variation and covariation

We found a general increase of functional trait variation from intra-individual to inter-specific level (see table 2). Whereas LA shows already high variabililty at intra-individual level almost as strong as the intra-specific variation ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). Finally the relatively low intra-individual variation ($cv_{intra}$ range from 0.06 to 0.09) allow us to consider the mean trait values per species for subsequent connumity-level analysis.

Table 2: Coefficient of variation of intra-individual, intra-specific and inter-specific trait values. *Traits with their range of values, mean and standard deviation, mean of coefficient of variation for leaves in all individuals (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.*

```{r 2 CV}
# Individual aggregation
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$Sp
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$SpCode
names(SpCode) <- SpCodeT$Sp
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$Sp <- Sp[row.names(PFT_ind)]
PFT_ind$SpCode <- SpCode[as.character(PFT_ind$Sp)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
# Species aggregation
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
# Coefficient of variation
trait <- c('LT', 'LA', 'LDMC', 'SLA', 'WD')
cv <- data.frame(
  row.names = trait,
  Range = c(paste(range(PFT$LT, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  m = c(paste0(round(mean(PFT$LT, na.rm = T)), ' (',
               round(sd(PFT$LT, na.rm = T)), ')'),
        paste0(round(mean(PFT$LA, na.rm = T)), ' (',
               round(sd(PFT$LA, na.rm = T)), ')'),
        paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
               round(sd(PFT$LDMC, na.rm = T)), ')'),
        paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
               round(sd(PFT$SLA, na.rm = T),2), ')'),
        paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
               round(sd(PFT$WD, na.rm = T),2), ')')),
  m1 = round(unlist(lapply(as.list(trait), function(y){
    mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){
      sd(x, na.rm = T) / mean(x, na.rm = T)
    })[,2], na.rm = T)
  })) ,2),
  m2 = round(unlist(lapply(as.list(trait), function(y){
    mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$Sp), function(x){
      sd(x, na.rm = T) / mean(x, na.rm = T)
    })[,2], na.rm = T)
  })), 2),
  m3 = round(unlist(
    lapply(as.list(trait), function(y){
      sd(PFT_sp[,which(names(PFT_sp) ==  y)], na.rm = T) / mean(PFT_sp[,which(names(PFT_sp) ==  y)], na.rm = T)
    })), 2)
)
names(cv)[2:5] <- c('Mean (sd)' , 'Intra-individual', 'Intra-species', 'Inter-species')
cv['WD','Intra-individual'] <- ''
kable(cv)
rm(PFT, CET, cv, CE, Sp, SpT, SpCodeT)
```

The principal component analysis (PCA) revealed a first axis along which both wood density and structural leaf traits (LT, LDMC) correlate, thus opposing species with thick, big leaves and lightwood to species with dense leaves and hardwood. Interestingly, wood density was orthogonal to SLA in the plan 1-2 of the PCA indicating independence between these two variables. The second axis of the PCA2 covaried mainly positively with SLA and negatively with LDMC. PCA also highlight the strong correlation between LDMC and WD (Pearson's correlation test, $r = 0.25$ with $p-value < 0.001$).

```{r 3 PCA PFT}
library(vegan)

# Indovidual to log
PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
# Species aggregation
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
# PCA
pca <- princomp(~ LA + WD + LT + LDMC + SLA, data = PFT_sp, cor = T)
lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
      xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
# legend('topright', c('Leaf economics spectrum', 'Wood economics spectrum'),
       # text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

# LES and WES
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
rm(PCAscores, PFT_ind, SpCodeT, lambda, pca, pca.var, Rot, XLIM)
```

Figure 1: Principal Component Analysis (PCA) performed on species mean trait values. *The bottom right subplot represents the eigen values (grey bars) compare to a broken stick distribution for five components (red line). See table 1 for abbreviation.*

```{r 4 env-com}
library(raster)

# Building community and environmental datasets
Env <- genEnv()
Trees <- genTrees()
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats(cs = c(30,30))
XY <- Trees[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'))
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
BA <- aggregate(Trees$Girth, list(Trees$com), function(x){sum(pi*(x/(2*pi))^2, na.rm = T)})
com@data$BA <- BA$x[match(com@data$id, BA$Group.1)]
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SW, data = com@data, cor = T)

# Building RLQ matrices
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')]
row.names(Q) <- PFT_sp$SpCode
sel <- which(Species$Strata[match(PFT_sp$SpCode, Species$SpCode)] == 3)
Q <- list(C = Q[-sel,], U = Q[sel,])
sel <- lapply(Q, function(q){intersect(row.names(q), names(L))})
Q <- mapply(function(q,s){q[s,]}, q = Q, s = sel, SIMPLIFY = F)
L <- lapply(sel, function(s){L[s]})
R <- lapply(L, function(l){R[row.names(l),]})
L <- lapply(L, function(l){list(abundance = l, `presence-absence` = l)})
L <- lapply(L, function(l){l$`presence-absence`[l$`presence-absence` > 1]  <- 1 ; return(l)})

rm(Deriv, XY, Env, sel, BA, s)
```

## Functional composition of local communities

Community weighted means (CWM), both in abundance or presence-absence, showed some significant variations along environmental gradients (see table 3). Community mean values of WD significantly increased under south-west direction, both in abundance and presence-absence CWM,  whereas SLA and LA, in presence-absence only, decreased with curvature. In addition, LDMC in presence-absence was decreasing with canopy height. Trait values that allow species existence is not always the same that trait values determining their ability to dominate a given environment. For instance here both abundant and less abundant species increased their WD under southwest orientation, whereas SLA and LA decrease with curvature is only affecting less abundant species ability to survive in concave environments.

Table 3: Summary of linear models of traits standardized effect size (SES) of CWMs. _Linear regression results for each trait SES of CWMs, for canopy (C) and understorey (U) guilds, in abundance (AB) and presence-absence (PA), after stepwise selection of the predictors including slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. Bold and number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWM}
# Observed CWMs
CWM <- mapply(function(Ls,Qs){
  lapply(Ls, function(l){
    lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
      apply(l, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)
CWM <- lapply(CWM, function(s){
  lapply(s, function(x){
    names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(x)
  })
})

# Simulated CWMs
n = 999
nQ <- lapply(Q, function(s){
  rep(list(s), n)
})
nQ <- lapply(nQ, function(s){ 
  lapply(s, function(nq){
      row.names(nq) <- sample(row.names(nq))
      return(nq)
  })
})
nQ <- mapply(function(nQs, Ls){
  lapply(nQs, function(nq){
    nq[names(Ls$abundance),]
  })
}, nQs = nQ, Ls = L, SIMPLIFY = F)
cl <- makeCluster(cores)
clusterExport(cl, list('L', 'nQ'))
nCWM <- clusterMap(cl, function(nQs, Ls){
  lapply(nQs, function(nq){
    lapply(Ls, function(l){
      lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
        apply(l, 1, function(x){
          weighted.mean(nq[,v], x, na.rm=T)
        })
      })
    })
  })
}, Ls = L, nQs = nQ)
stopCluster(cl)
rm(cl)
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ns){
  lapply(ns,function(ab){
    names(ab) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(ab)
    })
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, `[`, names(ab[[1]]))
    apply(do.call(rbind, ab), 2, as.list)
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      do.call('cbind', x)
    })
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, data.frame)
  })
})

## CWM SES
CWM.ses <- mapply(function(CWMs, nCWMs){
  mapply(function(CWMab, nCWMab){
    data.frame(
      mapply(function(x,y){
        mapply(function(p,q){
          (p - mean(q))/sd(q)
        }, p = as.list(x), q = as.list(data.frame(t(y))))
      }, x = CWMab, y = nCWMab)
    )
  }, CWMab = CWMs, nCWMab = nCWMs, SIMPLIFY = F)
}, CWMs = CWM, nCWMs = nCWM, SIMPLIFY = F)
CWM.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(ab){
    apply(ab, 2, function(y){
      step(lm(y ~., Rs), direction = 'both', trace = 0)
    })
  })
}, s = CWM.ses, Rs = R, SIMPLIFY = F)
CWM.ses.res <- lapply(CWM.ses.lm, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      summary(x)$coefficients
    })
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    lapply(ab, data.frame)
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
      return(x)
    })
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    data.frame(data.table::rbindlist(lapply(ab, function(x){
      data.frame(t(x[5]))
    }), fill = T))
  })
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
  ab[,setdiff(var, names(ab))] <- NA
  ab <- ab[var]
  ab <- apply(ab, 2, as.character)
  row.names(ab) <- names(CWM.ses$C$abundance)
  ab[is.na(ab)] <- ''
  ab <- data.frame(ab)
  return(ab)
  })
})
CWM.ses.res <- mapply(function(s, CWM.ses.lms){
  mapply(function(ab, CWM.ses.lmab){
    ab$`$R^2$` <- round(unlist(lapply(CWM.ses.lmab, function(x){
      summary(x)$r.squared
    })),3)
    return(ab)
  }, ab = s, CWM.ses.lmab = CWM.ses.lms, SIMPLIFY = F)
}, s = CWM.ses.res, CWM.ses.lms = CWM.ses.lm, SIMPLIFY = F)
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    ab <- cbind(row.names(ab), ab)
    names(ab)[1] <- 'Trait'
    return(ab)
  })
})
# CWM.ses.res <- lapply(CWM.ses.res, function(s){
#   lapply(s, function(ab){
#     sel <- which(unlist(lapply(as.list(data.frame(t(ab))), function(t){
#   any(grepl('*', t, fixed = T))
# })))
#   return(ab[sel,])
#   })
# })
CWM.ses.res <- mapply(function(s, name){
  lapply(s, function(ab){
      ab <- cbind(c(name, rep(' ', length(ab[,1])-1)), ab)
      names(ab)[1] <- 'T'
      return(ab)
  })
}, s = CWM.ses.res, name = as.list(c('AB', 'PA')), SIMPLIFY = F)
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  do.call('rbind', s)
})
CWM.ses.res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'S'
  return(s)
}, s = CWM.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CWM.ses.res <- do.call('rbind', CWM.ses.res)
kable(bold(CWM.ses.res), row.names = F)
rm(nCWM, CWM.ses, CWM.ses.lm, CWM.ses.res)
invisible(gc())
```

Traits convergence/divergence was measured with community weighted variances (CWV). We could found significant relationships between standardized effect size (SES) of CWVs and environmental variables (see table 4). Convergence of WES and LDMC in the canopy guild  and convergence of LA in the undersotrey guild were found under concave areas. LDMC of the canopy guild converged also with canopy height. LES of understorey guild converged in slopes and SLA of understorey guild diverged with increasing BA. We also found significant relationships of their standardized effect size (SES) of CVNNDs with environmental variables (see table 4). Niche differentiation of WES and LDMC in canopy guild increased in lower basal area context. Differentiation of canopy guild LA increased in convex and high canopy contexts, whereas LT of the canopy guild differentiated in concave context. Niche differentiation of LES in understorey guild increased in concave areas, while differentiation of LT of the understorey guild increased in wet context with a high basal area.

Table 4: Summary of linear models of traits standardized effect size (SES) of CWVs and CVNNDs. _Linear regression results for each trait SES of CWVs and CVNNDs, for canopy (C) and understorey (U) guilds, after stepwise selection of the predictors including slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. Bold and  number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWV}
# Removing communities with only one species
for(s in names(L)){
  sel <- which(rowSums(L[[s]]$`presence-absence`) < 2)
  if(length(sel) > 1){
    L[[s]] <- lapply(L[[s]], function(ab){
      return(ab <- ab[-sel,])
    })
    R[[s]] <- R[[s]][-sel,]
  }
}

# Observed CWVs
CWV <- mapply(function(Qs, CWMs, Ls){
  lapply(names(CWMs$abundance), function(v){
    apply(cbind(data.frame(CWMs$abundance[[which(names(CWMs$abundance) == v)]]),Ls$abundance), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, Qs = Q, CWMs = CWM, Ls = L, SIMPLIFY = F)
CWV <- lapply(CWV, function(s){
  names(s) <- names(CWM$C$abundance)
  return(s)
})

# Simulated CWVs 
nL <- list(C = rep(list(L$C$abundance), n),
           U = rep(list(L$U$abundance), n))
nL <- lapply(nL, function(s){
  lapply(s,function(l){
    apply(l, 1, function(x){
      x[x != 0] <- sample(x[x != 0])
      return(x)
    })
  }) 
})
nL <- lapply(nL, function(s){
  lapply(s, function(x){
    t(x)
  })
})
nL <- lapply(nL, function(s){
  lapply(s, data.frame)
})
cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'CWM', 'Q'))
nCWM.cwv <- clusterMap(cl, function(nLs, CWMs, Qs){
  lapply(nLs, function(nl){
    lapply(as.list(names(CWMs$abundance)), function(v){
      apply(nl, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, nLs = nL, CWMs = CWM, Qs = Q, SIMPLIFY = F)
stopCluster(cl)
nCWM.cwv <- lapply(nCWM.cwv, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
nCWV <- mapply(function(nLs, nCWM.cwvs, Qs){
  mapply(function(l,cwm){
  lapply(names(CWM$C$abundance), function(v){
    apply(cbind(data.frame(cwm[[which(names(cwm) == v)]]),l), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, l = nLs, cwm = nCWM.cwvs, SIMPLIFY = F)
}, nLs = nL, nCWM.cwvs = nCWM.cwv, Qs = Q, SIMPLIFY = F)
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
rm(nCWM.cwv, cl, nL)
invisible(gc())
nCWV <- lapply(nCWV, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
      do.call('cbind', x)
  })
})
nCWV <- lapply(nCWV, function(s){
    lapply(s, data.frame)
})
## CWV SES
CWV.ses <- mapply(function(CWVs, nCWVs){data.frame(
  mapply(function(x,y){
    mapply(function(p,q){
      (p - mean(q))/sd(q)
    }, p = as.list(x), q = as.list(data.frame(t(y))))
  }, x = CWVs, y = nCWVs)
)}, CWVs = CWV, nCWVs = nCWV, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    lm(y ~., Rs)
  })
}, s = CWV.ses, Rs = R, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(x){
    step(x, direction = 'both', trace = 0)
  })
}, s= CWV.ses.lm, Rs = R, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, data.frame)
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CWV.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CWV.ses.res <- mapply(function(s, CWV.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CWV.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CWV.ses.res, CWV.ses.lms = CWV.ses.lm, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
# CWV.ses.res <- lapply(CWV.ses.res, function(s){
#   sel <- which(unlist(lapply(as.list(data.frame(t(s))), function(t){
#   any(grepl('*', t, fixed = T))
# })))
#   return(s[sel,])
# })
CWV.ses.res <- mapply(function(s, name){
  if(dim(s)[1] > 0){
    s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
    names(s)[1] <- 'Strata'
    return(s) 
  }
}, s = CWV.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CWV.ses.res <- do.call('rbind', CWV.ses.res)
rm(CWV.pval.res, CWV.ses.lm, nCWV)
```

```{r CVNND}
# Removing communities with only two species
for(s in names(L)){
  sel <- which(rowSums(L[[s]]$`presence-absence`) < 3)
  if(length(sel) > 1){
    L[[s]] <- lapply(L[[s]], function(ab){
      return(ab <- ab[-sel,])
    })
    R[[s]] <- R[[s]][-sel,]
  }
}

# Observed CVNND
CVNND <- mapply(function(Ls, Qs){
  apply(Ls$abundance, 1, function(l){
  apply(Qs, 2, function(q){
    cati::CVNND(rep(q, l), na.rm = T)
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)
## NaN CVNND$U
sel <- which(is.na(CVNND$U[1,]))
CVNND$U <- CVNND$U[,-sel]
R$U <- R$U[-sel,]

# Simulated CVNNDs 
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L'))
nCVNND <- clusterMap(cl, function(nQs, Ls){ 
  lapply(nQs, function(x){
    apply(Ls$abundance, 1, function(l){
      apply(x, 2, function(q){
        cati::CVNND(rep(q,l), na.rm = T)
      })
    })
  })
}, nQs = nQ, Ls = L)
stopCluster(cl)
rm(cl, nQ)
invisible(gc)
## NaN CVNND$U
nCVNND$U <- lapply(nCVNND$U, function(x){
  x <- x[,-sel]
})

nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(x){
    x <- as.list(data.frame(t(x)))
  })
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(t){
      t <- data.frame(lapply(t, cbind))
  })
})


## CVNND SES
CVNND.ses <- mapply(function(CVNNDs, nCVNNDs){
  data.frame(
    mapply(function(x,y){
      mapply(function(p,q){
        (p - mean(q))/sd(q)
      }, p = as.list(x), q = as.list(data.frame(t(y))))
    }, x = as.list(data.frame(t(CVNNDs))), y = nCVNNDs)
  )
}, CVNNDs = CVNND, nCVNNDs = nCVNND, SIMPLIFY = F)
CVNND.ses <- lapply(CVNND.ses, function(s){
  row.names(s) <- colnames(CVNND)
  return(s)
})
CVNND.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    step(lm(y ~., Rs), direction = 'both', trace = 0)
  })
}, s = CVNND.ses, Rs = R, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, data.frame)
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CVNND.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CVNND.ses.res <- mapply(function(s, CVNND.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CVNND.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CVNND.ses.res, CVNND.ses.lms = CVNND.ses.lm, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
# CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
#   sel <- which(unlist(lapply(as.list(data.frame(t(s))), function(t){
#   any(grepl('*', t, fixed = T))
# })))
#   return(s[sel,])
# })
CVNND.ses.res <- mapply(function(s, name){
  if(dim(s)[1] > 0){
    s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
    names(s)[1] <- 'Strata'
    return(s)
  }
}, s = CVNND.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CVNND.ses.res <- do.call('rbind', CVNND.ses.res)
rm(CVNND.pval, CVNND.ses.lm, nCVNND)
invisible(gc())
```

```{r CWV & CVNND table}
res <- list(CWV = CWV.ses.res, CVNND = CVNND.ses.res)
res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1:2] <- c('T', 'S')
  return(s)
}, s = res, name = as.list(c('CWV', 'CVNND')), SIMPLIFY = F)
res <- do.call('rbind', res)
kable(bold(res), row.names = F)
rm(CWV.ses.res, CVNND.ses.res, CVNND.pval.res, sel, res)
```

## Taxonomic and functional varitions among communities

Taxonomic variation among communities was correlated significantly with environmental variation for both canopy and understorey guilds (Mantel test for canopy and understorey guild, $r_{I_{st},E,C} = 0.22$ and $r_{I_{st},E,U} = 0.23$, respectively, with $p-value < 0.01$), but not with remaining spatial dependency in community composition for canopy guild (Mantel test of space knowing environment, $r_{I_{st},S|E,C} = 0.01$ with $p-value > 0.1$), whereas understorey guild taaxonomic variation was correlated to remaining spatial dependency in community composition (Mantel test of space knowing environment, $r_{I_{st},S|E,U} = 0.11$ with $p-value < 0.01$).

```{r Ist, include=FALSE}
library(spacodiR)

# Environmental matrices
XY <- data.frame(as(quadrats(c(30,30)), 'SpatialPoints')@coords)
row.names(XY) <- paste0('C',row.names(XY))
XY <- lapply(L, function(s){
  XY[row.names(s$abundance),]
})
Ms <- lapply(XY, function(s){
  dist(s)
})
XY <- pca.env$scores[,1:2]
row.names(XY) <- paste0('C',row.names(XY))
XY <- lapply(L, function(s){
  XY[row.names(s$abundance),]
})
Me <- lapply(XY, function(s){
  dist(s)
})
rm(XY)

# Observed Ist
spaflo <- lapply(L, function(s){
  spacodi.calc(sp.plot = t(s$abundance), pairwise = T)$'pairwise.Ist'
})
## Mantel values
spaflo.mantel <- mapply(function(s, Mes, Mss){
  list(
    `E` = vegan::mantel(s, Mes, permutations = 0)$statistic, 
    `S | E`= vegan::mantel.partial(s, Mss, Mes, permutations = 0)$statistic
  )
}, s = spaflo, Mes = Me, Mss = Ms, SIMPLIFY = F)

# Simulated mantel
nL <- lapply(L, function(s){
  vegan::permatfull(s$abundance, fixedmar = 'both', mtype = 'count', times = n, shuffle = 'both')
})
nspaflo <- lapply(nL, function(s){
  lapply(s$perm, function(l){
    spacodi.calc(sp.plot = t(l), pairwise = T)$'pairwise.Ist'
  })
})
nspaflo.mantel <- mapply(function(s, Mes, Mss){
  lapply(s, function(x){
    try(list(
      `E` = vegan::mantel(x, Mes, permutations = 0)$statistic, 
      `S | E`= vegan::mantel.partial(x, Mss, Mes, permutations = 0)$statistic
    ))
  })
}, s = nspaflo, Mes = Me, Mss = Ms, SIMPLIFY = F)
sel <- which(unlist(lapply(nspaflo.mantel$U, inherits, 'try-error')))
nspaflo.mantel$U <- nspaflo.mantel$U[-sel]
## Non null mantels
nspaflo.mantel <- lapply(nspaflo.mantel, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nspaflo.mantel <- lapply(nspaflo.mantel, function(s){
  lapply(s, unlist)
})
spaflo.res <- mapply(function(s, ns){
  mapply(function(x, nx){
    paste(format(x, scientific = T, digits = 3),
          Uppangala::stars(min(1-rank(c(x,nx))[1]/(n+1),rank(c(x,nx))[1]/(n+1)), ns = '   '))
  }, x =s, nx = ns)
}, s = spaflo.mantel, ns = nspaflo.mantel)

# Result
kable(bold(spaflo.res))
rm(spaflo.mantel, nspaflo, nspaflo.mantel, spaflo.res)
```

Most of trait functional variation among communities was neither correlated to environment nor to spactial distance knowing the environment effect (see table 5). However, the variation of WD, in abundance as well as in presence absence, was positively correlated to environmental variation and is negatively correlated in presence absence to the spatial structure knowing environment spatial effect. 

Table 5: Summary of Mantel tests between functional composition, environment and spatial distances between communities. _$U st$ and $\tau st$ metric proposed by @hardy_characterizing_2007 were used to measure functional composition variation among communities, for canopy (C) and understorey (U) guilds. Observed values were compared to null values obtained with model NM1 randomizing traits among species (permuting raw in `Trait*Species` matrix). E is the Mantel test of this metric according to the environmental distance derived from communtiy scores in the environmental PCA (two first axes). S|E is the partial Mantel test of this metric according to spatial distance conditionally to environment variation. The number of asterisk indicates significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Ust & TAUst}
# Observed Hardys
spafun <- mapply(function(s, Ls){
  lapply(as.list(1:length(s)), function(i){
    if (length(which(is.na(s[i]))) > 0) {
      sel <- intersect(names(Ls$abundance), row.names(s[-which(is.na(s[i])),]))
      return(spacodi.calc(sp.plot = t(Ls$abundance[sel]), sp.traits = data.frame(s[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    } else {
      return(spacodi.calc(sp.plot = t(Ls$abundance), sp.traits = s, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    }
  })
}, s = Q, Ls = L, SIMPLIFY = F)
spafun <- lapply(spafun, function(s){
  names(s) <- names(Q$C)
  return(s)
})
## Mantel values
spafun.mantel <- mapply(function(s, Mes, Mss){
  lapply(s, function(t){
    list(
      `E` = lapply(t, function(M){
        vegan::mantel(M, Mes, permutations = 0)$statistic
      }), 
      `S | E` = lapply(t, function(M){
        vegan::mantel.partial(M, Mss, Mes, permutations = 0)$statistic
      })
    )
  })
}, s = spafun, Mes = Me, Mss = Ms, SIMPLIFY = F)

# Simulated mantel
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L', 'Me', 'Ms', 'spacodi.calc'))
nspafun.mantel <- clusterMap(cl, function(nQs, Ls, Mes, Mss){ 
  lapply(nQs, function(q){
    s <- lapply(as.list(1:length(q)), function(i){
      if (length(which(is.na(q[i]))) > 0) {
        sel <- intersect(names(Ls$abundance), row.names(q[-which(is.na(q[i])),]))
        return(spacodi.calc(sp.plot = t(Ls$abundance[sel]), sp.traits = data.frame(q[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
      } else {
        return(spacodi.calc(sp.plot = t(Ls$abundance), sp.traits = q, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
      }
    })
    names(s) <- names(q)
    res <- list(
      `E` = lapply(s, function(t){
        lapply(t, function(M){
          try(vegan::mantel(M, Mes, permutations = 0)$statistic)
        })
      }),
      `S | E` = lapply(s, function(t){
        lapply(t, function(M){
          try(vegan::mantel.partial(M, Mss, Mes, permutations = 0)$statistic)
        })
      })
    )
    res <- lapply(res, function(r){names(r) <- names(q) ; return(r)})
    res <- lapply(res, `[`, names(res[[1]]))
    res <- apply(do.call(rbind, res), 2, as.list)
    return(res)
  })
}, nQs = nQ, Ls = L, Mes = Me, Mss = Ms, SIMPLIFY = F)
stopCluster(cl)
rm(cl, nQ) ; invisible(gc())

## Non null mantels
nspafun.mantel <- lapply(nspafun.mantel, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nspafun.mantel <- lapply(nspafun.mantel, function(s){
  lapply(s, function(m){
    lapply(m, `[`, names(m[[1]]))
    apply(do.call(rbind, m), 2, as.list)
  })
})
nspafun.mantel <- lapply(nspafun.mantel, function(s){
  lapply(s, function(m){
    lapply(m, function(u){
      lapply(u, `[`, names(u[[1]]))
      apply(do.call(rbind, u), 2, as.list)
    })
  })
})
nspafun.mantel <- lapply(nspafun.mantel, function(s){
  lapply(s, function(m){
    lapply(m, function(u){
      lapply(u, unlist)
    })
  })
})

spafun.res <- mapply(function(s, ns){
  mapply(function(t, nt){
    mapply(function(m, nm){
      mapply(function(u, nu){
        paste(round(u, 3), Uppangala::stars(min(rank(c(u,nu))[1]/(n+1), 1-rank(c(u,nu))[1]/(n+1)), ns = '   '))
      }, u = m, nu = nm)
    }, m = t, nm = nt)
  }, t = s, nt = ns, SIMPLIFY = F)
}, s = spafun.mantel, ns = nspafun.mantel, SIMPLIFY = F)
trait <- names(spafun.res$C)
spafun.res <- lapply(spafun.res, function(s){
  mapply(function(t, tr){
    t <- data.frame(t)
    t <- cbind(c(tr, ' '), c('$U_{st}$', '$\\tau _{st}$'),  t)
    names(t) <- c('T', 'M', 'E', 'S|E')
    return(t)
  }, t = s, tr = trait, SIMPLIFY = F)
})
spafun.res <-lapply(spafun.res, function(s){
  s <- do.call('rbind', s)
})
spafun.res <- mapply(function(s, str){
  s <- cbind(c(str, rep(' ', dim(s)[1]-1)), s)
  names(s)[1] <- 'S'
  return(s)
}, s = spafun.res, str = c('C', 'U'), SIMPLIFY = F)
spafun.res <- do.call('rbind', spafun.res)

# Result
kable(bold(spafun.res), row.names = F)
rm(spafun.mantel, nspafun.mantel, spafun.res)
```

# Discussion

## Ecological strategies

We found increasing trait variation within individuals, between individuals within species, and between speces (table 2). It entailed that the primary source of trait variation within and among communities should be among species. The PCA of functional trait variation among species displayed two main dimensions (figure 1), which may be interpreted as independent wood and leaf economics spectra. We found opposing SLA to LDMC values along the leaf economics spectrum, which expressed a trade-off between productivity, with less carbon investment for higher photosynthesis rates, and persistence, with more leaf defense and investment [@wright_worldwide_2004]. A second major axis of trait variation opposed wood density to leaf area and thickness. It may thus be interpreted as an axis opposing stress tolerant species, with denser wood, to competitive species, with thicker and larger leaves, which confer a higher efficiency in water conductivity. It may thus be interpreted as the wood economics spectrum firstly introduced by @chave_towards_2009, and then discussed by @baraloto_decoupled_2010. Interestingly, @baraloto_decoupled_2010 found an independence between the leaf and wood economics spectra and their wood economics spectrum also showed an opposition between hardwood species having small thin leaves and light wood species having large thick leaves.

Furthermore, our results are similar to the ones found by @fortunel_leaf_2012, where basic PCA axes also represented leaf and wood economics spectra (inverted compare to us). Noticeably though, our analysis integrated less traits (5 against 14), less species (89 against 758), and considered a regional set of species found in a local forest-plot scale while @fortunel_leaf_2012 considered a regional set of species. Therefore, we could capture basic economics spectra found at regional scale in Neotropics at a far more local scale in an Indian rainforest, even though such downscaling does not hold in any case [@messier_trait_2016]. It suggests that these spectra indeed represent major drivers of ecological strategies in local forest dynamics in our context.

## Community-level trait values

We analyzed functional composition of $20*20m^2$ communities (CWM), as well as the variation of this composition with environment across the 10 ha forest plot. We found that the traits of the leaf economics spectrum (LES) were mainly affected by aspect with more convergent community composition (lower CWV) under south-west orientation, especially for LDMC of less common species. The influence of aspect is little documented in tropical forests, but still highlighted by @gunatilleke_specieshabitat_2006 in monsoon rainforests. @bunyan_effect_2015 also observed similar influence in mountain rainforests of Western Ghats, and suggested that it could result from monsoon winds. In our context, monsoon winds arise from south-west direction, and could bring more stressful and disturbed conditions to species [@soman_aspects_1990]. Uppangala plot is situated inside a low elevation slope separated from west coast by a higher crest orientated toward southwest. In this context it is diffcult to predict wind flow and orientation inside the 10 ha plot topgraphy. We hyptohesis to explanation, hardwood could be selected for mechanical resistance in more disturbed souwhtwest oriented area or topography provoke a turbulences on northeast oriented areas responsible of more disturbance and death events in the forest history resulting in lightwood filtering [@larjavaara_rethinking_2010]. Curvature is also affecting the variation of leaf economics in community. A locally convex context would accumulate more soil and attract more water, increasing soil fertility and allowing persistence of species investing more in leaf resource acquisition, with higher SLA and a convergence in LDMC values. The variation of SLA and LDMC with curvature, is consistent with the influence of changing soil fertility [@hodgson_is_2011].

Biotic factors also affected the LES through a negative effect of canopy height on LDMC. There was no effect of canopy height on understorey species, while it influenced leaf traits of canopy and emergent trees. A basic expectation is that understorey species would invest in higher LDMC for higher leaf lifespan and durability under limited light and water resources [@kitajima_tissue-level_2010]. But the Uppangala forest is characterized by heterogeneity of canopy height allowing light to penetrate more in lower strata and a dry season of 3.8 months. Comsequently leaf lifespan investment may not be so important resulting in a low-high light growth trade-off strategy instead of a growth-survival trade-off [@poorter_leaf_2009], affecting SLA but not LDMC. Emergent and high canopy species will have a lower LDMC, resulting from a more productive strategy toward leaf resource acquisition at the expense of leaf carbon investment in defense and resistance. **Second hyptohesis: canopy and emergent tree are more affected by water stress than understorey species preserved by microclimatic conditions buffered by canopy**. Thus canopy species with the lowest LDMC will grow more quickly and then reach the highest canopy. Measurement of LDMC on species classified as canopy and emergent were realized most of the time on shadow leaves from understorey individuals. Still we observed previous relationship indicating that species phylogenetic determinism is stronger than micro-environmental variation plasticity for LDMC, as suggested by the intra-specific variation of LDMC 1.5 times larger than intra-individuals variation.

The wood economics spectrum defined by WD, LA, and LT was mainly affected at community level by south-west orientation and curvature. South-west orientation, with probably more disturbance and stress due to exposure to monsoon winds **Maxime: counter effect by topo ?**, resulted in denser wood. However lower evenness than random could be related to multimodality. In addition, south-west orientation also related to a broader range of leaf sizes, which could be consistent with more diverse hydraulic strategies reflected by WD multimodality, as WD and LA are mechanically linked [@coomes_scaling_2008]. Decreasing fertility , with concavity was related to smaller leaves inside communities with a distribution broaden by multimodality reducing evenness **to develop, eventually illustrated with one example**. Wetness increased with higher curvature and lower LA evenness, indicating that multimodality is happening more in wettest low elevation area. Wetness could compensate water departure trigerred by positive curvature in lower elevation areas. **Repetition with first paragraph, to merge ?**.

## Variations among communities

Taxonomic variation in community composition was only dependent on environmental distance. Because we did not find any residual pattern of increasing taxonomic dissimilarity with spatial distance, it could indicate that environmental heterogeneity was a primary driver of species distributions, and that dispersal limitation did not influence these distributions at the scale of our forest plot. Conversely, functional variation did not depend on environmental distance or on spatial distance **Paradoxal ? Is it due to environmental aggregation in one variable or to a power loss of the test ?**. At the 10 ha level functional variation between communities is stochastic; whereas at the community level environment is partially shapping florisitic composition. Measured functional traits should vary to a larger scale [@messier_trait_2016]. Still environment is shaping community resistance to disturbance and stress by affecting wood density $\beta$ structure at fine scale. WD of less abundant species is even diverging with spatial residuals supposing an unaccounted spatially organized variable opposing close community in WD composition. Topography removed from spatial residuals, and climate and pedology being constant in the 10 ha plot, this unaccounted variation is assumed to be due to stochastic event in plot history as death. Unshown analysis reveals that this spatial divergence of WD is not explained by tree death events from the two last decades but certainly to older events. **To redraft**. Finally, variation in distance between taxon was not translated in phylogenetic variation whereas most of measured functional traits appeared phylogenetically conserved and clustered. **To discuss**.

## Limits and perspectives

Ecological strategies underline two econmic spectra as shown by @baraloto_decoupled_2010. Whereas the multivariate analysis of our functional traits lack trait diversity for correct interpretations of functional trade-offs. Measured traits were all morphological and from the leaf except for one. Anatomical and chemical traits as leaf vein patterns and leaf chemical content (N, P, K) could brought broader perspective on ecological strategies of Western Ghats species. Still the study reveal that few commonly used traits can highlight well known strategy axes. **Develop what would have brought this other traits**.

Besides patterns have been detected between functional composition and environment at both local ($\alpha$) and between-community ($\beta$) scales. Lot of relation observed didn't differ from those obtain with null hypothesis reflecting neutral theory [as functional equivalence, @hubbell_neutral_2005]. Ecological gradient and spatial scale sizes can be at the origin of this lack of environmental filtering. Effectively the abiotic variation is mainly topographic with a constant climate and pedology. Study highlighting environmental filtering often present a higher environmental variation [@bernard-verdier_community_2012]. In parallel, the 10 ha plot scale is really low and partially responsible for the small environmental variation. @kraft_functional_2008 detected topographical filtering on functional trait and @gunatilleke_specieshabitat_2006 observed niche differentiation on 25 ha tropical forest plots including large flat valleys. This mid-low elevation study of functional traits from Western Ghats forest could be reproduced at higher elevation or in dryer areas as Eastern Ghats for better insight of environmental filtering at broad scale. On the other hand, WD as shown to be filtered by environment at fine scale both in $\alpha$ and $\beta$ levels. Species wood seems highly adpted to environment in Western Gahts forests in link to monsoon events **To brought sooner, break conclusion**.

# *Acknowledgement*

French Institute of Pondicherry (FIP)

# Supplementary materials

## S1: Principal component analysis of topographical variables

```{r PCA Env}
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Supplementary material S1: Principal component analysis (PCA) performed on topgraphical variables. *Botom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 7 components (red line). SW stand for southwesterness.*

Curvature covaries with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Elevation and wetness are opposed in the principal component analysis and slope and south-westerness does not seem to covary much with other variables **Not precise**.

## S2: Phylogenetic varitions among communities

A phylogenetic tree of the 89 species was built with the R `S.PhyloMaker` function proposed by @qian_updated_2016-1. We assessed the phylogenetic signal of each functional trait using the Moran's I statistic. Positive Moran's I value indicated convergence of trait values within the phylogeny (i.e. trait conversatism) whereas negative Moran's I will showed divergence (i.e. trait differentiation).

To investigate phylogenetic variation among communities we calculated $\beta _{st}$ and $\pi _{st}$, for phylogenetic composition in abundance and presence-absence respectively [@hardy_characterizing_2007]. $\beta _{st}$ integrate only phylogenetic turnover, weighting species by their local abundances; whereas $\pi _{st}$ express phylogenetic turnover, without accounting for species local abundances.

Variation of composition between community pairs with those metrics was translated as a taxonomic, functional and phylogenetic distance, and compared to environmental and spatial distances among community pairs. Environmental distances were calculated as geometric distances between communities on the plan composed by the two first axes of environmental variables PCA (see supplementary material S1). Correlations with environment and space were assessed based on two Mantel tests successively with taxonomic, functional, and phylogenetic community compositions. A firt Mantel statistic assessed the correlation between each metric distance matrix and the environmental distance matrix (E). The second partial Mantel statistic assessed the correlation between each metric distance matrix and the spatial distance matrix knowing environmental distance matrix (E|S), to represent remaining spatial dependency in community composition once the influence of environmental variation is taken into account.

We used null models to test if observed correlation with Mantel statistic differed significantly from expectations under null hypothesis. $\beta st$ and $\pi st$ were tested against the nul model *"1s"* suggested by @hardy_testing_2008 which randomizes phylogenetic tree tips.

```{r PhyloMaker, include=FALSE}
library(phylosignal)
library(phytools)
library(phylobase)
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
sp <- Species[which(Species$LatinName %in% row.names(PFT_sp)), c('LatinName', 'Genus', 'Family')]
names(sp) <- c('species', 'genus', 'family')
results <- invisible(S.PhyloMaker(sp, phylo, nodes)) # Humboldtia_brunonis unmatched
tree <- results$Scenario.1
rm(phylo, results, modes, sp, S.PhyloMaker, path)
```

```{r Phylosignal}
data <- PFT_sp
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(data$WD))]
phy <- drop.tip(tree, tips)
data <- data[phy$tip.label,c(2:5,7)]
p4d <- phylo4d(phy,data)
phyloS <- phyloSignal(p4d, methods = 'I') 
phyloS <- data.frame(paste(round(phyloS$stat[,1], 3), 
                           unlist(lapply(as.list(phyloS$pvalue[,1]), stars, ns = ' '))),
                     row.names = row.names(phyloS$stat))
names(phyloS) <- 'Moran\'s I'
# kable(bold(phyloS))
rm(data, tips, p4d, phyloS, phy)
```

```{r BETAst $ PIst}
# Observed Hardys
phy <- tree
phy$tip.label <- Species$SpCode[match(gsub('_', ' ',phy$tip.label), Species$LatinName)]
tips <- lapply(L, function(s){
  c(setdiff(phy$tip.label, names(s$abundance)), setdiff(names(s$abundance), phy$tip.label))
})
phy <- lapply(tips, function(s){
  drop.tip(phy, s)
})
phy <- lapply(phy, function(s){
  s$node.label <- NULL
  return(s)
})
spaphy <- mapply(function(Ls, phys){
  spacodi.calc(sp.plot = t(Ls$abundance), phy = phys, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]
}, Ls = L, phys = phy, SIMPLIFY = F)
## Mantel values
spaphy.mantel <- mapply(function(s, Mes, Mss){
  list(
    `E` = lapply(s, function(m){
      vegan::mantel(m, Mes, permutations = 0)$statistic
      }), 
    `S | E`= lapply(s, function(m){
      vegan::mantel.partial(m, Mss, Mes, permutations = 0)$statistic
      })
    )
}, s = spaphy, Mes = Me, Mss = Ms, SIMPLIFY = F)

# Simulated mantel
nphy <- lapply(phy, function(s){
  rep(list(s), 999)
})
cl <- makeCluster(cores)
clusterExport(cl, list('nphy', 'L', 'spacodi.calc', 'Ntip', 'resamp.phy', 'branching.times'))
nphy <- clusterApply(cl, nphy, function(s){
  lapply(s, resamp.phy)
})
stopCluster(cl)
nspaphy <- mapply(function(s, Ls){
  lapply(s, function(p){
  spacodi.calc(sp.plot = t(Ls$abundance), phy = p, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]
  })
}, s = nphy, Ls = L, SIMPLIFY = F)
rm(cl, nphy)
invisible(gc())
nspaphy.mantel <- mapply(function(s, Mes, Mss){
  list(
    `E` =lapply(s, function(x){
      lapply(x, function(M){
        vegan::mantel(M, Mes, permutations = 0)$statistic})}), 
    `S | E` = lapply(s, function(x){
      lapply(x, function(M){
        vegan::mantel.partial(M, Mss, Mes, permutations = 0)$statistic
      })
    })
  )
}, s = nspaphy, Mes = Me, Mss = Ms, SIMPLIFY = F)
## Non null mantels
names(nspaphy.mantel) <- c('C', 'U')
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){
  lapply(s, function(m){
    lapply(m, `[`, names(m[[1]]))
    apply(do.call(rbind, m), 2, as.list)
  })
})
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){
  lapply(s, function(m){
    lapply(m, unlist)
  })
})
spaphy.res <- mapply(function(s, ns){
  mapply(function(m, nm){
    mapply(function(b, nb){
      paste(format(b, scientific = T, digits = 3), 
            Uppangala::stars(min(1-rank(c(b,nb))[1]/(n+1),rank(c(b,nb))[1]/(n+1)), ns = '   '))
    }, b = m, nb = nm, SIMPLIFY = T)
  }, m = s, nm = ns, SIMPLIFY = F)
}, s = spaphy.mantel, ns = nspaphy.mantel, SIMPLIFY = F)
spaphy.res <- mapply(function(s, str){
  s <- data.frame(s)
  s <- cbind(c(str, ' '), c('$U_{st}$', '$\\tau _{st}$'), s)
  names(s) <- c('S', 'M', 'E', 'S|E')
  return(s)
}, s = spaphy.res, str = c('C', 'U'), SIMPLIFY = F)
spaphy.res <- do.call('rbind', spaphy.res)

# Result
kable(bold(spaphy.res), row.names = F)
rm(mtest, spaphy.mantel, nspaphy, nspaphy.mantel, spaphy.res)
```

While LDMC did not phylogenetic structure (Moran's I of 0 with a $p-value > 0.1$), LA and LT were phylogenetically clustered (Moran's I of 0.021 and 0.018 with a $p-value < 0.001$), and WD and SLA were weakly clustered (Moran's I of 0.005 and 0.003 with $p-value < 0.1$). Phylogenetic variation among communities was neither correlated to environmental variation (Mantel test, $r_{\beta_{st},E} = 0.02$ and $r_{\pi_{st},E} = 0.05$ with $p-value > 0.1$) nor to remaining spatial variation in partial Mantel test knowing environment ($r_{\beta_{st},S|E} = 0.01$ and $r_{\pi_{st},S|E} = -0.01$ with $p-value > 0.1$).

# References
