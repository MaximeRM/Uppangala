---
title: Decoupled wood and leaf strategies among canopy and understorey tree in a low-elevation
  rainforest of India
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output: word_document
csl: mee.csl
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
library(Uppangala)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

Built with `Uppangala` package version `r packageVersion('Uppangala')`.

# Abstract

## Keywords

functional trait; rainforest; vertical forest strata; Western Ghats; environmental filternig; niche differentiation; ecological guild

# Introduction

Understanding the determinants of species occurrence and co-occurrence is a long standing issue in ecology [@diamond_ecology_1975]. Tropical rainforests have especially fascinated ecologists due to their outstanding diversity [@connell_diversity_1978]. Niche theory explains species coexistence depending on niche differences to limit competitive exclusion [@weiher_assembly_1995; @lortie_rethinking_2004], while neutral theory shows that maintenance of high diversity is possible even for functionally equivalent species, under the influence of stochastic life, death, reproduction and dispersal dynamics [@hubbell_unified_2001]. Both theories can provide realistic expectations of taxonomic diversity [@chave_comparing_2002] so that inferring ecological processes from taxonomical composition patternis is challenging in community ecology.

Investigating patterns of functional or phylogenetic diversity may reveal signatures of ecological processes that are specific to the niche theory [@mcgill_rebuilding_2006; @westoby_land-plant_2006; @mouquet_ecophylogenetics:_2012]. Indeed, if taxonomic composition is expected to be spatially structured in both theories, due to the spatial structure of environment or to dispersal limitation, functional or phylogenetic assemblage are expected to be spatially structured only under the niche theory [@kraft_functional_2010; @baraloto_using_2012; @hardy_phylogenetic_2012; @parmentier_prevalence_2014]. We here investigate taxonomic and functional diversity in a topographically complex rainforest of the Western Ghats biodiversity hotspot [@myers_biodiversity_2000], India, where few studies have assessed the ecological drivers of local composition [@munoz2007estimating; @hardy_phylogenetic_2012,; @krishnadas2016environmental].

The variation in functional traits among species is expected to reflect different abilities to grow, survive and reproduce in a given environment [@violle_let_2007] and expresses fundamental trade-offs along environmental gradients [@mark_westoby_plant_2002]. For instance, the specific leaf area varies along a soil fertility-shade gradient and represents a trade-off between resource acquisition by photosynthesis and investment in leaf defense and durability [@hodgson_is_2011]. Fundamental trade-offs entail functional traits covariation along basic leaf [@wright_worldwide_2004 but see @osnas_global_2013 and @lloyd_photosynthetically_2013] and wood [@chave_towards_2009] economics spectra. The leaf economics spectrum opposes acquisitive to conservative ecological strategies, basically expressed at leaf level. **WES trade-off to clarify without CSR** The wood economics spectrum distinguishes species strategies over three axes spanning the basic CSR strategies of @grime_evidence_1977 : (i) competitive species, with high conductive efficiency, (ii) stress tolerant species, resistant to embolism, and (iii) disturbance tolerant species, with high mechanical strength [@chave_towards_2009]. @baraloto_decoupled_2010 found decoupled wood and leaf economics of trees in neotropical forest, but @reich_world-wide_2014 conversely posited that both spectra have to be integrated in a comprehensive whole plant economics spectrum [@freschet_evidence_2010] opposing fast growing acquisitive species to slow growing and more conservative ones. Here we address how varying wood and leaf ecological strategies determine species community assembly in an Indian rainforest. 

A major challenge is to relate local coexistence in an ecological community to a broader context of species dynamics [@ricklefs_disintegration_2008; @munoz_neutral_2016]. The trait values of coexisting species represent a non-random sample of trait values found in a broader area, du to specific niche-based dynamics in the local community [@lortie_rethinking_2004; @bernard-verdier_community_2012]. Then the signature of local niche-based dynamics can be gasped by assessing the deviation of local community structure from a larger "species pool", classicaly using null models [@kraft_functional_2008]. Specifically, lower variance of functional traits than null is expected when a narrow range of strategies is locally successful [functional convergence, @ackerly_trait-based_2007], while larger variance and greater eveness is expected if biotic interactions entail niche differentiation [@macarthur_limiting_1967]. In addition, the nature of functional traits and ecological strategies driving species coexistence can change across scales. For instance, @messier_trait_2016 have underlined that the leaf economics spectrum basically expresses changes in ecological strategies along broad-scale environmental gradients, while it is not necessarily a primary driver of local coexistence. In this paper we will decompose the variation of tree functional traits in a large rainforest plot into sources of variation within communities [@kraft_disentangling_2011], using appropriate null models.

The concept of ecological community basically represents the spatial limits which species share resources and interact [**cite Loojien and van Andel 1999**], while the concept of guilds refer to groups of functionally similar species [@wilson_guilds_1999]. The two concepts are not exclusive, as ecological guilds can coexist and occupy distinct niches whithin communities [@vergnon_niches_2009]. In tropical forests, most emphasis has been put on the dynamics of the guilds of canopy trees [@hubbell_unified_2001] **Maxime disagree, Hubbel used 1 cm gbh**, but the way disctinct guilds of canopy and understorey trees coexist in communities is little addressed. Distinctive ecological constraints are expected to drive different resource use strategies and biotic interactions in these guilds, which should translate into different functional composition and response to environmental factors. Low elevation rainforests in South India are remarkably heterogeneous in vertical structure and encompass distinctive guilds across the vertical strata [@pascal_wet_1988]. It thus provides an appropriate context to adress guild-dependent dynamics and ecological strategies in tropical rainforests. We thus investigate here the diversity patterns and community assembly of rainforest trees at guild-level.

In this paper, we used a trait-based approach to address guild dynamics whithn local tree assembly along topographical gradients in a tropical rainforest from the Western Ghats, India. Although considered as wet evergreen, the forest undergoes contrasted long dry and intense rainy seasons under the influence of monsoon. In this context, we expected water stress and competition for resource to be primary drivers of forest dynamics and functional composition. A large forest plot (10ha) was subdivided in local elementary communities and we investigated how guild composition whithin communities varied with local environmental conditions. We addressed the following questions:

1. About the variation and covariation in functional traits within and among species,
    i. Does functional traits variation allow identifying distinctive ecological strategies among species ?
    ii. Does their covariations reflect basic dimensions of ecological strategy in the rainforest ?
2. About the role of functional trait variation in guild and community assembly,
    iii. Does the local functional composition $\alpha$ reflect the influence of guild and community dynamics ?

# Material and methods

## Study site

The study was carried out in a 10-ha permanent plot established in 1990 by the French Institute of Pondicherry in an undisturbed, old-growth wet evergreen Dipterocarp forest [@pascal_structure_1996]. The plot is located in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India), near the Uppangala village, and thus refers to as "Uppangala plot". Annual precipitation averages 5108 mm per year but is highly variable in time with heavy rainfall from June to October (90% of the rainfall during the monsoon) and a severe dry season (monthly rainfall $\leq 45$ mm) lasting 3.8 months [@pelissier_twenty_2011]. Mean annual temperature in the station of Sampaji (15 km from Uppangala) is about 27$^\circ C$, with a mean minimum about 25$^\circ C$ during July rainfall pick and a maximum mean temperature of 29$^\circ C$ in April [@pascal_structure_1996]. Climate and geology of the 10-ha plot can be considered as homogeneous. The topography of the site is highly heterogeneous with regular east-west alternation of thalwegs and ridges separated by steep slopes, so that it is expected to be a major component of environmental variation within the forest plot [@gimaret-carpentier_sampling_1998]. Therefore, we hypothesized that topographic variation should influence community assembly and yield changing ecological strategies and functional composition [@condit_spatial_2000].

## Taxonomic composition and trait sampling

From 1989 to 2014, the trees $\geq 30$ cm in girth at breast height (gbh) were identified, tagged, mapped and monitored in an area progressively extended to a contiguous $300 * 330 m^2$ (ca. 10-ha) plot [@pelissier_twenty_2011]. The plot included 111 different tree species. We collected trait data from 89 over 111 (80.1%) species, which represented 99.0% of tree individuals present in the plot. Note that the 32 most abundant species alone, represented more than 80% of tree individuals. We sampled five individuals per species for these 32 species, and sampled one to five individuals for the remaining species (in total 267 individuals). For each individual we collected 5 mature shadow leaves and one branch sample with a diameter close to 1 cm following recommendation of @perez-harguindeguy_new_2013. Individuals and leaves were selected in consistent light conditions, development stage and sanitary state. Dawkins crown exposure index [@dawkins_management_1958] was recorded for each tree sampled. Leaf and branch samples were kept in humidified ziplock filled with enriched $CO_{2}$ air inside a black bag until measurement within the next 24 hours. For some individuals, we were unable to collect suitable branch sample (11 missing species over 89 representing 1% of individuals present).

## Trait measurements

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, thickness and area were measured, using a weighing scale (**add detail on brand and precision**), a micrometer (**add detail on brand and precision**) and a bend scanner with ImageJ software [**ref**] respectivelly. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 $^\circ C$. Once dried, the leaves were weighted directly after been extracted from the oven to avoid humidity bias. The bark and pit of branch samples were removed in order to keep only branch wood with no soft tissues. Branch wood samples were immersed in water to evaluate their volume by water displacement. Wood samples were then dried for 48 hours at 80 $^\circ C$ and weighted. 

We calculated five functional traits of leaf and wood samples: leaf thickness (LT in $\mu m$ ), leaf area measured from scans (LA in $mm^2$), leaf dry matter content as the leaf dry weight divided by the leaf fresh weight (LDMC in $mg.g^-1$), specific leaf area as the leaf area divided by the leaf dry mass (SLA in $m^2.kg^-1$), and branch wood density  as the the wood sample dry weight divided by its volume (WD in $g.cm^-3$, see table 1). We choose those five traits because they proved to be good proxies of the major dimensions of ecological strategies in plants [@mark_westoby_plant_2002; @diaz_global_2015] and were reatively easy to measure on the field.

Table 1: Functional traits measured. *Traits with their abbreviation, standard unit, and associated species strategy for functioning, survival and reproduction [@baraloto_decoupled_2010].*

```{r 1 Traits}
rm(list = ls()[-which(ls() == "cores")]); invisible(gc())
PFT <- genPFT()
table <- data.frame(
  Trait = c('Leaf thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  Abbreviation = c('LT', 'LA', 'LDMC', 'SLA', 'WD'),
  Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
  Strategy = c('Leaf defense and investment',
        'Leaf resource capture vs.investment',
        'Leaf defense and investment',
        'Leaf resource acquisiton vs. defense',
        'Stem transport, structure and defense')
)
kable(table, row.names = F)
rm(table)
```

## Environmental variables

Topography was expected to be a major environmental factor influencing the assemby of tree communities [@gimaret-carpentier_sampling_1998]. We selected 8 topographical variables representing the abiotic environment: elevation, slope, curvature, plan curvature, profile curvature, wetness (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west: $cos(aspect~in~degres + 225)$) derived from elevation data available within the plot using the RSAGA package [@brenning_statistical_2008], and distance to the nearest potential river computed in ArcGis [**ref**]. 

In order to identify the main sources of environmental variation and to avoid multi-colinearity in subsequent analyses, we performed a principal component analysis (PCA) of the abiotic environmental variables (see Supplementary Materials S1). We selected four less correlated variables: curvature representing local water flow paths and soil accumulation areas, wetness highlighting water accumulation areas over the whole study area, southwesterness representing aspect [@bunyan_effect_2015] and slope, which may have both a strong effect on forest dynamics and on nutrient/water availability **ref**.

In addition, we selected two biotic factors related to local forest structure: canopy height and basal area. Canopy height, i.e. the maximum local height of the canopy, was calculated from a 1-m resolution digital canopy model built from a LiDAR (Light Detection And Ranging) dataset acquired in 2013 over the Uppangala plot. Basal area was calculated the girth measurements taken within the 10-ha plot (census done in 2013 and 2014) for stems $>30~cm$ gbh. 

## Analyses

### Traits variation and covariation

We calculated the coefficient of variation (ratio of the standard deviation to the mean) of trait values among leaves of the same individual (intra-individual), among trees of the same species (intra-specific for species with more than one individual), and among species (inter-specific). We performed a principal component analysis (PCA) of the mean value of traits per species to identify main dimensions of ecological strategies along which traits can covary. Subsequent community-level analyses were based on trait values averaged per species.

### Guild-level analyses

$30*30 m^2$ quadrats were delimited in the 10 heactare plot and represented 110 local communities. @pascal_wet_1988 defined four vertical strata attained by adult trees: emergent above 39m, canopy trees between 25 and 39m, sub-canopy trees between 15 and 25m, and understorey trees below 15m. Despite the vertical hierarchy, steep topography could allow sub-canopy trees receiving much light, expecially in slopes, and thus participates to canopy. We defined two basic guilds called canopy (C), composed of emergent, canopy and sub-canopy species, and understorey (U) species. We analyze trait composition of these guilds in the 110 communities.

<!-- Metrics -->
We calculated weighted mean (GWM, where G stands for "guild"), weighted variance (GWV), and coefficient of variation of nearest neighbour distance (CVNND) [GWM and GWV, @violle_let_2007; CVNND, @jung_intraspecific_2010] for each guild in each community. In the quadrat $j$, GWM of trait $t$ was the mean of trait values $t_{i}$ of $i$ species weighted by species relative abundance $p_{i}$:
$$GWM_{j} = \sum_{i=1}^{S} p_{i,j} * t_{i,j} ~ (1)$$
where $S$ is the number of species in the quadrat. 

We also calculated the average trait values based on species presence-absence, to addressthe influence less abundant and rare species on community trait composition [@cingolani_filtering_2007]. GWV of trait $t$ was calculated as :
$$GWV_{j} = \sum_{i=1}^{S} p_{i,j} * (t_{i,j} - GWM_{j})^2 ~ (2)$$

CVNND of trait $t$ was calculated as the standard deviation of nearest neighbor distances (NND) $\sigma _{NND}$ divided by the mean NND $\mu _{NND}$; and NND was the minimal distance $d$ between a species and the most similar other species of the guild :
$$CVNND = \frac{\sigma _{NND}}{\mu _{NND}} ~ , ~ ~ ~ NND = [NND_{i} = min(d_{i,j})_{i \neq j}] ~ (3)$$

<!-- Null models -->
To assess significant changes in functional composition among guilds, we devised a null model apporoach. A first null model (NM1) randomized trait values among species in the whole plot (permuting raw in `Trait*Species` matrix). The second model (NM2) randomized abundances among species within each guild but kept the observed list of species and trait values unchanged inside guilds [@bernard-verdier_community_2012]. **Spatial correlations in tree abundance are conserved limiting associated type I error.** GWM and CVNND metrics were compared to null model NM1 whereas GWV was studied with null model NM2 **To develop**.

<!-- Analysis -->
We performed 999 randomizations for each model and we derived a two-tailed test of the proportion of guilds deviating from the null expectation, with adjusted p-values by Benjamini-Hochberg correction **Citation**. Shifts in GWM values with changing environmental conditions could reflect the shorting of species strategies across assemblages [@ackerly_trait-based_2007]. GWV lower/higher than null represented convergence/divergence of trait values within the guild [@bernard-verdier_community_2012]. CVNND was used to detect niche differentiation among coexisting species, which occurred when observed CVNND was lower than null [@jung_intraspecific_2010]. 

To characterize the patterns of deviation from the null model, we also calculated standardized effect sizes (SES) as
$$SES = \frac{(I_{obs} - I_{null})}{\sigma _{null}} (4)$$
where $I_{obs}$ was the observed metric and $I_{null}$ and $\sigma _{null}$ were the mean and standard deviation of the corresponding null distribution.

The influence of environment on SES values was investigated by linear regression with biotic and abiotic factors ($SES_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$). Analyses were conducted on the five functional traits and the species scores obtained on the 2 first PCA axes.

All analyses were conducted using the R 3.3.0  software [@r_core_team_r:_2016] with packages 
`ade4` [@dray_ade4_2007],
and `vegan` [@oksanen_vegan:_2016].

# Results

**General statistics on guilds: size, richness...**

## Traits variation and covariation

We found overall increase of functional trait variation from intra-individual to inter-specific level (see table 2), even though LA showed almost as large variability at intra-individual than at intra-specific level ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). Relatively low intra-individual variation ($cv_{intra}$ range from 0.06 to 0.09) allowed us considering mean trait values per species in subsequent analyses of the trait composition of guilds.

Table 2: Intra-individual, intra-specific and inter-specific component of trait variation. *The overall range, mean and standard deviation are provided for each trait. The remaining columns represent the coefficient of variation of trait values among leaves per individuals (intra-individual), among trees per species (intra-specific), and among trees of different species. See table 1 for abbreviation.*

```{r 2 CV}
# Individual aggregation
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$Sp
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$SpCode
names(SpCode) <- SpCodeT$Sp
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$Sp <- Sp[row.names(PFT_ind)]
PFT_ind$SpCode <- SpCode[as.character(PFT_ind$Sp)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
# Species aggregation
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
# Coefficient of variation
trait <- c('LT', 'LA', 'LDMC', 'SLA', 'WD')
cv <- data.frame(
  row.names = trait,
  Range = c(paste(range(PFT$LT, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  m = c(paste0(round(mean(PFT$LT, na.rm = T)), ' (',
               round(sd(PFT$LT, na.rm = T)), ')'),
        paste0(round(mean(PFT$LA, na.rm = T)), ' (',
               round(sd(PFT$LA, na.rm = T)), ')'),
        paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
               round(sd(PFT$LDMC, na.rm = T)), ')'),
        paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
               round(sd(PFT$SLA, na.rm = T),2), ')'),
        paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
               round(sd(PFT$WD, na.rm = T),2), ')')),
  m1 = round(unlist(lapply(as.list(trait), function(y){
    mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){
      sd(x, na.rm = T) / mean(x, na.rm = T)
    })[,2], na.rm = T)
  })) ,2),
  m2 = round(unlist(lapply(as.list(trait), function(y){
    mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$Sp), function(x){
      sd(x, na.rm = T) / mean(x, na.rm = T)
    })[,2], na.rm = T)
  })), 2),
  m3 = round(unlist(
    lapply(as.list(trait), function(y){
      sd(PFT_sp[,which(names(PFT_sp) ==  y)], na.rm = T) / mean(PFT_sp[,which(names(PFT_sp) ==  y)], na.rm = T)
    })), 2)
)
names(cv)[2:5] <- c('Mean (sd)' , 'Intra-individual', 'Intra-species', 'Inter-species')
cv['WD','Intra-individual'] <- ''
kable(cv)
rm(PFT, CET, cv, CE, Sp, SpT, SpCodeT)
```

The first axis of the principal component  analysis (PCA) of mean species trait values was basically related to wood density and structural ela trait variations (LT, LA, LDMC), thus opposing species with thick, big leaves and lightwood to species with dense leaves and hardwood. The second axis was mainly related positively to SLA and negatively to LDMC. Wood density was othogonal to SLA in the plan 1-2 of the PCA, while positive correlation was found between LDMC and WD (Pearson's correlation test, $r = 0.25$ with $p-value < 0.001$).

```{r 3 PCA PFT}
library(vegan)

# Individual to log
PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
# Species aggregation
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
# PCA
pca <- princomp(~ LA + WD + LT + LDMC + SLA, data = PFT_sp, cor = T)
lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
      xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economics spectrum', 'Wood economics spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  # lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

# LES and WES
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
rm(PCAscores, PFT_ind, SpCodeT, lambda, pca, pca.var, Rot, XLIM)
```

Figure 1: Principal Component Analysis (PCA) of species mean trait values. *The bottom right subplot represents the eigen values (grey bars) of the five components. First axis, in red, is named wood economic spectrum (WES) ; whereas second axis, in green, is named leaf economic spectrum (LES). See table 1 for abbreviation.*

```{r 4 env-com}
library(raster)

# Building community and environmental datasets
Env <- genEnv()
Trees <- genTrees()
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats(cs = c(30,30))
XY <- Trees[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'), path = '/usr/share/applications')
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
BA <- aggregate(Trees$Girth, list(Trees$com), function(x){sum(pi*(x/(2*pi))^2, na.rm = T)})
com@data$BA <- BA$x[match(com@data$id, BA$Group.1)]
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SW, data = com@data, cor = T)

# Building RLQ matrices
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')]
row.names(Q) <- PFT_sp$SpCode
sel <- which(Species$Strata[match(PFT_sp$SpCode, Species$SpCode)] == 3)
Q <- list(C = Q[-sel,], U = Q[sel,])
sel <- lapply(Q, function(q){intersect(row.names(q), names(L))})
Q <- mapply(function(q,s){q[s,]}, q = Q, s = sel, SIMPLIFY = F)
L <- lapply(sel, function(s){L[s]})
R <- lapply(L, function(l){R[row.names(l),]})
L <- lapply(L, function(l){list(abundance = l, `presence-absence` = l)})
L <- lapply(L, function(l){l$`presence-absence`[l$`presence-absence` > 1]  <- 1 ; return(l)})

rm(Deriv, XY, Env, sel, BA, s)
```

## Functional composition of guilds

We found significant variation along the environmental gradients of the guild weighted means (GWM), both in abundance or presence-absence, and for both canopy (C) and understorey (U) guilds (see table 3 and supplementary materials S2). Functional traits of both canopy and understorey tree species were basically influenced by curvature, but only functional traits from canopy tree species were influenced by south-west orientation and mainly the functional traits of understorey tree species were influenced by canopy height.

Mean value of WD, repsectively WES, in canopy tree species significantly increased, resp. decreased, under south-west orientation, both in abundance and presence-absence. GWM of LA and LT decreased under SW, in abundance and presence absence respectively. In addition, LA decreased with curvature in both abundance and presence-absence, while WD, resp. WES and LDMC, increased, resp. decreased, with curvature in presence-absence only.

Mean value of LES and SLA significantly decreased in understorey tree species when those of WD and LT significantly increased with curvature, both in abundance and presence-absence. WES of understorey tree species also increased and LA decreased with curvature in abundance. In addition, LES and SLA in both abundance and presence-absence were increased with canopy height, while LDMC and WD decreased with canopy height in abundance.

Trait values allowing species persistence are not always the same than those determining species dominance in a given environment. For instance here both abundant and less abundant canopy tree species had greater WD under southwest orientation, while higher mean WD was found in concave environment only in presence-absence, meaning that other factors could influence the success of more abundant species.

Table 3: Linear models of the standardized effect size (SES) for each trait of GWMs, for canopy (C) and understorey (U) guilds, in abundance. _We performed stepwise selection of the predictors including slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA), and only the selected predictors are shown. See table 1 for abbreviations. Bold and number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWM}
# Observed CWMs
CWM <- mapply(function(Ls,Qs){
  lapply(Ls, function(l){
    lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
      apply(l, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)
CWM <- lapply(CWM, function(s){
  lapply(s, function(x){
    names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(x)
  })
})

# Simulated CWMs
n = 999
nQ <- lapply(Q, function(s){
  rep(list(s), n)
})
nQ <- lapply(nQ, function(s){ 
  lapply(s, function(nq){
      row.names(nq) <- sample(row.names(nq))
      return(nq)
  })
})
nQ <- mapply(function(nQs, Ls){
  lapply(nQs, function(nq){
    nq[names(Ls$abundance),]
  })
}, nQs = nQ, Ls = L, SIMPLIFY = F)
cl <- makeCluster(cores)
clusterExport(cl, list('L', 'nQ'))
nCWM <- clusterMap(cl, function(nQs, Ls){
  lapply(nQs, function(nq){
    lapply(Ls, function(l){
      lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
        apply(l, 1, function(x){
          weighted.mean(nq[,v], x, na.rm=T)
        })
      })
    })
  })
}, Ls = L, nQs = nQ)
stopCluster(cl)
rm(cl)
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ns){
  lapply(ns,function(ab){
    names(ab) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(ab)
    })
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, `[`, names(ab[[1]]))
    apply(do.call(rbind, ab), 2, as.list)
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      do.call('cbind', x)
    })
  })
})
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ab){
    lapply(ab, data.frame)
  })
})

## CWM SES
CWM.ses <- mapply(function(CWMs, nCWMs){
  mapply(function(CWMab, nCWMab){
    data.frame(
      mapply(function(x,y){
        mapply(function(p,q){
          (p - mean(q))/sd(q)
        }, p = as.list(x), q = as.list(data.frame(t(y))))
      }, x = CWMab, y = nCWMab)
    )
  }, CWMab = CWMs, nCWMab = nCWMs, SIMPLIFY = F)
}, CWMs = CWM, nCWMs = nCWM, SIMPLIFY = F)
CWM.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(ab){
    apply(ab, 2, function(y){
      step(lm(y ~., Rs), direction = 'both', trace = 0)
    })
  })
}, s = CWM.ses, Rs = R, SIMPLIFY = F)
CWM.ses.res <- lapply(CWM.ses.lm, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      summary(x)$coefficients
    })
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    lapply(ab, data.frame)
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    lapply(ab, function(x){
      x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
      return(x)
    })
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    data.frame(data.table::rbindlist(lapply(ab, function(x){
      data.frame(t(x[5]))
    }), fill = T))
  })
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
  ab[,setdiff(var, names(ab))] <- NA
  ab <- ab[var]
  ab <- apply(ab, 2, as.character)
  row.names(ab) <- names(CWM.ses$C$abundance)
  ab[is.na(ab)] <- ''
  ab <- data.frame(ab)
  return(ab)
  })
})
CWM.ses.res <- mapply(function(s, CWM.ses.lms){
  mapply(function(ab, CWM.ses.lmab){
    ab$`$R^2$` <- round(unlist(lapply(CWM.ses.lmab, function(x){
      summary(x)$r.squared
    })),3)
    return(ab)
  }, ab = s, CWM.ses.lmab = CWM.ses.lms, SIMPLIFY = F)
}, s = CWM.ses.res, CWM.ses.lms = CWM.ses.lm, SIMPLIFY = F)
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  lapply(s, function(ab){
    ab <- cbind(row.names(ab), ab)
    names(ab)[1] <- 'Trait'
    return(ab)
  })
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  mapply(function(ab, name){
      ab <- cbind(c(name, rep(' ', length(ab[,1])-1)), ab)
      names(ab)[1] <- 'T'
      return(ab)
  },ab = s, name = as.list(c('AB', 'PA')), SIMPLIFY = F)
})
CWM.ses.res <- lapply(CWM.ses.res, function(s){
  do.call('rbind', s)
})
CWM.ses.res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'S'
  return(s)
}, s = CWM.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CWM.ses.res <- do.call('rbind', CWM.ses.res)
rm(nCWM, CWM.ses.lm)
invisible(gc())
```

```{r CWM AB}
kable(bold(CWM.ses.res[c(1:7,15:21),-2]), row.names = F)
```

```{r WD}
data <- cbind(CWM.ses$C$abundance$WD, R$C)
names(data)[1] <- 'WD'
par(mfrow = c(3,2)) # Affichage des relations individuelles
plot(WD ~ Slope, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
plot(WD ~ Curvature, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
plot(WD ~ Wetness, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
plot(WD ~ SW, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
plot(WD ~ Canopy, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
plot(WD ~ BA, data) ; abline(h = c(0.95, 0, -0.95), lty = c(2, 1, 2))
rm(data, CWM.ses)
```

Figure 2: Exemple of standard effect size (SES) of wood density  (WD) for canopy (C) tree species. *Each subplot show  standard effect size (SES) of wood density (WD) for canopy (C) tree species along one environmental variable gradient. Continuous line represents a null SES, whereas dashed line represents limits of the confidence interval above which SES are considered as significant. See table 1 for abbreviation.*

We assessed trait convergence/divergence based on the deviation of guild weighted variance (GWV) from null model NM2. We found significant relationships between the standardized effect size (SES) of GWVs and the environmental predictors (see table 4). Convergence of WES and LDMC in the canopy guild  and convergence of LA in the understorey guild occured in convex areas. LDMC values in the canopy guild converge more in taller canopy. We also found significant relationships of standardized effect sizes (SES) of CVNNDs with environmental predictors (see table 4). Niche differentiation (lower CVNND) of WES and LDMC in canopy tree species increased with lower basal area. Differentiation of LA in canopy tree species increased in convex context and taller canopy, whereas LT of canopy tree species showed higher differentiation in concave context. Niche differentiation of LES in understorey tree species increased in concave context, while LT of understorey tree species showed higher differentiation in wet context with a high basal area.

Table 4: Linear models of the standardized effect sizes (SES) of GWV and CVNND, for canopy (C) and understorey (U) guilds. _We performed stepwise selection of the predictors including slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA), and only the selected predictors are shown. See table 1 for abbreviations. Bold and  number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWV}
# Removing communities with only one species
for(s in names(L)){
  sel <- which(rowSums(L[[s]]$`presence-absence`) < 2)
  if(length(sel) > 1){
    L[[s]] <- lapply(L[[s]], function(ab){
      return(ab <- ab[-sel,])
    })
    R[[s]] <- R[[s]][-sel,]
  }
}

# Observed CWVs
CWV <- mapply(function(Qs, CWMs, Ls){
  lapply(names(CWMs$abundance), function(v){
    apply(cbind(data.frame(CWMs$abundance[[which(names(CWMs$abundance) == v)]]),Ls$abundance), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, Qs = Q, CWMs = CWM, Ls = L, SIMPLIFY = F)
CWV <- lapply(CWV, function(s){
  names(s) <- names(CWM$C$abundance)
  return(s)
})

# Simulated CWVs 
nL <- list(C = rep(list(L$C$abundance), n),
           U = rep(list(L$U$abundance), n))
nL <- lapply(nL, function(s){
  lapply(s,function(l){
    apply(l, 1, function(x){
      x[x != 0] <- sample(x[x != 0])
      return(x)
    })
  }) 
})
nL <- lapply(nL, function(s){
  lapply(s, function(x){
    t(x)
  })
})
nL <- lapply(nL, function(s){
  lapply(s, data.frame)
})
cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'CWM', 'Q'))
nCWM.cwv <- clusterMap(cl, function(nLs, CWMs, Qs){
  lapply(nLs, function(nl){
    lapply(as.list(names(CWMs$abundance)), function(v){
      apply(nl, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, nLs = nL, CWMs = CWM, Qs = Q, SIMPLIFY = F)
stopCluster(cl)
nCWM.cwv <- lapply(nCWM.cwv, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
nCWV <- mapply(function(nLs, nCWM.cwvs, Qs){
  mapply(function(l,cwm){
  lapply(names(CWM$C$abundance), function(v){
    apply(cbind(data.frame(cwm[[which(names(cwm) == v)]]),l), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, l = nLs, cwm = nCWM.cwvs, SIMPLIFY = F)
}, nLs = nL, nCWM.cwvs = nCWM.cwv, Qs = Q, SIMPLIFY = F)
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
rm(nCWM.cwv, cl, nL)
invisible(gc())
nCWV <- lapply(nCWV, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
      do.call('cbind', x)
  })
})
nCWV <- lapply(nCWV, function(s){
    lapply(s, data.frame)
})
## CWV SES
CWV.ses <- mapply(function(CWVs, nCWVs){data.frame(
  mapply(function(x,y){
    mapply(function(p,q){
      (p - mean(q))/sd(q)
    }, p = as.list(x), q = as.list(data.frame(t(y))))
  }, x = CWVs, y = nCWVs)
)}, CWVs = CWV, nCWVs = nCWV, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    lm(y ~., Rs)
  })
}, s = CWV.ses, Rs = R, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(x){
    step(x, direction = 'both', trace = 0)
  })
}, s= CWV.ses.lm, Rs = R, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, data.frame)
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CWV.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CWV.ses.res <- mapply(function(s, CWV.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CWV.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CWV.ses.res, CWV.ses.lms = CWV.ses.lm, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
CWV.ses.res <- mapply(function(s, name){
  if(dim(s)[1] > 0){
    s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
    names(s)[1] <- 'Strata'
    return(s) 
  }
}, s = CWV.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CWV.ses.res <- do.call('rbind', CWV.ses.res)
rm(CWV.pval.res, CWV.ses.lm, nCWV)
```

```{r CVNND}
# Removing communities with only two species
for(s in names(L)){
  sel <- which(rowSums(L[[s]]$`presence-absence`) < 3)
  if(length(sel) > 1){
    L[[s]] <- lapply(L[[s]], function(ab){
      return(ab <- ab[-sel,])
    })
    R[[s]] <- R[[s]][-sel,]
  }
}

# Observed CVNND
CVNND <- mapply(function(Ls, Qs){
  apply(Ls$abundance, 1, function(l){
  apply(Qs, 2, function(q){
    cati::CVNND(rep(q, l), na.rm = T)
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)
## NaN CVNND$U
sel <- which(is.na(CVNND$U[1,]))
CVNND$U <- CVNND$U[,-sel]
R$U <- R$U[-sel,]

# Simulated CVNNDs 
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L'))
nCVNND <- clusterMap(cl, function(nQs, Ls){ 
  lapply(nQs, function(x){
    apply(Ls$abundance, 1, function(l){
      apply(x, 2, function(q){
        cati::CVNND(rep(q,l), na.rm = T)
      })
    })
  })
}, nQs = nQ, Ls = L)
stopCluster(cl)
rm(cl, nQ)
invisible(gc)
## NaN CVNND$U
nCVNND$U <- lapply(nCVNND$U, function(x){
  x <- x[,-sel]
})

nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(x){
    x <- as.list(data.frame(t(x)))
  })
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(t){
      t <- data.frame(lapply(t, cbind))
  })
})


## CVNND SES
CVNND.ses <- mapply(function(CVNNDs, nCVNNDs){
  data.frame(
    mapply(function(x,y){
      mapply(function(p,q){
        (p - mean(q))/sd(q)
      }, p = as.list(x), q = as.list(data.frame(t(y))))
    }, x = as.list(data.frame(t(CVNNDs))), y = nCVNNDs)
  )
}, CVNNDs = CVNND, nCVNNDs = nCVNND, SIMPLIFY = F)
CVNND.ses <- lapply(CVNND.ses, function(s){
  row.names(s) <- colnames(CVNND)
  return(s)
})
CVNND.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    step(lm(y ~., Rs), direction = 'both', trace = 0)
  })
}, s = CVNND.ses, Rs = R, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, data.frame)
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CVNND.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CVNND.ses.res <- mapply(function(s, CVNND.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CVNND.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CVNND.ses.res, CVNND.ses.lms = CVNND.ses.lm, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
CVNND.ses.res <- mapply(function(s, name){
  if(dim(s)[1] > 0){
    s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
    names(s)[1] <- 'Strata'
    return(s)
  }
}, s = CVNND.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CVNND.ses.res <- do.call('rbind', CVNND.ses.res)
rm(CVNND.pval, CVNND.ses.lm, nCVNND)
invisible(gc())
```

```{r CWV & CVNND table}
res <- list(CWV = CWV.ses.res, CVNND = CVNND.ses.res)
res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1:2] <- c('T', 'S')
  return(s)
}, s = res, name = as.list(c('CWV', 'CVNND')), SIMPLIFY = F)
res <- do.call('rbind', res)
kable(bold(res), row.names = F)
rm(CWV.ses.res, CVNND.ses.res, CVNND.pval.res, sel, res)
```

# Discussion

**"Take home messages" to add**

## Wood and leaf economics hold at the local scale

We found an increasing trait variation within individuals, within species, and between species (table 2). Our analyses thus reveal that the primary source of trait variation within and among communities is the inter-species variation, justifying the use of species mean traits for the study of tropical tree guild assembly. The PCA of functional trait variation among species displayed two main dimensions (figure 1), very similar to the ones found by @baraloto_decoupled_2010 and @fortunel_leaf_2012. those authors interpreted these axes as independent wood and leaf economics spectra. We found that SLA and LDMC tend to covary negatively along the leaf economics spectrum, which be seen as a trade-off between productivity, with less carbon investment and higher photosynthesis rates, and persistence, with more leaf defense and investment [@wright_worldwide_2004]. A second major axis of trait variation opposed wood density to leaf area and thickness. It may be interpreted as an axis opposing stress tolerant species, with denser wood, to competitive species, with thicker and larger leaves, conferring a higher efficiency in water conductivity **[ref?]**. It may thus be interpreted as the wood economics spectrum firstly introduced by @chave_towards_2009, and then discussed by @baraloto_decoupled_2010. Interestingly, @baraloto_decoupled_2010 found an independence between the leaf and wood economics spectra and their wood economics spectrum also showed an opposition between hardwood species having small thin leaves and light wood species having large thick leaves.

Furthermore, our results are similar to the ones found by @fortunel_leaf_2012, where basic PCA axes also represented leaf and wood economics spectra (inverted compare to us). Noticeably, our analysis integrated less traits (5 against 14), less species (89 against 758), and considered a set of species found in a local forest-plot while @fortunel_leaf_2012 considered a regional set of species from French Guiana and Peru (i.e. the opposite ends of Amazonia). Therefore, our results shows that the economics spectra found at a regional scale in the Neotropics are also valid at a far more local scale in an Indian rainforest. This result does support the arguments by @messier_trait_2016 and suggests that the two observed spectra underline major ecological strategies in tropical forests, even locally.

## Canopy and understorey species assembly rely on different economics spectra

We analyzed functional composition of $30*30m^2$ guilds from canopy and understorey, as well as the variation of this composition with environment across a 10-ha forest plot. We foud that the variations in trait composition along the environmental gradients differ between canopy and understorey species, with a marked variation in traits associated to the leaf economic spectrum (LES) for understorey species and to the wood economics scpectrum (WES) for canopy species. In the former case, the curvature and the canopy height both had a significant on the LES-based composition of understorey species, with ... a higher SLA on

<!-- We found different influence of the environment on economics spectra betweeen canopy and understorey species. Traits of the wood economics spectrum (WES) were mainly affected in canopy tree species by curvature and aspect with more convergent community composition (lower CWV) under south-west orientation ; whereas understorey tree species revealed variation in the leaf economics spectrum (LES) with curvature and canopy height. -->

Curvature is affecting the variation of leaf economics in understorey species and the variation of wood economics in canopy tree species. A locally convex context would accumulate more soil and attract more water, increasing soil fertility and allowing persistence of species investing more in leaf resource acquisition in understorey with higher SLA and lower LDMC, or less in wood ressources in canopy with lighter wood and bigger leaves converging more toward an homogeneous guild composition (lower CWV). Curvature for some functional traits, as wood density, LDMC and SLA, is also doubled by a similar effect of the wetness variable expressing also the water accumulation in convex context resulting in increased soil fertility. Economics spectra are not perfectly divided between canopy and understorey, with wood and leaf respectivelly, for instance LDMC of canopy species also decreased with curvature whereas WD increased in understorey.

The influence of aspect on forest composition is little documented in tropical forests. In a similar context that our study site, @gunatilleke_specieshabitat_2006 gave some intuitive insights on the effect of aspect on forest composition: he suggested that aspect through monsoon had a potential effect on rainforests. @bunyan_effect_2015 tested the effect of aspect on the occurence of forest fragments in a forest-grassland mosaic and foud that southwest orientation strongly determined the presence of forest in mountain rainforests of Western Ghats. They suggested that it could result from monsoon winds. In our context, monsoon winds are south-west oriented, and are expected to be a major source of disturbance in forests [@soman_aspects_1990]. 

The Uppangala plot is situated in a topographically complex area with steep slopes mostly organized along southwest-oriented crests. In this context it is diffcult to predict wind flow and orientation inside the 10-ha plot topography. We propose two explanation, hardwood could be selected for mechanical resistance in more disturbed souwhtwest oriented area or topography provoke a turbulences on northeast oriented areas responsible of more disturbance and death events in the forest history resulting in lightwood filtering [@larjavaara_rethinking_2010]. In both case it seems reasonable that canopy tree species are the most influenced by disturbance events linked to monsoon, and may even buffer the effect on understorey species.

Biotic factors, illustrated here by the canopy height and the basal area, also had a significant effect on the LES-based composition of understorey tree species. We indeed found higher SLA values and lower LDMC values in understorey assemblages that are located under stands characterized by a tall canopy and a high basal area. This results contrasts with the expectation that understorey species invest in higher LDMC for higher leaf lifespan, at the expense of SLA, unde light-limited conditions [@kitajima_tissue-level_2010]. The Uppangala forest is characterized by a large heterogeneity of canopy height allowing light to penetrate more in lower strata, maybe especially more in high canopy context covering less closely understorey, resulting in those observation on the leaf economics variation of understorey species. **Not convincing, better explanation ?**

## Limits and perspectives

Ecological strategies underline two economics spectra as shown by @baraloto_decoupled_2010. Whereas the multivariate analysis of our functional traits lack trait diversity, we were able to identify functional trade-offs. Measured traits were all morphological and from the leaf except for one. Anatomical and chemical traits as leaf vein patterns and leaf chemical content (N, P, K) could brought broader perspective on ecological strategies of Western Ghats species, more especially about investment in leaf ressource acquisition. Still the study reveal that few commonly used traits can highlight well known strategy axes.

Although significant patterns of trait-environment association have been detected in our study, the strength of these associations was weak in most cases (small $R^2$) and many associations were rejected by the null model. Studies highlighting environmental filtering effect often present a higher environmental variation than in our study site [@bernard-verdier_community_2012]. **To move in the previous part ?**. In parallel, the 10*ha plot scale is really low and partially responsible for the small environmental variation. @kraft_functional_2008 detected topographical filtering on functional trait and @gunatilleke_specieshabitat_2006 observed niche differentiation on 25 ha tropical forest plots including large flat valleys. This mid-low elevation study of functional traits from Western Ghats forest could be reproduced at higher elevation or in dryer areas as Eastern Ghats for better insight of environmental filtering at broad scale.

# *Acknowledgement*

* French Institute of Pondicherry (FIP)
* Cedric Vega for the extension of the plot

# Supplementary materials

## S1: Principal component analysis of topographical variables

```{r PCA Env}
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Supplementary material S1: Principal component analysis (PCA) performed on topgraphical variables. *Botom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 7 components (red line). SW stand for southwesterness.*

Curvature covaries with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Elevation and wetness are opposed in the principal component analysis and slope and south-westerness does not seem to covary much with other variables **Not precise**.

## S2: Linear models of the standardized effect size (SES) for each trait of GWMs, for canopy (C) and understorey (U) guilds, in presence-absence

```{r CWM PA}
kable(bold(CWM.ses.res[c(8:14,22:28),-2]), row.names = F)
```

Supplementary material S2: Linear models of the standardized effect size (SES) for each trait of GWMs, for canopy (C) and understorey (U) guilds, in presence-absence _We performed stepwise selection of the predictors including slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA), and only the selected predictors are shown. See table 1 for abbreviations. Bold and number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._
# References
