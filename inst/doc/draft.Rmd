---
title: 'Fine scale determinants of wood and leaf strategies in a low-elevation rainforest of India: vertical stratification reflects guild-dependent dynamics'
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output: pdf_document
csl: mee.csl
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
library(Uppangala)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

Built with `Uppangala` package version `r packageVersion('Uppangala')`.

# Abstract

## Keywords

functional trait; rainforest; dry season; forest strata; Western Ghats; ...

# Introduction

Understanding the determinants of species occurrence and co-occurrence is a long standing issue in ecology [@diamond_ecology_1975]. Tropical rainforests have especially fascinated standing issue in ecology [@connell_diversity_1978]. Two concurrent theories have been proposed to explain how species coexistence can be maintained in ecological communities. Niche theory states that the niche differences of species determine wether they can establish and coexist in communities [@weiher_assembly_1995; @lortie_rethinking_2004], while neutral theory shows that species coexistence is possible even when species are functionaly equivalent, under the sole influence of stochasticity in life, death, reproduction and dispersal [@hubbell_unified_2001]. Both theory can provide realistic expectations of taxonomic diversity [@chave_comparing_2002], and some recent approaches have advocated investigating patterns of functional [@westoby_land-plant_2006; @mcgill_rebuilding_2006] and phylogenetic diversity [@mouquet_ecophylogenetics:_2012] to trace the signature of ecological processes related to specific biological attributes and adaptations. 
These approaches have been applied to resolve the conundrum of high tree diversity in tropical forests [@kraft_functional_2010; @baraloto_using_2012; @hardy_phylogenetic_2012], but studies on these ecosystems still remain scarce. We here investigate taxonomic, functional and phylogenetic diversity in a low elevation rainforest of the Western Ghats biodiversity hotspot [@myers_biodiversity_2000], where no study has addressed the relative influence of neutral and niche-based dynamics on local forest composition.

The variation of functional traits among species reflect different abilities to grow, survive and reproduce in a given environment [@violle_let_2007]. These variation thus reflect fundamental trade-offs in ecological strategies along environmental gradients [@mark_westoby_plant_2002]. For instance, specific leaf area varies along a soil fertility-shade index and represent a trade-off between resource acquisition by photosynthesis and leaf investment in defense and leaf lifespan [@hodgson_is_2011]. Due to common ecological strategies, functional traits will covary along basic leaf [@wright_worldwide_2004] and wood [@chave_towards_2009] economic spectra. The leaf economic spectrum opposes productive ecological strategy to conservative persistent strategy. The wood economic spectrum distinguish species strategies over three axes spanning the basic CSR strategies of @grime_evidence_1977 : (i) competitive species, wiht high conductive efficiency, (ii) stress tolerant species, resistant to embolism, and (iii) disturbance tolerant species, with high mechanical strength. @baraloto_decoupled_2010 highlighted decoupled wood and leaf strategies allowing independant variation of these strategies, but @reich_world-wide_2014 conversely advocated that the two spectra have to integrated in a comprehensive whole plant economic spectrum [@freschet_evidence_2010] opposing fast growing species to more conservative ones. Here we address how varying wood and leaf ecological strategies determine species community assembly in an Indian rainforest. 

A major challenge in addressing community assembly is to relate local coexistence to a broader spatial context of species dynamics [@ricklefs_disintegration_2008; @munoz_neutral_2016]. Niche-based dynamics can entail community variation along broad environmental gradients, while local community dynamics can be neutral [@leibold_coexistence_2006]. Local community dynamics can further be influenced by niche differences under the influence of competition [@macarthur_limiting_1967]. In this perspective, @messier_trait_2016 have underlined that the significance of the leaf economic spectrum is basically scale-dependent, which can explain conflicting results across studies performed at different scales. In the same logic, a spatial hierarchy of ecological dynamics can entail a hierarchy of variation in functional traits from broad variation among species along large-scale environmental gradients, to intraspecific response to micro-environmental conditions at very fine scale [@albert_when_2011]. Therefore a multiscale framework is needed to represent the hierarchy of ecological processes from regional to local scale [@lortie_rethinking_2004]. Determining the extent of neutral and niche-based dynamics then implies (i) decomposing diversity patterns within and among communities [@ackerly_trait-based_2007], and (ii) designing appropriate statistical tests to disentangle the influence of local and larger-scale dynamics [@bernard-verdier_community_2012]. We will decompose diversity patterns in a large rainforest plot into sources of variation within and between communities [@kraft_disentangling_2011], and investigate the fine-scale and plot-scale dynamics using appropriate null models. For instance, @messier_trait_2016 argued the scale to which traits are covarying in ecological strategy, more especially they question the existence of the leaf economic spectrum at community scale.

Apart from scale-dependent dynamics in space whithin and among communities, ecological guilds can coexist and occupy distinct niches within communities, while the species within guilds are ecologically similar [@wilson_guilds_1999; @vergnon_niches_2009]. The neutral theory has been basically applied in rainforests to adress diversity patterns in the guild of canopy trees [@hubbell_unified_2001], thus ignoring dynamics of understorey trees. However basic ecological constraints drive resource use strategies and biotic interactions in this ecosystems and imply considering functional strategies and relationship among guilds as well. Low elevation rainforests in South India are remarkably heterogeneous in vertical structure and encompass distinctive guilds across the vertical strata [@pascal_wet_1988]. It thus provide an ideal context to analyze guild-dependent dynamics and ecological strategies in tropical rainforests. We will thus address diversity patterns and community assembly at guild-level.

In this paper, we used a trait-based approach to adress guild and community dynamics within and among local tree assemblages in a tropical rain forest from Western Ghats, India. Although of wet evergreen type, the forest undergoes a long dry season and an intense rainy season under the influence of monsoon. In this context, we expect water stress and competition for resource to be key drivers of forest dynamics. We thus adressed two main questions:

1. Do variations and covariations in functional traits reflect distinct ecological strategies within and among species ?
    i. Do and how functional traits vary among species ?
    ii. Do covariations in functional traits represent axes of ecological strategy within species ?
2. Does functional composition reflect the influence of local abiotic and biotic drivers of community dynamics ?
    i. Do local functional composition ($\alpha$ scale) reflect the influence of abiotic and biotic drivers of community dynamics ?
    ii. Do functional composition variation between communities ($\beta$ scale) reflect the changing of abiotic and biotic conditions ?

# Material and methods

## Study site

The study was carried out in a 10-ha permanent plot established in 1990 by the French Institute of Pondicherry of an undisturbed, old-growth wet evergreen Diptrocarp forest [@pascal_structure_1996]. The plot is located near Uppangala village ("Uppangala plot") in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India) in India's Western Ghats biodiversity hotspot. Climate is characterized by both heavy rainfall and very dry seasons. Annual precipitation averages 5108 mm per year with 90% between June and October during the monsoon, while the dry season (monthly rainfall $\leq 45$ mm) lasts on average 3.8 months [@pelissier_twenty_2011]. Mean annual temperature in the station of Sampaji (15 km from Uppangala) is about 27$^\circ C$, with a mean minimum about 25$^\circ C$ during July rainfall pick and a maximum mean temperature of 29$^\circ C$ in April [@pascal_structure_1996]. Climate and geology of the 10-ha plot can be considered as homogeneous. General topography of the site shows a regular east-west alternation between thalwegs and ridges separated by relatively steep slopes, so that topography can be assumed as a major source of environmental variation within the forest plot [@gimaret-carpentier_sampling_1998]. We hypothesized that topographic variation should influence community variation depending on tree ecological strategies [@condit_spatial_2000].

## Wood and leaf sampling

Since 1989, all trees $\geq 30$ cm girth at breast height (gbh) have been monitored in an area progressively extended to 10 ha in 2014. All trees were identified, tagged, mapped, and provided with permanent dendrometer bands censused every 2-5 years [@pelissier_twenty_2011]. 111 different species were recorded. We collected trait data on 89 over 111 (80.1%) species, which represented 99.0% of the tree individuals present in the Uppangala plot. With the 32 most abundant species, we reached  more than 80% of Uppangala tree individuals. We sampled five individuals per species for these species, and sampled one to five individuals of the less abundant and rare species (in total 267 individuals were sampled). For each individual we collected 5 mature shadow leaves and one branch sample with a diameter close to 1 cm following recommendation from @perez-harguindeguy_new_2013. Individuals and leaves were selected in consistent light conditions, development stage and sanitary state. Dawkins crown exposure index [@dawkins_management_1958] was assessed for each tree sampled. Leaf and branch samples were kept in humidified ziplock filled with enriched CO2 air inside a black bag untill their measurement in the following 24 hours. For some individuals, we were unable to collect an appropriate branch sample (11 missing species over 89 representing 1% of individuals present in the 10 ha plot).

## Trait measurements

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, area and thickness were measured, using a weighing scale, a bend scanner and a micrometer respectively. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 $^\circ C$. Once dried, the leaves were weighted directly after been extracted from the oven to avoid humidity bias. The bark and pit of branch samples were removed in order to keep only branch wood with no soft tissues. Branch wood samples were sink in water to evaluate their volume by water displacement. Samples were then dried for 48 hours at 80 $^\circ C$ and weighted. 

We calculated five functional traits of leaf and wood samples: leaf thickness (LT in $\mu m$ ), leaf area measured from scans (LA in $mm^2$), leaf dry matter content as the leaf dry weight divided by the leaf fresh weight (LDMC in $mg.g^-1$), specific leaf area as the leaf area divided by the leaf dry mass (SLA in $m^2.kg^-1$), and branch wood density  as the the wood sample dry weight divided by its volume (WD in $g.cm^-3$, see table 1). **Justify trait choice**.

Table 1: Functional traits measured. *Traits with their abbreviation, range of values in the sampling, mean and standard deviation, standard unit, and associated trade-off in tree strategy for functionning, survival and reproduction from @baraloto_decoupled_2010.*

```{r 1 Traits}
rm(list = ls()[-which(ls() == "cores")]); invisible(gc())
PFT <- genPFT()
table <- data.frame(
  Trait = c('Leaf thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  Abbreviation = c('LT', 'LA', 'LDMC', 'SLA', 'WD'),
  Range = c(paste(range(PFT$LT, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  m = c(paste0(round(mean(PFT$LT, na.rm = T)), ' (',
                         round(sd(PFT$LT, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
  s = c('Leaf defense vs. investment',
               'Leaf resource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf resource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
names(table)[c(4,6)] <- c('Mean (sd)', 'Trade-off')
kable(table, row.names = F)
rm(table)
```

## Environmental variables

We selected 8 topographical variables representing the abiotic environment: elevation, slope, curvature, plan curvature, profile curvature, wetness (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west: $cos(aspect~in~degres + 225)$) derived from the digital elevation model using the RSAGA package [@brenning_statistical_2008], and distance to the nearest potential river computed using ArcGis [@desktop_arcgis_2011]. Digital elevation model was provided by a 2013 LIDAR campaign on Uppangala plots with a resolution of $1*1 m^2$. **Justify variable choice**.

In order to identify the main sources of environmental variation and to avoid multi-colinearity in subsequent analyses, we performed a principal component analysis (PCA) of the environmental variables. We selected the less correlated variables with the most ecological meaning. Thus we reduced our explanatory variables to 4 variables: curvature representing the water flow paths and soil accumulation areas, wetness highlighting water accumulation areas, southwesterness representing aspect [@bunyan_effect_2015] and slope.

We selected two biotic factors related to local forest structure: canopy height and basal area. Canopy height was calculated from a digital canopy model built with the 2013 LIDAR campaign on Uppangala plots with resolution $1*1 m^2$. Basal area was calculated from 2013 girth inventory of Uppangala plot on stems with a diameter above 10 centimeters at breast height ($DBH>10~cm$). 

## Analyses

### Traits variation and covariation

The coefficient of variation of traits was investigated at three levels ($cv = \frac{\sigma}{\mu}$ with $\sigma$ the standard deviation and $\mu$ the mean): between leaves of the same individual (intra-individual), between trees of the same species (intra-specific for species with more than one individual), and between species (inter-specific). In addition, we performed a principal component analysis (PCA) of the mean value of traits per species, to characterize basic dimensions of ecological strategies. Subsequent community-level analysis were based on trait values averaged per species.

### Community trait variability

Across the whole 10 hectare plot, $20*20 m^2$ quadrats were defined and represented 240 local communities. To investigate local functional composition of communities we used community weighted means (CWM), community weighted variances (CWV), and coefficients of variation from the nearest neighbour distance (CVNND) [CWM and CWV, sensu @violle_let_2007; CVNND, @jung_intraspecific_2010]. CWM for each trait $t$ was calculated as the mean of species trait values, $t_{i}$, of the $S$ species in each community, with each species, $i$, weighted by its relative abundance, $p_{i}$:
$$CWM = \sum_{i=1}^{S} p_{i} * t_{i} ~ (1)$$
We also calculated the average of trait values based on species presence-absence, to further emphasize the contribution of rare species in community trait distribution [@cingolani_filtering_2007]. CWV for each trait $t$ was calculated as the mean distance of trait values, $t_{i}$, to $CWM$, of the $S$ species in each community, with each species, $i$, weighted by its relative
abundance, $p_{i}$:
$$CWV = \sum_{i=1}^{S} p_{i} * (t_{i} - CWM)^2 ~ (2)$$
CVNND for each trait $t$, scaled with its mean and variance, was calculated as nearest neigbor distances (NND) standard deviation, $\sigma _{NND}$, of the $i$ individuals in each community, divided by its mean, $\mu _{NND}$; and NND for one individual $i$ is calculated as the minimal distance $d$ between the $j$ other individuals of the community :
$$CVNND = \frac{\sigma _{NND}}{\mu _{NND}} ~ , ~ ~ ~ NND = [NND_{i} = min(d_{i,j})_{i \neq j}] ~ (3)$$

To investigate functional composition of communities we used a null model approach. A first null model (NM1) randomized trait values among species in the whole plot (permuting raw in `Trait*Species` matrix). The second model (NM2) randomized abundances among species within each community but kept the observed list of species and trait values inside communities [@bernard-verdier_community_2012]. Linear regressions between CWMs and biotic and abiotic factors ($CWM_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$), after stepwise selection, were compared to corresponding 999 null linear regressions from NM1 with F-statistic. For both CWV and CVNND, we performed a two-tailed test of the proportion of of communities differing from null expectation with adjusted p-values by Benjamini-Hochberg correction. CWV lower than expected under a null model represented convergence of trait values within the community, whereas CWV higher than null evidenced divergence in trait distribution [@bernard-verdier_community_2012]. CVNND was used to detect niche differentiation among coexisting species, which occured when the observed CVNND was lower than under a null model [@jung_intraspecific_2010]. We then calculated the standardized effect size (SES) as: $$SES = \frac{(I_{obs} - I_{null})}{\sigma _{null}} (4)$$
where $I_{obs}$ was the observed metric and $I_{null}$ and $\sigma _{null}$ were the mean and standard deviation of null distributions of NM2 and NM1 for CWV and CVNND respectively.
The influence of environment on SES values was investigated by linear regression with biotic and abiotic factors ($SES_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$). Analyses were conducted on the five functional traits and the species scores obtained on the 2 first PCA axes.

### Taxonomic, functional and phylogenetic variation among communities

A phylogenetic tree of our 89 species was built with `S.PhyloMaker` function proposed by @qian_updated_2016-1. We assessed phylogenetic signal of each functional using the Moran's I statistic. Positive Moran's I value indicated convergence of trait values within the phylogeny whereas negative Moran's I will showed divergence.

To investigate taxonomic, functional, and phylogenetic variation among communities we calculated $I_{st}$, for taxonomic composition, $U_{st}$ and $\tau _{st}$, for functional composition in abundance and presence-absence respectively, and $\beta _{st}$ and $\pi _{st}$, for phylogenetic composition in abundance and presence-absence respectively [@hardy_characterizing_2007]. **Develop indices**.

Variation of composition between community pairs with those metrics was translated as a taxonomic, functional and phylogenetic distance, and compared to environmental and spatial distances among community pairs. Environmental distances were calculated as geometric distances between communities on the plan composed by the two first axes of environmental variables PCA (see supplementary material S1). Correlations with environment and space were assessed based on two Mantel tests successively with taxonomic, functional, and phylogenetic community compositions. A firt Mantel statistic assessed the correlation between each metric distance matrix and the environmental distance matrix (E). The second partial Mantel statistic assessed the correlation between each metric distance matrix and the spatial distance matrix knowing environmental distance matrix (E|S), to represent remaining spatial dependency in community composition once the influence of environmental variation is taken into account.

We used null models to test if observed correlation with Mantel statistic differed significantly from expectations under null hypothesis. $I_{st}$ correlation to environment and space was tested with 999 repetions of the model nul described by @myers_beta-diversity_2013 which randomizes individuals among subplots while preserving the regional abundance of species, and the number of individuals per community. $U st$ and $\tau st$ were tested by the nul model NM1 which randomizes traits among species. Finally $\beta st$ and $\pi st$ were tested against the nul model *"1s"* suggested by @hardy_testing_2008 which randomizes phylogenetic tree tips. **One global null model section ?**


All analysis were conducted using the R 3.3.0  software environment [@r_core_team_r:_2016] with packages 
`ade4` [@dray_ade4_2007], 
`ape` [@paradis_ape:_2004], 
`phylosignal` [@keck_phylosignal:_2015], 
`spacodiR` [@eastman_spacodir:_2013],
and `vegan` [@oksanen_vegan:_2016].

# Results

## Traits variation and covariation

We found a general increase of functional trait variation from intra-individual to inter-specific level (see table 2). Whereas LA shows already high variabililty at intra-individual level almost as strong as the intra-specific variation ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). **Conclude on low $cv_{intra}$ justifying species mean trait**. **Give Species example of extreme range and compare to litterature**.

Table 2: Coefficient of intra-individual, intra-specific and inter-specific trait variation. *Mean of coefficient of variation for leaves in all individuals (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.* **Move range, mean and sd columns here*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$Sp
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$SpCode
names(SpCode) <- SpCodeT$Sp
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$Sp <- Sp[row.names(PFT_ind)]
PFT_ind$SpCode <- SpCode[as.character(PFT_ind$Sp)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('LT', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$Sp), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
rm(PFT, CET, cv, CE, Sp, SpT)
```

The principal component analysis (PCA) shows WD associated with structural leaf traits orthogonal to the SLA (figure 1). The first PCA axis (PCA1) covary mainly with LT, LDMC and WD; opposing thick big leaves and lightwood to dense leaves and hardwood. PCA1 axis associated WD to leaf structural traits linked to hydraulic conductive efficiency along the wood economic spectrum [WES, @chave_towards_2009]. The PCA2 covaried mainly positively with SLA and negatively with LDMC along a leaf economic spectrum [LES, @wright_worldwide_2004]. **Develop productive against persistent strategy**. **High WD LDMC relation indicating structural investment**.

```{r 3 PCA PFT}
library(vegan)

PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
pca <- princomp(~ LA + WD + LT + LDMC + SLA, data = PFT_sp, cor = T)

lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
      xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
rm(PCAscores, PFT_ind, SpCodeT, lambda, pca, pca.var, Rot, XLIM)
```

Figure 1: Principal Component Analysis (PCA) performed on species mean traot values. *The bottom right subplot represents the eigen values (grey bars) compare to a broken stick distribution for 5 components (red line). See table 1 for abbreviation.*

```{r 4 env-com}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats()
XY <- Trees[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'))
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
BA <- aggregate(Trees$Girth, list(Trees$com), function(x){sum(pi*(x/(2*pi))^2, na.rm = T)})
com@data$BA <- BA$x[match(com@data$id, BA$Group.1)]
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SW, data = com@data, cor = T)
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')]
row.names(Q) <- PFT_sp$SpCode
sel <- which(Species$Strata[match(PFT_sp$SpCode, Species$SpCode)] %in% c('ESI', 'ESII'))
Q <- list(C = Q[sel,], U = Q[-sel,])
sel <- lapply(Q, function(q){intersect(row.names(q), names(L))})
Q <- mapply(function(q,s){q[s,]}, q = Q, s = sel, SIMPLIFY = F)
L <- lapply(sel, function(s){L[s]})
R <- lapply(L, function(l){R[row.names(l),]})
L <- lapply(L, function(l){list(abundance = l, `presence-absence` = l)})
L <- lapply(L, function(l){l$`presence-absence`[l$`presence-absence` > 1]  <- 1 ; return(l)})
rm(Deriv, XY, Env, sel, BA)
```

## Functional composition of local communities

Community weighted means (CWM), for both abundant and rare species, showed some significant variations along environmental gradients (see table 3). Community mean values of WD significantly increased under south-west direction, both in abundance and presence-absence CWM,  whereas SLA and LA, in presence-absence only, decreased with curvature. In addition, LDMC in presence-absence was decreasing with canopy height. **Develop meaning of AB et PA, specifically in term of species**.

Table 3: Summary of linear models of community-level trait values. _The results are shown for either CWM values weighted either by species relative abundance (AB) or in presence-absence (PA) after stepwise selection of the predictors including slope, curvature, wetness, southwesterness (SW), canopy height (Canopy) and basal area (BA). Global and partial F-statistics of final models were compared to statistics of 999 null linear regressions built with null model NM1, which randomizes traits among species. See table 1 for abbreviations. The number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWM}
# Observed CWMs
CWM <- mapply(function(Ls,Qs){
  lapply(Ls, function(l){
    lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
      apply(l, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)
CWM <- lapply(CWM, function(s){
  lapply(s, function(x){
    names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(x)
  })
})
## Regressions
CWM.lm <- mapply(function(CWMs, Rs){
  lapply(CWMs, function(p){
    lapply(p, function(t){
      lm(t ~., Rs)
    })
  })
}, CWMs = CWM, Rs = R, SIMPLIFY = F)
CWM.lm <- mapply(function(s, Rs){
  lapply(s, function(p){
    lapply(p, function(t){
      step(t, direction = 'both', trace = 0)
    })
  })
}, s = CWM.lm, Rs = R, SIMPLIFY = F)
## Global F
Fval <- lapply(CWM.lm, function(s){
  lapply(s, function(y){
    lapply(y, function(x){
      summary(x)$fstatistic['value']
    })
  })
})
Fval <- lapply(Fval, function(s){
  lapply(s, function(x){
    do.call('rbind.data.frame', x)
  })
})
Fval <- lapply(Fval, function(s){
  s <- data.frame(s)
  names(s) <- names(CWM.lm$C)
  return(s)
})
Fval$U <- Fval$U[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT'),]
## Partial F
pFval <- lapply(CWM.lm, function(s){
  lapply(s, function(y){
    lapply(y, function(x){
      car::Anova(x)['F value']
    })
  })
})

# Simulated CWMs
n = 999
nQ <- lapply(Q, function(s){
  rep(list(s), n)
})
nQ <- lapply(nQ, function(s){ 
  lapply(s, function(nq){
      row.names(nq) <- sample(row.names(nq))
      return(nq)
  })
})
nQ <- mapply(function(nQs, Ls){
  lapply(nQs, function(nq){
    nq[names(Ls$abundance),]
  })
}, nQs = nQ, Ls = L, SIMPLIFY = F)
cl <- makeCluster(cores)
clusterExport(cl, list('L', 'nQ'))
nCWM <- clusterMap(cl, function(nQs, Ls){
  lapply(nQs, function(nq){
    lapply(Ls, function(l){
      lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')), function(v){
        apply(l, 1, function(x){
          weighted.mean(nq[,v], x, na.rm=T)
        })
      })
    })
  })
}, Ls = L, nQs = nQ)
stopCluster(cl)
rm(cl)
nCWM <- lapply(nCWM, function(s){
  lapply(s, function(ns){
  lapply(ns,function(ab){
    names(ab) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')
    return(ab)
    })
  })
})
## Regressions
nCWM.lm <- mapply(function(CWM.lms, nCWMs, Rs){
  lapply(nCWMs, function(ncwm){
    mapply(function(CWM.lmab, ncwmab){
      mapply(function(CWM.lmt, ncwmt){
        lm(formula(paste0('ncwmt ~ ', as.character(CWM.lmt$terms)[3])), cbind(ncwmt,Rs))
      }, CWM.lmt = CWM.lmab, ncwmt = ncwmab, SIMPLIFY = F)
    }, CWM.lmab = CWM.lms, ncwmab = ncwm, SIMPLIFY = F)
  })
}, CWM.lms = CWM.lm, nCWMs = nCWM, Rs = R, SIMPLIFY = F)
rm(nCWM)
invisible(gc())
## Global F
nFval <- lapply(nCWM.lm, function(nCWM.lms){
  lapply(nCWM.lms, function(lm){
    lapply(lm, function(y){
      lapply(y, function(x){
        summary(x)$fstatistic['value']
      })
    })
  })
})
nFval <- lapply(nFval, function(x){
  lapply(x, `[`, names(x[[1]]))
  apply(do.call(rbind, x), 2, as.list)
})
nFval <- lapply(nFval, function(s){
  lapply(s, function(x){
    lapply(x, `[`, names(x[[1]]))
    apply(do.call(rbind, x), 2, as.list)
  })
})
nFval <- lapply(nFval, function(s){
  lapply(s, function(ab){
    lapply(ab, unlist)
  })
})
pval <- mapply(function(Fvals, nFvals){
  1 -  mapply(function(Fvalab, nFvalab){
    mapply(function(Fvalt,nFvalt){
      if(!is.na(Fvalt))
        rank(c(Fvalt, nFvalt))[1]/(n+1)
      else
        NA
    }, Fvalt = Fvalab, nFvalt = nFvalab)
  }, Fvalab = lapply(as.list(Fvals), as.list), nFvalab = nFvals)
}, Fvals = Fval, nFvals = nFval, SIMPLIFY = F)
pval <- lapply(pval, function(s){
  row.names(s) <- row.names(Fval$C)
  return(s)
})
rm(Fval, nFval)
# Partial F
npFval <- lapply(nCWM.lm, function(s){
  lapply(s, function(lm){
    lapply(lm, function(y){
      lapply(y, function(x){
        car::Anova(x)['F value']
      })
    })
  })
})
npFval <- lapply(npFval, function(x){
  lapply(x, `[`, names(x[[1]]))
  apply(do.call(rbind, x), 2, as.list)
})
npFval <- lapply(npFval, function(s){
  lapply(s, function(x){
    lapply(x, `[`, names(x[[1]]))
    apply(do.call(rbind, x), 2, as.list)
  })
})
npFval <- lapply(npFval, function(s){
  lapply(s, function(ab){
    lapply(ab, function(t){
      do.call('cbind', t)
    })
  })
})
ppval <- mapply(function(pFvals, npFvals){
  mapply(function(x,y){
    mapply(function(r,s){
      mapply(function(p,q){
        rank(c(p,q))[1]/(n+1)
      }, p = as.list(data.frame(t(r))), q = as.list(data.frame(t(s))))
    }, r = x, s = y)
  }, x = pFvals, y = npFvals, SIMPLIFY = F)
}, pFvals = pFval, npFvals = npFval, SIMPLIFY = F)
ppval <- lapply(ppval, function(s){
  lapply(s, function(y){
    lapply(y, function(x){
      data.frame(t(x))
    })
  })
})
ppval <- lapply(ppval, function(s){
  lapply(s, function(y){
    data.frame(data.table::rbindlist(y, fill = T))
  })
})
ppval <- lapply(ppval, function(s){
  lapply(s, function(y){
    row.names(y) <- names(CWM.lm$C$abundance)
    return(y)
  })
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
ppval <- lapply(ppval, function(s){
  lapply(s, function(ab){
    ab[,setdiff(var, names(ab))] <- NA
    ab <- ab[var]
    return(ab)
  })
})
ppval <- lapply(ppval, function(s){
  lapply(s, function(x){
    1 - x
  })
})
rm(pFval, npFval)

# Result tables
reg <- paste('~', paste(names(R$C), collapse = ' + '))
res <- mapply(function(CWM.lms, pvals, ppvals){
  mapply(function(CWM.lmab, pvalab, ppvalab){
    regression_table(CWM.lmab, reg, pvalab, ppvalab)
  }, CWM.lmab = CWM.lms, pvalab = as.list(data.frame(pvals)), ppvalab = ppvals, SIMPLIFY = F)
}, CWM.lms = CWM.lm, pvals = pval, ppvals = ppval, SIMPLIFY = F)
res <- lapply(res, function(s){
  mapply(function(ab, name){
    ab <- cbind(c(name, rep(' ', length(ab[,1])-1)), ab)
    names(ab)[1] <- 'Type'
    return(ab)
  }, ab = s, name = as.list(c('AB', 'PA')), SIMPLIFY = F)
})
res <- lapply(res, function(s){
  do.call('rbind', s)
})
res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'Strata'
  return(s)
}, s = res, name = as.list(c('C', 'U')), SIMPLIFY = F)
res <- do.call('rbind', res)
kable(bold(res), row.names = F)
rm(CWM.lm, nCWM.lm, pval, ppval, reg, res) ; invisible(gc())
```

Traits convergence/divergence was measured with community weighted variances (CWV). Overall, observed CWVs did not differ from null expectations for all traits. We could found significant relationships between standardized effect size (SES) of CWVs and environmental variables (see table 4). Convergence of LES and LDMC and divergence of LA were found under south-west orientation. LA and LDMC values also diverged in communities with increasing curvature. Observed CVNNDs did not reveal niche differentiation among communities for all traits. But we also found significant relationships of their standardized effect size (SES) of CVNNDs with environmental variables (see table 4). niche differentiation of LA increased in lower curvature and wetness contexts, while differentiation of WD decreased in southwest orientation.

Table 4: Summary of linear models of traits standardized effect size (SES) of CWVs and CVNNDs. _Linear regression results for each trait SES of CWVs and CVNNDs after stepwise selection of the predictors oncluding slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. The number of asterisk indicates the significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWV}
# Observed CWVs
CWV <- mapply(function(Qs, CWMs, Ls){
  lapply(names(CWMs$abundance), function(v){
    apply(cbind(data.frame(CWMs$abundance[[which(names(CWMs$abundance) == v)]]),Ls$abundance), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, Qs = Q, CWMs = CWM, Ls = L, SIMPLIFY = F)
CWV <- lapply(CWV, function(s){
  names(s) <- names(CWM$C$abundance)
  return(s)
})

# Simulated CWVs 
nL <- list(C = rep(list(L$C$abundance), n),
           U = rep(list(L$U$abundance), n))
nL <- lapply(nL, function(s){
  lapply(s,function(l){
    apply(l, 1, function(x){
      x[x != 0] <- sample(x[x != 0])
      return(x)
    })
  }) 
})
nL <- lapply(nL, function(s){
  lapply(s, function(x){
    t(x)
  })
})
nL <- lapply(nL, function(s){
  lapply(s, data.frame)
})
cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'CWM', 'Q'))
nCWM.cwv <- clusterMap(cl, function(nLs, CWMs, Qs){
  lapply(nLs, function(nl){
    lapply(as.list(names(CWMs$abundance)), function(v){
      apply(nl, 1, function(x){
        weighted.mean(Qs[,v], x, na.rm=T)
      })
    })
  })
}, nLs = nL, CWMs = CWM, Qs = Q, SIMPLIFY = F)
stopCluster(cl)
nCWM.cwv <- lapply(nCWM.cwv, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
nCWV <- mapply(function(nLs, nCWM.cwvs, Qs){
  mapply(function(l,cwm){
  lapply(names(CWM$C$abundance), function(v){
    apply(cbind(data.frame(cwm[[which(names(cwm) == v)]]),l), 1, function(x){
      sqrt(weighted.mean((Qs[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, l = nLs, cwm = nCWM.cwvs, SIMPLIFY = F)
}, nLs = nL, nCWM.cwvs = nCWM.cwv, Qs = Q, SIMPLIFY = F)
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
    names(x) <- names(CWM$C$abundance)
    return(x)
  })
})
rm(nCWM.cwv, cl, nL)
invisible(gc())
## Non null CWVs
nCWV <- lapply(nCWV, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCWV <- lapply(nCWV, function(s){
  lapply(s, function(x){
    do.call('cbind', x)
  })
})
nCWV <- lapply(nCWV, function(s){
  lapply(s, data.frame)
})
CWV.pval <- mapply(function(CWVs, nCWVs){
  data.frame(
  mapply(function(x,y){
    mapply(function(p,q){
      rank(c(p,q))[1]/(n+1)
    }, p = as.list(x), q = as.list(data.frame(t(y))))
  }, x = CWVs, y = nCWVs)
)
}, CWVs = CWV, nCWVs = nCWV, SIMPLIFY = F)
CWV.pval.res <- lapply(CWV.pval, function(s){
  data.frame(
    inf = apply(apply(s, 2, p.adjust, method = 'fdr'), 2, function(x){
      length(which(x < 0.025))/length(x)
    }), 
    sup = apply(apply(1 - s, 2, p.adjust, method = 'fdr'), 2, function(x){
      length(which(x < 0.025))/length(x)
    }))
})
## CWV SES
CWV.ses <- mapply(function(CWVs, nCWVs){data.frame(
  mapply(function(x,y){
    mapply(function(p,q){
      (p - mean(q))/sd(q)
    }, p = as.list(x), q = as.list(data.frame(t(y))))
  }, x = CWVs, y = nCWVs)
)}, CWVs = CWV, nCWVs = nCWV, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    lm(y ~., Rs)
  })
}, s = CWV.ses, Rs = R, SIMPLIFY = F)
CWV.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(x){
    step(x, direction = 'both', trace = 0)
  })
}, s= CWV.ses.lm, Rs = R, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, data.frame)
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CWV.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CWV.ses.res <- mapply(function(s, CWV.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CWV.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CWV.ses.res, CWV.ses.lms = CWV.ses.lm, SIMPLIFY = F)
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
CWV.ses.res <- lapply(CWV.ses.res, function(s){
  sel <- which(unlist(lapply(as.list(data.frame(t(s))), function(t){
  any(grepl('*', t, fixed = T))
})))
  return(s[sel,])
})
CWV.ses.res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'Strata'
  return(s)
}, s = CWV.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CWV.ses.res <- do.call('rbind', CWV.ses.res)
rm(CWV.pval, CWV.pval.res, CWV.ses.lm, nCWV)
```

```{r CVNND}
# Observed CVNND
CVNND <- mapply(function(Ls, Qs){
  apply(Ls$abundance, 1, function(l){
  apply(Qs, 2, function(q){
    cati::CVNND(rep(q, l), na.rm = T)
    })
  })
}, Ls = L, Qs = Q, SIMPLIFY = F)

# Simulated CVNNDs 
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L'))
nCVNND <- clusterMap(cl, function(nQs, Ls){ 
  lapply(nQs, function(x){
    apply(Ls$abundance, 1, function(l){
      apply(x, 2, function(q){
        cati::CVNND(rep(q,l), na.rm = T)
      })
    })
  })
}, nQs = nQ, Ls = L)
stopCluster(cl)
rm(cl, nQ)
invisible(gc)

## Non null CVNNDs
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(x){
    as.list(data.frame(t(x)))
  })
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(x){
    lapply(x, function(y){
      names(y) <- colnames(CVNND$C)
      return(y)
    })
  })
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, `[`, names(s[[1]]))
  apply(do.call(rbind, s), 2, as.list)
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, function(x){
    do.call('cbind', x)
  })
})
nCVNND <- lapply(nCVNND, function(s){
  lapply(s, data.frame)
})
CVNND.pval <- mapply(function(CVNNDs, nCVNNDs){
  data.frame(
    mapply(function(x,y){
      mapply(function(p,q){
        rank(c(p,q))[1]/(n+1)
      }, p = as.list(x), q = as.list(data.frame(t(y))))
    }, x = as.list(data.frame(t(CVNNDs))), y = nCVNNDs)
  )
}, CVNNDs = CVNND, nCVNNDs = nCVNND, SIMPLIFY = F)
CVNND.pval <- lapply(CVNND.pval, function(s){
  row.names(s) <- colnames(CVNND)
  apply(s, 2, p.adjust, method = 'fdr')
  return(s)
})
CVNND.pval.res <- lapply(CVNND.pval, function(s){data.frame(
  inf = apply(s, 2, function(x){
    length(which(x < 0.05))/length(x)
  })
)})
CVNND.pval.res <- do.call('cbind', CVNND.pval.res)
names(CVNND.pval.res) <- names(CVNND.pval)
print(round(CVNND.pval.res, 3))

## CVNND SES
CVNND.ses <- mapply(function(CVNNDs, nCVNNDs){
  data.frame(
    mapply(function(x,y){
      mapply(function(p,q){
        (p - mean(q))/sd(q)
      }, p = as.list(x), q = as.list(data.frame(t(y))))
    }, x = as.list(data.frame(t(CVNNDs))), y = nCVNNDs)
  )
}, CVNNDs = CVNND, nCVNNDs = nCVNND, SIMPLIFY = F)
CVNND.ses <- lapply(CVNND.ses, function(s){
  row.names(s) <- colnames(CVNND)
  return(s)
})
CVNND.ses.lm <- mapply(function(s, Rs){
  apply(s, 2, function(y){
    lm(y ~., Rs)
  })
}, s = CVNND.ses, Rs = R, SIMPLIFY = F)
CVNND.ses.lm <- mapply(function(s, Rs){
  lapply(s, function(x){
    step(x, direction = 'both', trace = 0)
  })
}, s= CVNND.ses.lm, Rs = R, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.lm, function(s){
  lapply(s, function(x){
    summary(x)$coefficients
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, data.frame)
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  lapply(s, function(x){
    x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   '))
    return(x)
  })
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  data.frame(data.table::rbindlist(lapply(s, function(x){
    data.frame(t(x[5]))
  }), fill = T))
})
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s[,setdiff(var, names(s))] <- NA
  s <- s[var]
  s <- apply(s, 2, as.character)
  row.names(s) <- names(CVNND.ses$C)
  s[is.na(s)] <- ''
  s <- data.frame(s)
  return(s)
})
CVNND.ses.res <- mapply(function(s, CVNND.ses.lms){
  s$`$R^2$` <- round(unlist(lapply(CVNND.ses.lms, function(x){
    summary(x)$r.squared
  })),3)
  return(s)
}, s = CVNND.ses.res, CVNND.ses.lms = CVNND.ses.lm, SIMPLIFY = F)
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  s <- cbind(row.names(s), s)
  names(s)[1] <- 'Trait'
  return(s)
})
CVNND.ses.res <- lapply(CVNND.ses.res, function(s){
  sel <- which(unlist(lapply(as.list(data.frame(t(s))), function(t){
  any(grepl('*', t, fixed = T))
})))
  return(s[sel,])
})
CVNND.ses.res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'Strata'
  return(s)
}, s = CVNND.ses.res, name = as.list(c('C', 'U')), SIMPLIFY = F)
CVNND.ses.res <- do.call('rbind', CVNND.ses.res)
rm(CVNND.pval, CVNND.pval.res, CVNND.ses.lm, nCVNND)
invisible(gc())
```

```{r CWV & CVNND table}
res <- list(CWV = CWV.ses.res, CVNND = CVNND.ses.res)
res <- mapply(function(s, name){
  s <- cbind(c(name, rep(' ', length(s[,1])-1)), s)
  names(s)[1] <- 'Type'
  return(s)
}, s = res, name = as.list(c('CWV', 'CVNND')), SIMPLIFY = F)
res <- do.call('rbind', res)
kable(bold(res), row.names = F)
rm(CWV.ses.res, CVNND.ses.res, res)
```

## Taxonomic, functional and phylogenetic varitions among communities

Taxonomic variation among communities was correlated significantly to environment variation (Mantel test, $r_{I_{st},E} = 0.23$ with $p-value < 0.001$), but not with remaining spatial dependency in community composition (Mantel test of space knowing environment, $r_{I_{st},S|E} = 0.01$ with $p-value > 0.1$).

Overall, the global functional variation among communities was neither correlated to environment nor to spactial distance knowing the environment effect (see table 5). However, the variation of WD, in abundance as well as in presence absence, was positively correlated to environmental variation and is negatively correlated in presence absence to the spatial structure knowing environment spatial effect. 

While LDMC did not phylogenetic structure (Moran's I of 0 with a $p-value > 0.1$), LA and LT were phylogenetically clustered (Moran's I of 0.021 and 0.018 with a $p-value < 0.001$), and WD and SLA were weakly clustered (Moran's I of 0.005 and 0.003 with $p-value < 0.1$). Phylogenetic variation among communities was neither correlated to environmental variation (Mantel test, $r_{\beta_{st},E} = 0.02$ and $r_{\pi_{st},E} = 0.05$ with $p-value > 0.1$) nor to remaining spatial variation in partial Mantel test knowing environment ($r_{\beta_{st},S|E} = 0.01$ and $r_{\pi_{st},S|E} = -0.01$ with $p-value > 0.1$).

```{r Ist}
library(spacodiR)

# R,L,Q wihtout strata
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'LT')]
row.names(Q) <- PFT_sp$SpCode
sel <- intersect(row.names(Q), names(L))
Q <- Q[sel,]
L <- L[sel]
R <- R[row.names(L),]
L <- list(abundance = L, `presence-absence` = L)
L$`presence-absence`[L$`presence-absence` > 1]  <- 1
rm(com, Trees)
invisible(gc())

# Environmental matrices
XY <- data.frame(as(quadrats(), 'SpatialPoints')@coords)
row.names(XY) <- paste0('C',row.names(XY))
XY <- XY[row.names(L$abundance),]
Ms <- dist(XY)
XY <- pca.env$scores[,1:2]
row.names(XY) <- paste0('C',row.names(XY))
XY <- XY[row.names(L$abundance),]
Me <- dist(XY)
rm(XY)

# Observed Ist
spaflo <- spacodi.calc(sp.plot = t(L$abundance), pairwise = T)$'pairwise.Ist'
## Mantel values
spaflo.mantel <- list(`E` = vegan::mantel(spaflo, Me, permutations = 0)$statistic, 
                      `S | E`= vegan::mantel.partial(spaflo, Ms, Me, permutations = 0)$statistic)

# Simulated mantel
nL <- vegan::permatfull(L$abundance, fixedmar = 'both', mtype = 'count', times = n, shuffle = 'both')
cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'spacodi.calc', 'Me', 'Ms'))
nspaflo <- lapply(nL$perm, function(l){spacodi.calc(sp.plot = t(l), pairwise = T)$'pairwise.Ist'})
nspaflo.mantel <- lapply(nspaflo, function(ns){
  list(`E` = vegan::mantel(ns, Me, permutations = 0)$statistic, 
       `S | E`= vegan::mantel.partial(ns, Ms, Me, permutations = 0)$statistic)})
stopCluster(cl)
rm(cl, nL) ; invisible(gc())
## Non null mantels
nspaflo.mantel <- lapply(nspaflo.mantel, `[`, names(nspaflo.mantel[[1]]))
nspaflo.mantel <- apply(do.call(rbind, nspaflo.mantel), 2, as.list)
nspaflo.mantel <- lapply(nspaflo.mantel, unlist)
spaflo.res <- mapply(function(s, ns){
    paste(format(s, scientific = T, digits = 3),
          Uppangala::stars(min(1-rank(c(s,ns))[1]/(n+1),rank(c(s,ns))[1]/(n+1)), ns = '   '))
}, s = spaflo.mantel, ns = nspaflo.mantel)
spaflo.res <- data.frame(spaflo.res)
names(spaflo.res) <- c('$I_{st}$')

# Result
# kable(bold(spaflo.res))
rm(mtest, spaflo.mantel, nspaflo, nspaflo.mantel, spaflo.res)
```

Table 5: Summary of Mantel tests between functional composition, environment and spatial distances between communities. _$U st$ and $\tau st$ metric proposed by @hardy_characterizing_2007 were used to measure functional composition variation among communities. Observed values were compared to null values obtained with model NM1 randomizing traits among species (permuting raw in `Trait*Species` matrix). E is the Mantel test of this metric according to the environmental distance derived from communtiy scores in the environmental PCA (two first axes). S|E is the partial Mantel test of this metric according to spatial distance conditionally to environment variation. The number of asterisk indicates significance threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Ust & TAUst}
# nQ without strata
n = 999
nQ <- rep(list(Q), n)
nQ <- lapply(nQ, function(x){row.names(x) <- sample(row.names(x)) ; return(x)})
nQ <- lapply(nQ, function(x){x[names(L$abundance),]})

# Observed Hardys
spafun <- lapply(as.list(1:length(Q)), function(i){
  if (length(which(is.na(Q[i]))) > 0) {
    sel <- intersect(names(L$abundance), row.names(Q[-which(is.na(Q[i])),]))
    return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(Q[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
  } else {
    return(spacodi.calc(sp.plot = t(L$abundance), sp.traits = Q, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
  }
})
names(spafun) <- names(Q)
## Mantel values
spafun.mantel <- lapply(spafun, function(t){list(`E` = lapply(t, function(M){vegan::mantel(M, Me, permutations = 0)$statistic}), `S | E` = lapply(t, function(M){vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic}))})


# Simulated mantel
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L', 'Me', 'Ms', 'spacodi.calc'))
nspafun.mantel <- clusterApply(cl, nQ, function(q){
  s <- lapply(as.list(1:length(q)), function(i){
    if (length(which(is.na(q[i]))) > 0) {
      sel <- intersect(names(L$abundance), row.names(q[-which(is.na(q[i])),]))
      return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(q[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    } else {
      return(spacodi.calc(sp.plot = t(L$abundance), sp.traits = q, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    }
  })
  names(s) <- names(q)
  res <- list(
    `E` = lapply(s, function(t){
      lapply(t, function(M){
        try(vegan::mantel(M, Me, permutations = 0)$statistic)
        })
      }),
    `S | E` = lapply(s, function(t){
      lapply(t, function(M){
        try(vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic)
        })
      })
    )
  res <- lapply(res, function(r){names(r) <- names(q) ; return(r)})
  res <- lapply(res, `[`, names(res[[1]]))
  res <- apply(do.call(rbind, res), 2, as.list)
  return(res)
})
stopCluster(cl)
rm(cl, nQ) ; invisible(gc())

## Non null mantels
nspafun.mantel <- lapply(nspafun.mantel, `[`, names(nspafun.mantel[[1]]))
nspafun.mantel <- apply(do.call(rbind, nspafun.mantel), 2, as.list)
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, `[`, names(s[[1]]))})
nspafun.mantel <- lapply(nspafun.mantel, function(s){apply(do.call(rbind, s), 2, as.list)})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(m){lapply(m, `[`, names(m[[1]]))})})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(m){apply(do.call(rbind, m), 2, as.list)})})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(x){lapply(x, function(x){as.numeric(unlist(x))})})})
spafun.res <- data.frame(mapply(function(x,y){
  mapply(function(r,s){
    mapply(function(p,q){
      paste(round(p, 3), Uppangala::stars(min(rank(c(p,q))[1]/(n+1), 1-rank(c(p,q))[1]/(n+1)), ns = '   '))
    }, p = r, q = s, SIMPLIFY = F)
  }, r = x, s= y)
}, x = spafun.mantel, y = nspafun.mantel))
spafun.res <- cbind(data.frame('Mantel statistic' = c('E', ' ', 'S|E', ' '), 'Metric' = rep(c('$U_{st}$', '$\\tau _{st}$'), 2)), spafun.res)

# Result
kable(bold(spafun.res))
rm(spafun.mantel, nspafun.mantel, spafun.res)
```

```{r PhyloMaker, include=FALSE}
library(phylosignal)
library(phytools)
library(phylobase)
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
sp <- Species[which(Species$LatinName %in% row.names(PFT_sp)), c('LatinName', 'Genus', 'Family')]
names(sp) <- c('species', 'genus', 'family')
results <- invisible(S.PhyloMaker(sp, phylo, nodes)) # Humboldtia_brunonis unmatched
tree <- results$Scenario.1
rm(phylo, results, modes, sp, S.PhyloMaker, path)
```

```{r Phylosignal}
data <- PFT_sp
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(data$WD))]
phy <- drop.tip(tree, tips)
data <- data[phy$tip.label,c(2:5,7)]
p4d <- phylo4d(phy,data)
phyloS <- phyloSignal(p4d, methods = 'I') 
phyloS <- data.frame(paste(round(phyloS$stat[,1], 3), 
                           unlist(lapply(as.list(phyloS$pvalue[,1]), stars, ns = ' '))),
                     row.names = row.names(phyloS$stat))
names(phyloS) <- 'Moran\'s I'
# kable(bold(phyloS))
rm(data, tips, p4d, phyloS, phy)
```

```{r BETAst $ PIst}
# Observed Hardys
phy <- tree
phy$tip.label <- Species$SpCode[match(gsub('_', ' ',phy$tip.label), Species$LatinName)]
tips <- c(setdiff(phy$tip.label, names(L$abundance)), setdiff(names(L$abundance), phy$tip.label))
phy <- drop.tip(phy, tips)
phy$node.label <- NULL
spaphy <- spacodi.calc(sp.plot = t(L$abundance), phy = phy, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]
## Mantel values
spaphy.mantel <- list(`E` = lapply(spaphy, function(m){vegan::mantel(m, Me, permutations = 0)$statistic}), 
                      `S | E`= lapply(spaphy, function(m){vegan::mantel.partial(m, Ms, Me, permutations = 0)$statistic}))

# Simulated mantel
nphy <- rep(list(phy), 999)
cl <- makeCluster(cores)
clusterExport(cl, list('nphy', 'L', 'spacodi.calc', 'Ntip', 'resamp.phy', 'branching.times'))
nphy <- clusterApply(cl, nphy, resamp.phy)
stopCluster(cl)
nspaphy <- lapply(nphy, function(p){spacodi.calc(sp.plot = t(L$abundance), phy = p, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]})
rm(cl, nphy) ; invisible(gc())
nspaphy.mantel <- list(`E` =lapply(nspaphy, function(x){lapply(x, function(M){vegan::mantel(M, Me, permutations = 0)$statistic})}), `S | E` = lapply(nspaphy, function(x){lapply(x, function(M){vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic})}))
## Non null mantels
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){lapply(s, `[`, names(s[[1]]))})
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){apply(do.call(rbind, s), 2, as.list)})
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){lapply(s, unlist)})
spaphy.res <- mapply(function(s, ns){
  mapply(function(x,y){
    paste(format(x, scientific = T, digits = 3), 
          Uppangala::stars(min(1-rank(c(x,y))[1]/(n+1),rank(c(x,y))[1]/(n+1)), ns = '   '))
  }, x = s, y = ns)
}, s = spaphy.mantel, ns = nspaphy.mantel)
row.names(spaphy.res) <- c('$\\beta_{st}$', '$\\pi_{st}$')
  
# Result
# kable(bold(spaphy.res))
rm(mtest, spaphy.mantel, nspaphy, nspaphy.mantel, spaphy.res)
```

# Discussion

## Ecological strategies

We found increasing trait variation within individuals, between individuals within species, and between speces (table 2). It entailed that the primary source of trait variation within and among communities should be among species. The PCA of functional trait variation among species displayed two main dimensions (figure 1), which basically represented a wood and a leaf economic spectrum, respectively. We found opposing SLA to LDMC values along the leaf economic spectrum, which expressed a trade-off between productivity, with less carbon investment for higher photosynthesis rates, and persistence, with more leaf defense and investment [PCA2, @wright_worldwide_2004]. A second major axis of trait variation opposed WD to LA and LT. It thus opposed stress tolerant species, with denser wood, to competitive species, with thicker and larger leaves for more efficient water conductivity. It represented the wood economic spectrum as defined by @chave_towards_2009, and the opposition between small thin leave and hardwood and large thick leaves with light wood corresponded to the additional gradient uncovered by @baraloto_decoupled_2010. 

Furthermore, our results are similar to the between-species variations found @fortunel_leaf_2012, where basic PCA axes also represented leaf and wood economic spectra (inverted compare to us). Noticeably though, our analysis integrated less traits (5 against 14), less species (89 against 758), and considered a regional set of species found in a local forest-plot scale while @fortunel_leaf_2012 considered a regional set of species. Therefore, we could capture basic economic spectra found at regional scale in Neotropics at a far more local scale in an Indian rainforest, even though such downscaling does not hold in any case [@messier_trait_2016]. It suggests that these spectra indeed represent major drivers of ecological strategies in local forest dynamics in our context.

## Communtiy-level trait values

We analyzed functional composition of $20*20m^2$ communities (CWM), as well as the variation of this composition with environment across the 10 ha forest plot. We found that the traits of the leaf economic spectrum (LES) were mainly affected by aspect with more convergent community composition (lower CWV) under south-west orientation, especially for LDMC of less common species. The influence of aspect is little documented in tropical forests, but still highlighted by @gunatilleke_specieshabitat_2006 in monsoon rainforests. @bunyan_effect_2015 also observed similar influence in mountain rainforests of Western Ghats, and suggested that it could result from monsoon winds. In our context, monsoon winds arise from south-west direction, and bring more stressful and disturbed conditions to species [@soman_aspects_1990] **To develop, see maxime disturbance hypothesis on opposite side**. Curvature is also affecting the variation of leaf economics in community. A locally convex context would accumulate more soil and attract more water, increasing soil fertility and allowing persistence of species investing more in leaf resource acquisition, with higher SLA and a convergence in LDMC values. The variation of SLA and LDMC with curvature, is consistent with the influence of changing soil fertility [@hodgson_is_2011]. 

Biotic factors also affected the LES through a negative effect of canopy height on LDMC. There was no effect of canopy height on understorey species, while it influenced leaf traits of canopy and emergent trees (results unshown **To include in the analysis**). A basic expectation is that understorey species would invest in higher LDMC for higher leaf lifespan and durability under limited light and water resources [@kitajima_tissue-level_2010]. But the Uppangala forest is characterized by heterogeneity of canopy height allowing light to penetrate more in lower strata and a dry season of 3.8 months. Comsequently leaf lifespan investment may not be so important resulting in a low-high light growth trade-off strategy instead of a growth-survival trade-off [@poorter_leaf_2009], affecting SLA but not LDMC. Emergent and high canopy species will have a lower LDMC, resulting from a more productive strategy toward leaf resource acquisition at the expense of leaf carbon investment in defense and resistance. **Second hyptohesis: canopy and emergent tree are more affected by water stress than understorey species preserved by microclimatic conditions buffered by canopy**. Thus canopy species with the lowest LDMC will grow more quickly and then reach the highest canopy. Measurement of LDMC on species classified as canopy and emergent were realized most of the time on shadow leaves from understorey individuals. Still we observed previous relationship indicating that species phylogenetic determinism is stronger than micro-environmental variation plasticity for LDMC, as suggested by the intra-specific variation of LDMC 1.5 times larger than intra-individuals variation.

The wood economic spectrum defined by WD, LA, and LT was mainly affected at community level by south-west orientation and curvature. South-west orientation, with probably more disturbance and stress due to exposure to monsoon winds **Maxime: counter effect by topo ?**, resulted in denser wood. However lower evenness than random could be related to multimodality. In addition, south-west orientation also related to a broader range of leaf sizes, which could be consistent with more diverse hydraulic strategies reflected by WD multimodality, as WD and LA are mechanically linked [@coomes_scaling_2008] **To develop, especially for a multimodality under southwest**. Decreasing fertility , with concavity was related to smaller leaves inside communities with a distribution broaden by multimodality reducing evenness **to develop, eventually illustrated with one example**. Wetness increased with higher curvature and lower LA evenness, indicating that multimodality is happening more in wettest low elevation area. Wetness could compensate water departure trigerred by positive curvature in lower elevation areas. **Repetition with first paragraph, to merge ?**.

## Variations among communities

Taxonomic variation in community composition was only dependent on environmental distance. Because we did not find any residual pattern of increasing taxonomic dissimilarity with spatial distance, it could indicate that environmental heterogeneity was a primary driver of species distributions, and that dispersal limitation did not influence these distributions at the scale of our forest plot. Conversely, functional variation did not depend on environmental distance or on spatial distance **Paradoxal ? Is it due to environmental aggregation in one variable or to a power loss of the test ?**. At the 10 ha level functional variation between communities is stochastic; whereas at the community level environment is partially shapping florisitic composition. Measured functional traits should vary to a larger scale [@messier_trait_2016]. Still environment is shaping community resistance to disturbance and stress by affecting wood density $\beta$ structure at fine scale. WD of less abundant species is even diverging with spatial residuals supposing an unaccounted spatially organized variable opposing close community in WD composition. Topography removed from spatial residuals, and climate and pedology being constant in the 10 ha plot, this unaccounted variation is assumed to be due to stochastic event in plot history as death. Unshown analysis reveals that this spatial divergence of WD is not explained by tree death events from the two last decades but certainly to older events. **To redraft**. Finally, variation in distance between taxon was not translated in phylogenetic variation whereas most of measured functional traits appeared phylogenetically conserved and clustered. **To discuss**.

## Limits and perspectives

Ecological strategies underline two econmic spectra as shown by @baraloto_decoupled_2010. Whereas the multivariate analysis of our functional traits lack trait diversity for correct interpretations of functional trade-offs. Measured traits were all morphological and from the leaf except for one. Anatomical and chemical traits as leaf vein patterns and leaf chemical content (N, P, K) could brought broader perspective on ecological strategies of Western Ghats species. Still the study reveal that few commonly used traits can highlight well known strategy axes. **Develop what would have brought this other traits**.

Besides patterns have been detected between functional composition and environment at both local ($\alpha$) and between-community ($\beta$) scales. Lot of relation observed didn't differ from those obtain with null hypothesis reflecting neutral theory [as functional equivalence, @hubbell_neutral_2005]. Ecological gradient and spatial scale sizes can be at the origin of this lack of environmental filtering. Effectively the abiotic variation is mainly topographic with a constant climate and pedology. Study highlighting environmental filtering often present a higher environmental variation [@bernard-verdier_community_2012]. In parallel, the 10 ha plot scale is really low and partially responsible for the small environmental variation. @kraft_functional_2008 detected topographical filtering on functional trait and @gunatilleke_specieshabitat_2006 observed niche differentiation on 25 ha tropical forest plots including large flat valleys. This mid-low elevation study of functional traits from Western Ghats forest could be reproduced at higher elevation or in dryer areas as Eastern Ghats for better insight of environmental filtering at broad scale. On the other hand, WD as shown to be filtered by environment at fine scale both in $\alpha$ and $\beta$ levels. Species wood seems highly adpted to environment in Western Gahts forests in link to monsoon events **To brought sooner, break conclusion**.

# *Acknowledgement*

French Institute of Pondicherry (FIP)

# Supplementary materials

## S1: Principal component analysis of topographical variables

```{r PCA Env}
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Supplementary material S1: Principal component analysis (PCA) performed on topgraphical variables. *Botom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 7 components (red line). SW stand for southwesterness.*

Curvature covaries with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Elevation and wetness are opposed in the principal component analysis and slope and south-westerness does not seem to covary much with other variables **Not precise**.

# References
