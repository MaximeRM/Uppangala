---
title: 'Uppangala tree functional structure: RLQ draft'
author: Sylvain Schmitt sylvain.schmitt@agroparistech.fr
output: pdf_document
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

# Abstract

Keywords: functionnal trait, tropical evergreen forest, Western Ghats, India...

# Introduction

Things to include :

- Functional traits can be linked to trade-off in tree development strategy [@baraloto_decoupled_2010, and see table 1], and can be as well explained by environment condition. For instance, SLA is a soil fertility - shade index whereas LDMC will only be linked to soil fertility [@hodgson_is_2011].
- Leaf investment definition
- Analyses scheme presentation:
    + Are functionnal composition of communities linked to the environment ?
        - Do covariations in functionnal traits illustrate ecological strategy axes ?
    + Are phylogenetic composition of communities linked to the environment
        - Are functionnal traits phylogenetically conserved ?
    + Are communities spatially structured ?
        - Are functionnal composition of communities spatially structured ?
        - Are phylogenetic composition of communities spatially structured ?


# Material and methods

## Study site

The study was carried out in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India), in the 10-ha "Uppangala plot" named after the nearest village. The permanent plot was established in 1990 by the French Institute of Pondicherry and described by @pascal_structure_1996. The Uppangala plot vegetation was assigned to low elevation *Dipterocarpus indicus - Kingiodendron pinnatum - Humboldtia brunonis* dense moist evergreen forest type [@pascal_wet_1988]. Climate and geology of the 10-ha plot can be considered as homogeneous. General topography of the site shows a regular east-west alternation between thalwegs and ridges separated by relatively steep slopes, so that topography can be assumed as a major local abiotic factor which varies inside the plot [@gimaret-carpentier_sampling_1998]. Each tree girth is monitored by a two-year census. **! Developper girth census !**

## Sampling

We collected trait information on 92 over 117 (79%) species focusing in priority on most abundant species with 5 replicates and we completed with less abundant and rare species with one to five replicates. Most abundant species were defined as the 32 species respresenting more than 80% of Uppangala tree individuals. Thus we generated data for 98.8% of the tree individuals present in the Uppangala plot. For each individual we collected 6 mature shadow dry leaves and one branch sample with a diameter close to 1cm following recommendation from @perez-harguindeguy_new_2013. Individuals and leaves were selected regarding their light condition, development stage and sanitary state for consistancy. Dawkins crown exposure index [@dawkins_management_1958] was registered to check the validity of the sampling. Leaf and branch samples were kept in humidified ziplock filled with enriched CO2 air inside a black bag untill their measurement in the following 24 hours. For some individuals we were unable to collect an appropriate branch sample (58 over 267 sampled trees representing 12 species over 91 and 1.3% of individuals).

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, area and thickness were measured, using a scanner [cite] and a microgauge [cite]. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 degrees celsisus, the drying process was stopped after dry leaf weights were stable in time. Once dried the leaves were weighted directly after been removed from the oven to avoid humidity bias. Branch samples bark and pit were removed in order to keep only branch wood with no soft tissues. Branch wood samples were sink in water to evaluate their volume by water displacement. Samples were then dried for 48 hours at 80 degrees celsius and weighted. 

## Trait measurements

We calculate five functional traits of leaf and wood samples: leaf thickness (Thick) measured in micrometer, leaf area (LA) measured from scans in $mm^2$, leaf dry matter content (LDMC) as the leaf dry weight in $mg$ divided by the leaf fresh weight in $g$,  specific leaf area (SLA) as the leaf area in $m^2$ divided by the leaf dry mass in $kg$, and branch wood density (WD) as the wood sample dry weight in $g$ divided by the wood sample volume in $cm^3$ (see table 1).

Table 1: Functional traits measured. *Traits with their abbreviation, range of values in the sampling, mean and standard deviation, standard unit, and associated trade-off in tree development from @baraloto_decoupled_2010.*

```{r 1 Traits}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
table <- data.frame(
  traits = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  `mean (sd)` = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  unit = c('um', 'mm2', 'mg.g-1', 'm2.kg-1', 'g.cm-3'),
  strategy = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisition vs. defense',
               'Stem transport, structure and defense')
  )
kable(table,  label="traits", row.names = F)
```

## Environmental variables

To study environment effect on our traits we choose 8 topographical variables representing abiotic factors: digital elevation model, slope, curvature, plan curvature, profile curvature, wetness index (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west), and distance to the nearest potential river. Digital elevation model is issued from a LIDAR campaign on Uppangala plots with a resolution of $1*1 m^2$. Slope, curvature, plan curvature, profile curvature, wetness and southwesterness ($cos(aspect~in~degres + 225)$) are all derived from the digital elevation model with the RSAGA package [@brenning_statistical_2008]. Distance to the nearest potential river was caluclated under ArcGis (cite).

To study biotic factors we choose 3 available variables: canopy height (canopy), basal area (BA), and stem density. Canopy height is calculated from a digital canopy model built with a LIDAR campaign on Uppangala **date ?** plots with a resolution $1*1 m^2$. Both basal area and stem density are calculated with 2013 girth inventory from Uppangala plot on stem with a diameter above 10 centimeters at breast height ($DBH>10$). Consequently basal area end stem density are highly correlated (Spearman's $rho = 0.84$, $p-value < 0.001$). So we removed stem density to avoid multicolinearity, and we kept canopy height that was not correlated to basal area (Spearman's $rho = -0.09$, $p-value > 0.1$).

## Analyses

*Title are just here to help remembering the structure but might be removed*

### Functionnal composition of communities and environment

### Phylogenetic composition of communities and environment

### Communitie compositions spatial structure

<!-- Traits variation was first investigated in three levels with the coefficient of variation ($cv=sd/mean$) between leaves of the same individual (intra-individual), between trees of the same species (intra-specific), and between species of the Uppangala plot (inter-specific). For the rest of the statistical analysis, we calculated the mean value of each 5 traits for our 92 species. To test the correlation and covariation among traits we performed a principal component analysis (PCA). We investigated peculiar traits covariation highlighted with the PCA with a Spearman's rank correlation test. -->

<!-- ### Environment definition -->

<!-- In order to avoid multi-colinearity in future analysis, we reduced our abiotic factors explanatory variables via a principal component analysis (PCA), by keeping less correlated variables with the most ecological meaning to our judgement. In order to see if or if environmental biotic factors were the results of functionnal traits we used structural equation modelling. Three latent variables were defined: *Abiotic environment* defined with selected topographical variables, *Biotic environment* defined with our 2 selected biotic variables, and *Functionnal traits* defined with our 5 functionnal traits. Two models were compared, a first one with the functionnal traits explained by both abiotic and biotic factors (**m1** *Traits ~ Abiotic + Biotic*), and a second one with the biotic factors explained by the functionnal traits and abiotic factors (**m2** *Biotic ~ Traits + Abiotic*). Models were compared with a Chi Square Difference test on Aikaike's Criterion Indice (AIC).  -->

<!-- ### Community analysis -->

<!-- Among the whole 10 hectares plot from Uppangala, 240 spatial communities where defined with $20*20 m^2$ quadrats. For all communities, community weighted means and variances [CWM and CWV, sensu @violle_let_2007] were computed for each functional traits and from the species scores obtained on the 2 first PCA axes. We used the following formula to compute each community weighted parameter (CWP): -->
<!-- $$CWP = \sum_{k=1}^{nj} W_{k,j} * P_{k,j} ~ (1)$$  -->
<!-- where $nj$ is the number of species sampled in community $j$, $W_{k,j}$ is the weight of species $k$ in community $j$ used to compute CWP (relative abundance, presence-absence, or relative basal area), and $P_{k,j}$ is the parameter of species $k$ in community $j$ (mean or the variance). In addition 5 functionnal diversity indices (FD) weighted by abundances were computed: functional richness (FRic), functional evenness (FEve), functional divergence (FDiv) and Rao's quadratic entropy (Q) (@villeger_new_2008, @botta-dukat_raos_2005). Spatial variograms were used to investigate our CWM and CWV spatial organization. CWM, CWV, and FD spatial autocorrelation (SAC) was also assessed by Moran's I statistic. -->

<!-- Links between both CWM and CWV with their environment, for both abiotic and biotic factors, were studied by linear regressions on continuous variables. Linear regression models were chosen by a step mesure (in both direction) on a first regression with selected variables. A null model was built by randomizing traits among species (permuting raw in `Trait*Species` matrix). Deviance of models selected by the step mesure was calculated 999 times and compare to observed deviance. Same procedure was also applied to functionnal diversity indices (FD) from our communities. Finally spatial autocorrelation (SAC) of residuals was investigated to assess selected models. -->

<!-- ### Fourth-corner analysis -->

<!-- In addition of our community analysis by regression, we conducted both RLQ and fourth-corner analyses to test the effect of environments on Uppangala tree functionnal traits following @dray_testing_2008. Both matrices R (`Environment*Sites`) with selected features and Q (`Traits*Species`) were reduced by a principal component analysis. We used a Monte-Carlo test to compare fourth-corner and RLQ results to 999 nul models built with the model *m6* proposed by @ter_braak_improved_2012. Fourth corner analysis was tested with 3 types of L matrices ($Sites*Species$) with species relative abundance, presence absence or relative basal area in each sites; whereas RLQ analysis was only conducted with relative abundance. -->

<!-- ### Phylogenetic signal -->

<!-- Phylogenetic tree of our 92 species was built with `S.PhyloMaker` function implemented by @qian_updated_2016-1. Phylogenetic autocorrelation was investigated with Morans'I indice on 60 species that had information for all 5 functionnal traits, the two PCA axes and in the phylogenetic tree. Phylogenetic signal structure was assessed by a tree tip distances correlogram. In addition, $\beta st$ and $\pi st$ metric proposed by @hardy_characterizing_2007 were used to investigate phylogenetic signal spatial organization with the null model *"1s"*" suggested by @hardy_testing_2008 to see if we were under phylogenetic clustering or overdispersion. Finally phylogenetic association to habitat was also studied by an RLQ analysis with tree tip distances as the Q matrix reduced by a principal coordinate analysis. RLQ result with phylogenetic distance matrix was compared to 999 nul models were phylogenetic tree tips were randomized. -->

All analysis were conducted in the R 3.3.0  free software environment for statistical analyses and graphics [@r_core_team_r:_2016] using the package 
`ade4` [@dray_ade4_2007], 
`lavaan` [@rosseel_lavaan:_2012], 
`FD` [@laliberte_distance-based_2010], 
`gstat` [@pebesma_multivariable_2004], 
`ape` [@paradis_ape:_2004], 
`phylosignal` [@keck_phylosignal:_2015] 
and `spacodiR` [@eastman_spacodir:_2013].

# Results

## Are functionnal composition of communities linked to the environment ?

Table 2: Coefficient of variation intra-individual, intra-specific and inter-specific. *Mean of coefficient of variation for leaves in all individual (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$SP), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
```

Trait coefficients of variation analysis reveals a general increase of functionnal trait variation among scales (from intra-individual to inter-specific, see table 2). Whereas LA shows already high variablilty at intra-individual level almost as strong as the intra-specific variation ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). 

The multivariate analysis of trait correlation shows WD associated with structural leaf traits orthogonal to the SLA (see figure 1). The first PCA axis (PCA1) covary mainly with Thick, LDMC and WD; opposing thin and big leaves to dense leaves and wood. Whereas the second PCA axis (PCA2) covary mainly with SLA representative of the leaf economic spectrum [LES, @wright_worldwide_2004]. PCA first axis might be associated with the WD covariation to the wood economic spectrum [WES, @chave_towards_2009]. Results are similar to the one found by @fortunel_leaf_2012 where PCA1 and PCA2 were respectively interpreted as leaf and wood economic spectrum (inverted compare to us). Our results integrate less traits (5 against 14), and less species (92 against 758), but still capture the same strategy axes.

Figure 1 shows WD orthogonal to SLA following the results of @baraloto_decoupled_2010 suggesting that the two economic spectrum were decoupled (Spearman's $rho = -0.04$, $p-value > 0.1$). LA is almost opposed to WD and is effectively negatively correlated to it (Spearman's $rho = -0.033$, $p-value < 0.001$) as found by @wright_relationships_2007. Finally, we found the positive relation suggested by @diaz_global_2015 between LDMC and WD (Spearman's $rho = 0.24$, $p-value < 0.001$).

```{r 3 RLQ}
library(vegan)
library(ade4)
library(raster)

# Data
Trees <- genTrees()
Species <- genSpecies()
Env <- genEnv()
com <- quadrats()
com@data$id <- paste0('C', com@data$id)

# L matrix
Trees$SpCode <- tolower(Trees$SpCode)
Trees$ID <- row.names(Trees)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0

# R matrix
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'cosaspect'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
names(com@data)[5] <- 'SW'
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$BA <- aggregate(Trees$`2013_girth`, list(Trees$com), function(x){sum(x, na.rm = T)/2*pi})[,2]
Rm <- com@data[-1]
row.names(Rm) <- com@data$id

# Q matrix
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
PFT_sp$SLA <- log(PFT_sp$SLA)
PFT_sp$LA <- log(PFT_sp$LA)
Qm <- PFT_sp[c('SLA', 'LDMC', 'WD', 'Thick', 'LA')]
row.names(Qm) <- PFT_sp$Sp_Code

# Matrices adjustments
Qm <- Qm[intersect(row.names(Qm), names(Lm)),]
Lm <- Lm[row.names(Rm),]
Lm <- Lm[intersect(row.names(Qm), names(Lm))]
Lm <- Lm / rowSums(Lm)

# Q plot
Q <- dudi.pca(Qm, scannf = F, row.w = L$cw)
plot(t(t(Q$li)/Q$eig[1:2]),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(Q$eig[1]/sum(Q$eig)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(Q$eig[2]/sum(Q$eig)*100, 2), '%'))
par(new=T)
XLIM <- c(-max(abs(Q$co[,1])),max(abs(Q$co[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Q$co,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
legend('topright', c('Plant economic spectrum'), text.col = c("green", "firebrick"))
Hmisc::subplot(function(){
  b <- barplot((Q$eig / sum(Q$eig)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(Q$eig)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.65,0.95), from='npc'),
  y=grconvertY(c(0.01,0.26), from='npc')
)
axis (3)
axis (4)
arrows (rep(0,nrow(Q$co)),rep(0,nrow(Q$co)),Q$co[,1],Q$co[,2],lwd=2)
text (Q$co, pos = c(2, 2, 2, 4, 4), rownames(Q$co),cex=1.2)
```

Figure 1: Principal component analysis (PCA) performed on individual trait means. *Bottom right corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 6 components (red line). See table 1 for abbreviation.*

Multi-colinearity was avoided by reducing our explanatory variables to slope, curvature, wetness and southwesterness, following PCA results (see figure 2). Curvature covary with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Eleveation (DEM) and wetness are opposed in the principal component analysis and slope and south-westerness doesn't seem to covary much with other variables. Structural equation modelling (SEM) revealed that environmental biotic factors were influencing functionnal traits and not the contrary. Effectively retained model was the first one (**m1** *Traits ~ Abiotic + Biotic*, see supplementary material S1) with a significantly lower AIC on Chi Square Difference test ($AIC = 13195$ against $AIC = 13238$ with $p.value < 0.001$)

Whereas total co-inertia from RLQ analysis results was significanlty different for the model *m2*, it didn't differ from null model *m4* in model *m6* proposed by @ter_braak_improved_2012. So because both test should be rejected to reject model *m6* hypothesis, therefore the null hypothesis *H0* is not rejected.

Still fourth-corner analysis with adjusted p-values or not show significant trait-environment association at a level $\alpha = 0.05$ (see table 7). WD is negatively associated with southwesterness for all L matrices and positively associated with canopy height in presence absence. LDMC and LA are respectively negatively and positively associated with canopy height in relative abundance.

Table 7: Summary of CWM et CWV analyses.



```{r FQR}
# L matrices list
Lm.l <- list(abundance = Lm)
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0
Lm <- Lm[row.names(Rm),]
Lm <- Lm[intersect(row.names(Qm), names(Lm))]
Lm[Lm > 0] <-  1
Lm <- Lm / rowSums(Lm)
Lm.l$`presence-absence` = Lm

# Full # -WD
RLQm.l <- list(full = list(Rm.l = rep(list(Rm),3), Lm.l = Lm.l, Qm.l = rep(list(Qm),3)))
Qm <- PFT_sp[c('SLA', 'LDMC', 'Thick', 'LA')]
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0
row.names(Qm) <- PFT_sp$Sp_Code
Qm <- Qm[intersect(row.names(Qm), names(Lm)),]
Lm <- Lm[row.names(Rm),]
Lm <- Lm[intersect(row.names(Qm), names(Lm))]
Lm <- Lm / rowSums(Lm)
Lm.l <- list(abundance = Lm)
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0
Lm <- Lm[row.names(Rm),]
Lm <- Lm[intersect(row.names(Qm), names(Lm))]
Lm[Lm > 0] <-  1
Lm <- Lm / rowSums(Lm)
Lm.l$`presence-absence` = Lm
```

## Are phylogenetic composition of communities linked to the environment ?

Only Thick, LDMC, WES and at a fewer level LES shown a phylogenetic signal positively structured in the phylogenetic tree at a phylogenetic distance between 0 and 100 (see supplementary material S3). $\beta st$ and $\pi st$ indicates both for respectivelly abundance and presence absence data that our phylogeny is overdispersed inside communities: species within communities are less phylogenetically related on average than are specis from distinct communities. But compared to the model null *1s* suggested by @hardy_characterizing_2007 , the phylogenetic overdispersion is almost null except in recent years (from 50 Myrs). Finally, total inertia from RLQ analysis with tip distances of phylogenetic tree as matrix Q didn't differ from a null model were all phylogenetic tree tips were randomized ($p-value = 0.5344$ with 999 repetitions.)

```{r PhyloMaker}
library(phylosignal)
library(phytools)
library(phylobase)

# Building species list
l <- PFT_sp
# setdiff(row.names(l), Species$LatinName)
row.names(l)[which(row.names(l) == 'Actinodaphne tadulingami')] <- 'Actinodaphne tadulingamii'
Species['agin',] <- c('agin', "Agrostistachys indica", 'Euphorbiaceae', NA, NA)
Species['anme',] <- c('anme', "Antidesma menasu", 'Euphorbiaceae', NA, NA)
Species['anmo',] <- c('anme', "Antidesma montanum", 'Euphorbiaceae', NA, NA)
row.names(l)[which(row.names(l) == 'Blepharistemma membranifolia')] <- 'Blepharistemma serratum '
row.names(l)[which(row.names(l) == 'Casearia ovata')] <- 'Casearia ovata '
row.names(l)[which(row.names(l) == 'Cinnamomum malabathrum')] <- 'Cinnamomum malabatrum'
row.names(l)[which(row.names(l) == 'Cinnamomum sp1')] <- 'Cinnamomum sp.'
row.names(l)[which(row.names(l) == 'Dimocarpus longan')] <- 'Dimocarpus longan '
row.names(l)[which(row.names(l) == 'Drypetes confertiflorus')] <- 'Drypetes confertiflora'
row.names(l)[which(row.names(l) == 'Glochidion malabaricum')] <- 'Glochidion ellipticum'
row.names(l)[which(row.names(l) == 'Homalium zeylanicum')] <- 'Homalium zeylanicum '
row.names(l)[which(row.names(l) == 'Ixora nigricams')] <- 'Ixora nigricans  '
row.names(l)[which(row.names(l) == 'Knema attenuata')] <- 'Knema attenuata  '
row.names(l)[which(row.names(l) == 'Leptonychia moacurroides')] <- 'Leptonychia caudata '
row.names(l)[which(row.names(l) == 'Myristica malabarica')] <- 'Myristica malabarica '
row.names(l)[which(row.names(l) == 'Olea dioica')] <- 'Olea dioica '
row.names(l)[which(row.names(l) == 'Reinwardtiodendron anaimalaiense')] <- 'Reinwardtiodendron anamalaiense'
row.names(l)[which(row.names(l) == 'Strombosia ceylanica')] <- 'Strombosia ceylanica '
row.names(l)[which(row.names(l) == 'Symplocos cochinensis')] <- 'Symplocos cochinchinensis'
row.names(l)[which(row.names(l) == 'Syzygium laetum')] <- 'Syzygium laetum '
row.names(l)[which(row.names(l) == 'Vepris bilocularis')] <- 'Vepris bilocularis '
sp <- Species[which(Species$LatinName %in% row.names(l)), 2:3]
sp$genus <- unlist(lapply(strsplit(sp$LatinName, ' ', fixed = T), function(x){x[1]}))
sp$species <- sub(' ', '_', sp$LatinName, fixed = T)
sp$family <- sp$Family
sp <- sp[c('species', 'genus', 'family')]
sp[which(sp$family == 'Flacourtiaceae'),3] <- 'Salicaceae'
sp[which(sp$family == 'Steruliaceae'),3] <- 'Malvaceae'
sp[which(sp$family == 'Cesaliniaceae'),3] <- 'Fabaaceae'
sp['hepa','family'] <- 'Malvaceae'
# sp <- sp[-which(row.names(sp) == 'hubr'),]
# sp <- sp[-which(row.names(sp) %in% levels(droplevels(PFT_sp[which(is.na(PFT_sp$WD)),1]))),]

# Getting phylogeny
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
results <- S.PhyloMaker(sp, phylo, nodes)
tree <- results$Scenario.1
```

```{r Phylogenetic Tree, eval=FALSE, include=FALSE}
# Completing the phylogenetic tree
# Humboldtia: Close to Kingiodendron pinnatum according to Bruneau et al. 2001 Systematic Botany 26(3):487-514
# Humboldtia and Kingiodendron are our only two Leguminosae
# zoom(tree, 70:75)
node <- which(tree$tip.label == "Kingiodendron_pinnatum")
position<- 0.1*tree$edge.length[which(tree$edge[,2]==node)]
tree <- bind.tip(tree,"Humboldtia_brunonis",where = node, position = position)
# zoom(tree, 60:80)
```

```{r Phylosignal}
data <- l
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(l$WD))]
phy <- list(full = drop.tip(tree, tips), `-WD` = tree)
data <- list(full = data[phy$full$tip.label,c(2:5,7)], `-WD` = data[phy$`-WD`$tip.label,c(3:5,7)])
p4d <- mapply(function(p,d){phylo4d(p,d)}, p = phy, d = data)
# lapply(p4d, barplot)
phyloS <- lapply(p4d, phyloSignal, methods = 'I')
phyloS <- lapply(phyloS, function(x){cbind(x$stat, x$pvalue)})
phyloS <- rbind(phyloS$`-WD`, phyloS$full['WD',])
names(phyloS) <- c('Moran\'s I', 'p-value')
phyloS$` ` <- lapply(as.list(phyloS$`p-value`), stars)
phyCor <- mapply(function(d,p){lapply(as.list(names(d)), function(x){phyloCorrelogram(p, trait = as.character(x))})}, d = data, p = p4d)
phyCor <- c(phyCor$`-WD`, list(phyCor$full[[1]]))
names(phyCor) <- unlist(lapply(phyCor, function(x){x$trait}))
lipa <- lapply(p4d, lipaMoran)
# mapply(function(x,y){barplot.phylo4d(x, bar.col=(y$p.value < 0.05) + 1)}, x = p4d, y = lipa)
kable(phyloS)
```

```{r Phylo RLQ, fig.height=4}
library(adephylo)
library(spacodiR)

# RLQ
for(i in 1:2) phy[[i]]$tip.label <- gsub('_', ' ', phy[[i]]$tip.label, fixed = T)
for(i in 1:2) phy[[i]]$tip.label <- as.character(l$Sp_Code[match(phy[[i]]$tip.label, row.names(l))])
Lm <- lapply(phy, function(x){Lm[intersect(names(Lm), x$tip.label)]})
L <- lapply(Lm, dudi.coa, scannf = F)
R <- mapply(function(x,y){dudi.pca(x, scannf = F, row.w = y$lw)}, x = rep(list(Rm), 2), y = L, SIMPLIFY = F)
phyRLQ <- mapply(function(x,y){drop.tip(x,setdiff(x$tip.label, names(y)))}, x = phy, y = Lm, SIMPLIFY = F)
Qd <- lapply(phyRLQ, distTips)
Q <- mapply(function(x,y){dudi.pco(x, scannf = F, row.w = y$cw)}, x = Qd, y = L, SIMPLIFY = F)
rlq <- mapply(function(x,y,z){rlq(x, y, z, scannf = F)}, x = R, y = L, z = Q, SIMPLIFY = F)

# Random RLQs
phyRD <- lapply(phy, function(x){x$node.label <- NULL ; return(x)})
phyRD <- lapply(phyRD, function(x){rep(list(x), 999)})
phyRD <- lapply(phyRD, function(x){lapply(x, resamp.phy)})
LmRD <- lapply(Lm, function(x){rep(list(x), 999)})
LmRD <- mapply(function(x,y){mapply(function(r,s){r[intersect(names(r), s$tip.label)]}, r = x, s = y, SIMPLIFY = F)}, x = LmRD, y = phyRD, SIMPLIFY = F)
phyRD <- mapply(function(x,y){mapply(function(r,s){drop.tip(r, setdiff(r$tip.label, names(s)))}, r = x, s= y, SIMPLIFY = F)}, x = phyRD, y = LmRD, SIMPLIFY = F)
QdRD <- lapply(phyRD, function(x){lapply(x, distTips)})
LRD <- lapply(LmRD, function(x){lapply(x, dudi.coa, scannf = F)})
RmRD <- lapply(rep(list(full = Rm, `-WD` = Rm)), function(x){rep(list(x), 999)})
RRD <- mapply(function(x,y){mapply(function(r,s){dudi.pca(r, scannf = F, row.w = s$lw)}, r = x, s = y, SIMPLIFY = F)}, x = RmRD, y = LRD, SIMPLIFY = F)
QRD <- mapply(function(x,y){mapply(function(r,s){dudi.pco(r, scannf = F, row.w = s$cw)}, r = x, s = y, SIMPLIFY = F)}, x = QdRD, y = LRD, SIMPLIFY = F)
rlqRD <- mapply(function(x,y,z){mapply(function(r,s,t){rlq(r, s, t, scannf = F)}, r = x, s = y, t = z, SIMPLIFY = F)}, x = RRD, y = LRD, z = QRD, SIMPLIFY = F)
 
# Randtest
pval <- mapply(function(x,y){rank(c(sum(x$eig), unlist(lapply(y, function(z){sum(z$eig)}))))[1]/1000}, x = rlq, y = rlqRD)
par(mfrow = c(1,2))  
invisible(mapply(function(x,y,z,l){
  hist(unlist(lapply(y, function(r){sum(r$eig)})), main = paste('Model', l, ':', 'pval =', round(z, 3)), xlab = 'Coinertia', col = 'lightgrey', border = 'white')
  lines(c(sum(x$eig), sum(x$eig)), c(0,500), col = 'red', lwd = 2)
}, x = rlq, y = rlqRD, z = as.list(pval), l = as.list(names(rlqRD))))
```

## Are communities spatially structured ?

```{r Functionnal spatial structure}
library(spacodiR)

# Traits structure
Lm <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
Lm[is.na(Lm)] <- 0
Lm.l <- list(full = Lm, `-WD` = Lm)
Qm <- PFT_sp[c('SLA', 'LDMC', 'WD', 'Thick', 'LA')]
row.names(Qm) <- PFT_sp$Sp_Code
Qm.l <- list(full = Qm, `-WD` = Qm[-3])
Qm.l <- mapply(function(x,y){x[intersect(row.names(x), names(y)),]}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
Qm.l$full <- Qm.l$full[-which(is.na(Qm.l$full$WD)),]
Lm.l <- mapply(function(x,y){y[intersect(row.names(x), names(y))]}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
spafun <- mapply(function(x,y){spacodi.calc(sp.plot = t(y), sp.traits = x)}, x = Qm.l, y = Lm.l, SIMPLIFY = F)
spafun <- do.call('rbind.data.frame', lapply(spafun, function(x){x[1:4]}))

Qm.lRD <- lapply(Qm.l, function(x){rep(list(x),999)})
Qm.lRD <- lapply(Qm.lRD, function(x){lapply(x, function(y){y[sample(row.names(y)),]})})
Lm.lRD <- lapply(Lm.l, function(x){rep(list(x),999)})
Lm.lRD <- mapply(function(x,y){mapply(function(r,s){r[row.names(s)]}, r = x, s = y, SIMPLIFY = F)}, x = Lm.lRD, y = Qm.lRD, SIMPLIFY = F)
spafun.l <- mapply(function(x,y){mapply(function(r,s){spacodi.calc(sp.plot = t(s), sp.traits = r)}, r = x, s = y, SIMPLIFY = F)}, x = Qm.lRD, y = Lm.lRD, SIMPLIFY = F)
spafun.l <- lapply(spafun.l, function(x){lapply(x, function(y){y[1:4]})})
spafunRD <- list(Ist = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Ist}))}),
                 Tst = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Tst}))}),
                 Ust = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$Ust}))}),
                 TAUst = lapply(spafun.l, function(x){unlist(lapply(x, function(y){y$TAUst}))}))
pvalues <- mapply(function(obs,rd){
  mapply(function(o,r){rank(c(o, r))[1]/1000}, o = obs, r = rd)
  }, obs = lapply(as.list(spafun), as.list), rd = spafunRD)
row.names(pvalues) <- row.names(spafun)

pvalues <- as.data.frame(pvalues)[3:4]
pvalues$Ust <-  1- pvalues$Ust
spafun.res <- format(spafun[3:4], scientific = T, digits = 2)
pvalues <- data.frame(apply(pvalues, c(1,2), function(y){paste(y, stars(y, ns = ' '))}))
spafun.res$Ust <- paste(spafun.res$Ust, '/', pvalues$Ust)
spafun.res$TAUst <- paste(spafun.res$TAUst, '/', pvalues$TAUst)
kable(spafun.res)
```

```{r Phylogenetic spatial structure}
spaphy <- mapply(function(x,y){spacodi.calc(sp.plot = t(y), phy = x)}, x = phy, y = Lm.l, SIMPLIFY = F)
spaphy <- do.call('rbind.data.frame', lapply(spaphy, function(x){x[1:4]}))

spaphy.l <- mapply(function(x,y){mapply(function(r,s){spacodi.calc(t(r), s)}, r = x, s = y, SIMPLIFY = F)},x = LmRD, y = phyRD, SIMPLIFY = F)
spaphy.l <- lapply(spaphy.l, function(x){lapply(x, function(y){y[1:4]})})
spaphyRD <- list(Ist = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Ist}))}),
                 Tst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Tst}))}),
                 Bst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Bst}))}),
                 PIst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$PIst}))}))
pvalues <- mapply(function(obs,rd){
  mapply(function(o,r){rank(c(o, r))[1]/1000}, o = obs, r = rd)
  }, obs = lapply(as.list(spaphy), as.list), rd = spaphyRD)
row.names(pvalues) <- row.names(spaphy)

pvalues <- as.data.frame(pvalues)[3:4]
pvalues$Bst <-  rep(NaN,2)
spaphy.res <- format(spaphy[3:4], scientific = T, digits = 2)
pvalues <- data.frame(apply(pvalues, c(1,2), function(y){paste(y, stars(y, ns = ' '))}))
spaphy.res$Bst <- paste(spaphy.res$Bst, '/', pvalues$Bst)
spaphy.res$PIst <- paste(spaphy.res$PIst, '/', pvalues$PIst)
kable(spaphy.res)

# permut <- list(Bst = mapply(function(x,y){spacodi.by.nodes(sp.plot = t(y), x, sp.parm = "Bst", method = "1s")}, x = phy, y = Lm.l, SIMPLIFY = F), PIst = mapply(function(x,y){spacodi.by.nodes(sp.plot = t(y), x, sp.parm = "PIst", method = "1s")}, x = phy, y = Lm.l, SIMPLIFY = F))
# par(mfrow=c(2,2)) ; invisible(lapply(permut, function(x){lapply(x, spacodi.permutplot)}))
```


# Discussion

# *Acknowledgement*

# Supplementary materials

## S2: Phylogenetic signal among functionnal traits by correlogram

Supplementary materials S3: Correlogram of phylogenetic signal among the 5 functionnal traits

```{r phylosignal plots}
par(mfrow = c(2,3))
invisible(lapply(phyCor, function(x){plot(x, main = x$trait)}))
```

# References
