---
title: 'Uppangala tree functionnal traits: Preliminray Results'
author: "Sylvain Schmitt"
date: '`r Sys.Date()`'
output: pdf_document
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

# *News*
Add from the `r Sys.Date()` version :

- RLQ to investigate individuals filters
- Spatial autocorrelation for CWM and models residuals with Moran's I
- Phylosignal
- CWV
- Structural Equation Modelling (SEM)
- Species growth too much unprecised for analysis
- Eveness and other FD package metrics

# Traits

## Measured traits

Table 1: Functional traits measured. *Traits with their abbreviation, range of values in the sampling, mean and standard deviation, standard unit, and associated trade-off in tree development.*

```{r 1 Traits}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
table <- data.frame(
  traits = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  `mean (sd)` = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  unit = c('um', 'mm2', 'mg.g-1', 'm2.kg-1', 'g.cm-3'),
  strategy = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
kable(table,  label="traits", row.names = F)
```

Uppangala measured functional traits vary in the ranges of tropical species values that we can find in literature. We can notice in table 1 that wood density has a relatively high mean as we could expect in an old untouched forest. Functional traits can be linked to trade-off in tree development strategy [@baraloto_decoupled_2010], and can be as well explained by environment condition. For instance, SLA is a soil fertility - shade index whereas LDMC will only be linked to soil fertility [@hodgson_is_2011]. We could also have added a sixth trait, called leaf tissue density (LTD) with the formula: $LTD=Leaf dry weight/Thickness*Leaf area$. LTD is highly correlated to LDMC [@hodgson_is_2011], but can still bring extra information **To be discussed**.

## Traits distribution and variation

Table 2: Coefficient of variation intra-individual, intra-specific and inter-specific. *Mean of coefficient of variation for leaves in all individual (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$SP), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
```

Some outliers are still to be corrected in individual leaf trait value, but thickness outliers and extreme values are due to too close secondary veins. Table 2 shows a intra-individual variation lower than intra-specific and inter-specific variation, indicating that leaves are even in morphology inside an individual but can start to show some variation between trees of the same species. More specifically, whereas traits like thickness and wood density seems to stay stable in intra-individual and intra-specific, leaf area shows a high coefficient of variation for both intra-individual and intra-specific values.

## Covariations in traits

```{r 3 PCA PFT}
library(vegan)
pca <- princomp(~ LA + WD + Thick + LDMC + SLA, data = PFT_ind, cor = T)
lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2] # Adding PCA axis in PFT values
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
     # xlab = paste('Axe 1 -', round(lambda[1]/sum(lambda)*100, 2), '%'),
     # ylab = paste('Axe 2 -', round(lambda[2]/sum(lambda)*100, 2), '%'))
     xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
# as.factor(Species[PFT_ind[row.names(pca$scores),2],6])
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)
PFT_ind$ID <- row.names(PFT_ind)
PFT_ind <- merge(PFT_ind, PCAscores, all = T)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
```

Figure 1: Principal component analysis (PCA) performed on individual trait means. *Bottom right corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 6 components (red line). See table 1 for abbreviation.*

We realized a principal component analysis on individual trait means (see figure 1), where first axis (PCA1) covary mainly with leaf thickness, dry matter content and wood density. Whereas second axis (PCA2) covary mainly with specific leaf area representative of the leaf economic spectrum [LES, @wright_worldwide_2004]. PCA1 might be associated with the wood density covariation to the wood economic spectrum [WES, @chave_towards_2009]. Results are similar to the one found by @fortunel_leaf_2012 where PCA1 and PCA2 were respectively interpreted as leaf and wood economic spectrum (inverted compare to us). Our results integrate less traits (5/14), and less species (92/758), but still capture the same strategy axes.

We can see that as wood density and specific leaf area are orthogonal following the results of @baraloto_decoupled_2010 suggesting that the two economic spectrum were decoupled (Spearman's $rho = -0.04$, $p-value > 0.1$). Leaf area is almost opposed to wood density and is effectively negatively correlated to it (Spearman's $rho = -0.033$, $p-value < 0.001$) as found by @wright_relationships_2007. This relationship could be explained by an equilibrium in tree hydraulics (Coomes et al, 2008). Finally, we found the positive relation suggested by @diaz_global_2015 between leaf dry matter content and wood density (Spearman's $rho = 0.24$, $p-value < 0.001$).

# Environmental filters

## Environment and trees

We collected trait information on 92 over 117 (79%) species focusing in priority on abundant species with 5 replicates and we completed with less abundant and rare species with one to five replicates (*Warning : one of our 92 species is not referenced yet among currently known Uppangala species, Agrosystachis indica, one of 117 species is not removed yet, Toona ciliata.*). Thus we generated data for 98.8% of the tree individuals present in Uppangala plot.

```{r 4 env-com}
library(raster)
Env <- genEnv()
Env$Rivers <- readAll(Env$Rivers)
Trees <- genTrees()
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
Trees$SpCode <- tolower(Trees$SpCode)
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
com@data$id <- paste0('C', com@data$id)
com@data$DEM <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'DEM'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'aspect'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$SW <- sin((com@data$Aspect + 225) / 180 * pi)
com@data$NE <- cos((com@data$Aspect + 225) / 180 * pi)
com@data$Rivers <- extract(Env$Rivers, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$topo <- as.factor(with(com@data, topo_classes(Slope, Curvature, Aspect)))
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$BA <- aggregate(Trees$`2013_girth`, list(Trees$com), function(x){sum(x, na.rm = T)/2*pi})[,2]
com@data$StD <- aggregate(rep(1, length(Trees$SpCode)), list(Trees$com), sum)[,2]
# com@data$Height <- aggregate(Trees$height, list(Trees$com), mean, na.rm = T)[,2]
rm(Deriv, XY)
```

To study environment effect on our traits we choose 8 topographical variables representing abiotic factors: digital elevation model, slope, curvature, plan curvature, profile curvature, wetness, southwesterness (SW, aspect in direction of south-west), and distance to the nearest potential river. Digital elevation model is issued from a LIDAR campaign on Uppangala plots with a resolution of $1*1 m^2$. Slope, curvature, plan curvature, profile curvature, wetness and southwesterness ($cos(aspect in degres + 225)$) are all derived from the digital elevation model with the RSAGA package [@brenning_statistical_2008]. Distance to the nearest potential river was caluclated under ArcGis (cite).

In order to avoid multi-colinearity in future regressions, we reduced our explanatory variables via a principal component analysis, see figure 2. Curvature, profile curvature, plan curvature, and distance to potential rivers covary together and with the principal component analysis first axis (PCA1). Eleveation (DEM) and wetness are opposed in the principal component analysis and slope and south-westerness doesn't seem to covary much with other variables. As a conclusion, we choose to reduce our variable to 4: curvature to represent the water flow paths and soil stabilization areas, wetness to highlight water accumulation areas, southwesterness (SW) to represent monsoon winds [@bunyan_effect_2015] and slope.

```{r PCA Env}
pca.env <- princomp(~ DEM + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + Rivers + SW, data = com@data, cor = T)
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     # xlab = paste('Axe 1 -', round(lambda[1]/sum(lambda)*100, 2), '%'),
     # ylab = paste('Axe 2 -', round(lambda[2]/sum(lambda)*100, 2), '%'))
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.05,0.35), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 1), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Figure 2: Principal component analysis (PCA) performed on topgraphical variables. *Bootom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 8 components (red line). SW stand for southwesterness.*

Among all topographical variables, slope, curvature and south-westerness were chosen to define 6 topographical classes. We rejected elevation because our plot is situated in a mountain slope and doesn't include valley. Consequently elevation mainly inform on the position in the mountain general slope. And because the elevation range between the top of the plot and the bottom is low (325-490), we assumed it won't affect directly tree ecology.

Slope was separated in three categories: plane surface (below 20 degrees), mean slope (between 20 and 30degrees) and steep slope (above 30 degrees). Plane surface were then discriminated on curvature: concave (positive curvature) and convex (negative curvature). Whereas slopes where discriminated by their south-west or north east aspect. Finally, 6 topographical classes were defined: concave plane surface (CvP), convex plane surface (CxP), north-east mean slope (NEMS), north-east steep slope (NESS), south-west mean slope (SWMS), and south-west steep slope (SWSS), see figure 3. The predominance of north-east slope (62%) in our study site is noticeable and should be took into account.

```{r topo classes}
col <- c("#008B00", "#00CD00", "#009ACD", "#00BFFF", "#CD9B1D", "#FFC125")
plot(raster(com, 'topo'), col = col, legend = F)
contour(Env$DEM, add = T)
legend('bottomleft', fill = col, legend = levels(com@data$topo), bg = 'white')
```

Figure 3: Uppangala 10 hectares plot topographical classes.*6 classes were defined one slope, curvature, and south-westerness: concave plane surface (CvP) in dark green, convexe plane surface (CxP) in light green, north-east mean slope (NEMS) in dark blue, north-east steep slope (NESS) in light blue, south-west mean slope (SWMS) in dark orange, and south-west steep slope (SWSS) in ligh orange.*

To study biotic factors we choose 3 available variables: canopy height (canopy), basal area (BA), and stem density *(we may add tree height and growth in the future)*. Canopy height is issued from a digital canopy model built with a LIDAR campaign on Uppangala plots with a resolution $1*1 m^2$. Both basal area and stem density are calculated with 2013 Uppangala plots girth inventory only on stem with a diameter above 10 centimeters at breast height ($DBH>10$). Consequently basal area end stem density are highly correlated (Spearman's $rho = 0.84$, $p-value < 0.001$). So we removed stem density to avoid multicolinearity, and we kept canopy height that wasn't correlated to basal area (Spearman's $rho = -0.09$, $p-value > 0.1$).

For each species the potential strata was defined. Because species were defined in several strata, we kept the lowest strata as the species strata. We tested the strata effect on each trait with an anova combined to a tukey test, but no trait show a significant variation (all F values weren't significanlty different from 0, $p-values>0.1$).

```{r strata effect}
AOV <- list(SLA = aov(PFT_sp$SLA ~ Species[PFT_sp$Sp_Code,]$Strata), 
            WD = aov(PFT_sp$WD ~ Species[PFT_sp$Sp_Code,]$Strata),
            LDMC = aov(PFT_sp$LDMC ~ Species[PFT_sp$Sp_Code,]$Strata),
            LA = aov(PFT_sp$LA ~ Species[PFT_sp$Sp_Code,]$Strata),
            Thick = aov(PFT_sp$Thick ~ Species[PFT_sp$Sp_Code,]$Strata))
# lapply(AOV, summary)
# lapply(AOV, TukeyHSD)
```


## Communities

```{r 5 Com}
library(FD)
com <- CWT(Trees, com)
x <- data.frame(PFT_sp[-1], row.names = PFT_sp$Sp_Code)
a <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
a[is.na(a)] <- 0
x <- x[names(a),]
FD <- as.data.frame(dbFD(x, a, corr = 'cailliez', calc.CWM = F, print.pco = F, messages = F))[-c(1:2,4)]
names(FD) <- paste0(names(FD), '.fd')
FD$id <- row.names(FD)
com$abundance <- merge(com$abundance, FD)
```

Among the whole 10 hectares plot from Uppangala, 240 spatial communities where defined with $20*20 m^2$ quadrats. For all those community, community weighted means and variances [CWM and CWV, sensu @violle_let_2007] were computed for each functional traits and from the species scores obtained on the 2 first PCA axes representing the leaf and the wood economic spectrum (WES, LES). Weighted mean and variances were realized by abundance, presence-absence, or basal area. In addition functionnal diversity indices weighted by abundances were computed with the `FD` package [@laliberte_distance-based_2010] for our communities: functional richness (FRic), functional evenness (FEve), and functional divergence (FDiv) and Rao's quadratic entropy (Q) (cite Villéger et al. (2008) et Botta-Dukát 2005).

Spatial variograms of community weighted means and variances didn't show a clear plateau (see figure 4) but suggest a spatial organization at a scale of $70 m$. Functionnal diversity indices show also a plateau around $70 m$.

```{r Variograms}
library(gstat)
dist <- variogram(WD.cwm~1, as(com$abundance, 'SpatialPointsDataFrame'))$dist
par(mfrow = c(2,1))
for(i in 1:2){
  traits <- paste0(c('WD', 'Thick', 'LA', 'LDMC', 'SLA', 'WES', 'LES'), c('.cwm','.cwv')[i])
  plot(c(1:length(dist)) ~ dist, xlim = c(0, max(dist)), ylim = c(0.5,1), pch = '', main = c('(a)', '(b)')[i], xlab = 'distance (m)', ylab = 'relative variance (%)')
  for(j in 1:length(com)){
    var <- data.frame(lapply(lapply(as.list(traits), function(x){variogram(formula(paste(x, '~ 1')), as(com[[j]], 'SpatialPointsDataFrame'))}), function(x){x[3]}))
    var <- data.frame(apply(var, 2, function(x){x/max(x)}))
    names(var) <- c('WD', 'Thick', 'LA', 'LDMC', 'SLA', 'WES', 'LES')
    colramp <- rainbow(length(var))
    for(i in 1:length(var)){
      lines(var[,i] ~ dist, col = colramp[i], lty = j + 1)
    }
  }
legend('bottomright', names(var), fill = colramp, cex = 0.7)
legend('bottomleft', names(com), lty = c(2:4), cex = 0.7)
}
```

Figure 4: Trait variograms for all communities.*Variograms were initiated on* $20*20 m^2$ *communities for all traits with both community weighted means* **(a)** *and variances* **(b)** *(by abundance, presence-absence and basal area). Some variaograms seem to reach a plateau around* $70 m$.

In order to see if environmental biotic factors were influencing functionnal traits or if environmental biotic factors were the results of functionnal traits we used structural equation modelling on community weighted means by abundance. Three latent variables were defined: *Abiotic environment* defined with our 4 selected topographical variables, *Biotic environment* defined with our 2 selected biotic variables, and *Functionnal traits* defined with our 5 functionnal traits. Two models were compared, a first one with the functionnal traits explained by both abiotic and biotic factors (**m1** *Traits ~ Abiotic + Biotic*), and a second one with the biotic factors explained by the functionnal traits and abiotic factors (**m2** *Biotic ~ Traits + Abiotic*). Retained model was the first one (**m1**) with a significantly lower Aikaike's Criterion Indice on Chi Square Difference test ($AIC = 13195$ against $AIC = 13238$ with $p.value < 0.001$)

```{r SEM}
library(lavaan)
m1 <- '
Abiotic =~ Slope + Curvature + Wetness + SW
Traits =~ WD.cwm + Thick.cwm + LA.cwm + LDMC.cwm + SLA.cwm
Biotic =~ BA + Canopy
Traits ~ Abiotic + Biotic
'
m2 <- '
Abiotic =~ Slope + Curvature + Wetness + SW
Traits =~ WD.cwm + Thick.cwm + LA.cwm + LDMC.cwm + SLA.cwm
Biotic =~ BA + Canopy
Biotic ~ Traits + Abiotic
'
fit1 <- sem(m1, data = com$abundance@data)
fit2 <- sem(m2, data = com$abundance@data)
semPlot::semPaths(fit1,what='path',whatLabels='std',intercept=FALSE,residuals=FALSE,thresholds=FALSE,nCharNodes=0,nCharEdges=0,groups='manlat',pastel=TRUE,title=TRUE,curveAdjacent=TRUE,ask=FALSE)
```

Figure 5: Path diagram for structural equation modelling. *Path diagram of the structural equation model* **m1** *Traits ~ Abiotic + Biotic. Arrow values are indicating standardized parameter estimates*.

Links between both community weighted means and variances with their environment, for both abiotic and biotic factors, were studied by linear regressions on continuous variables. Linear regression models were chosen by a step mesure (in both direction) on a first regression with selected variables (slope, curvature, wetness and southwesterness for abiotic factors, and canopy height and basal area for biotic one). A null model was built by randomizing traits among species (permuting raw in `Trait*Species` matrix). Deviance of models selected by the step mesure was calculated 999 times and compare to observed deviance. Results for abundance, presence-absence and basal area community weighted mean for all traits are presented in tables 4 and 5 (respectively for community weighted means and variances). Same procedure was also applied to functionnal diversity indices (FD) from our ocmmunities, results are presented in table 6.

An assessment of spatial autocorrelation (SAC) of the community weighted means and variances and functionnal diversity indices was conducted using Moran's I statistic. Only half of community weighted means and variances were significantly positively spatially autocorrelated (see table 3) with low values (Moran's I from 0.01 to 0.04). Leaf economic spectrum and dry matter content weighted means as wood density weighted variances are slightly spatially correlated suggesting a spatial filter due to environment or local history pressure (as dispersion limitation). On the opposite, wood density and thickness community weighted means as wood economic spectrum community weighted variances possess a stochastic spatial distribution implying that they're not shaped by factors with a spatial organization. Finally remaining traits community weighted means and variances are spatially organized for abundant species and voluminous individual but not in presence absence, suggesting that the filter is linked to abundant species pressure as dispersion filter. As a conclusion both community weighted means and variances are most of the time stochastic or driven by dispersion. Moreover all functionnal diversity indices (FD) are spatially correlated. 

Table 3: Spatial autocorrelation measured by Moran's I for community weighted means and variances. _Spatial autocorrelation for each trait community weighted means and variances (by abundance, presence-absence and basal area), see table 1 for abbreviations. FRic, FEve, FDiv, FDis  and RaoQ stand respectively for functionnal richness, eveness, diversity dispersion and  Rao's quadratic entropy. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r SAC}
library(ape)
traits <- c('WD', 'Thick', 'LA', 'LDMC', 'SLA', 'WES', 'LES')
traits <- c(paste0(traits, '.cwm'), paste0(traits, '.cwv'))
traits <- list(c(traits, 'FRic.fd', 'FEve.fd', 'FDiv.fd', 'FDis.fd', 'RaoQ.fd'), traits, traits)
weights <- 1 / as.matrix(dist(coordinates(com$abundance)))
diag(weights) <- 0
SAC <- mapply(function(x,y){lapply(as.list(x@data[y]), Moran.I, weights)}, x =com, y = traits)
SAC <- lapply(SAC, function(x){do.call(rbind.data.frame, x)})
SAC <- lapply(SAC, function(x){paste(round(x$observed, 2), unlist(lapply(as.list(x$p.value), stars)))})
SAC[[2]] <- c(SAC[[2]], rep('', 5)) ; SAC[[3]] <- c(SAC[[3]], rep('', 5))
SAC <- data.frame(SAC)
names(SAC) <- c('Abundance', 'Presence-absence', 'Basal area')
SAC$Indice <- c(rep(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'Thick', 'LA'), 2), c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ'))
SAC$Type <- ''
SAC$Type[c(1,8,15)] <- c('CWM', 'CWV','FD')
SAC <- SAC[c('Type', 'Indice', 'Abundance', 'Presence-absence', 'Basal area')]
kable(SAC, row.names = F)
```


```{r 6 lm & null models}
reg <- '~ Slope + Curvature + Wetness + SW + Canopy + BA'
# LM to simplify with loop or lapply
LM <- lapply(com, function(x) {with(x@data, list(LES.cwm = lm(formula(paste('LES.cwm', reg))), # CWM
                                                 logSLA.cwm = lm(formula(paste('log(SLA.cwm)', reg))), 
                                                 WES.cwm = lm(formula(paste('WES.cwm', reg))),
                                                 WD.cwm = lm(formula(paste('WD.cwm', reg))),
                                                 LDMC.cwm = lm(formula(paste('LDMC.cwm', reg))),
                                                 logLA.cwm = lm(formula(paste('log(LA.cwm)', reg))),
                                                 Thick.cwm = lm(formula(paste('Thick.cwm', reg))),
                                                 LES.cwv = lm(formula(paste('LES.cwv', reg))), # CWV
                                                 logSLA.cwv = lm(formula(paste('log(SLA.cwv)', reg))), 
                                                 WES.cwv = lm(formula(paste('WES.cwv', reg))),
                                                 WD.cwv = lm(formula(paste('WD.cwv', reg))),
                                                 LDMC.cwv = lm(formula(paste('LDMC.cwv', reg))),
                                                 logLA.cwv = lm(formula(paste('log(LA.cwv)', reg))),
                                                 Thick.cwv = lm(formula(paste('Thick.cwv', reg)))))})
LM$abundance <- c(LM$abundance, with(com$abundance@data, list(FRic.fd = lm(formula(paste('FRic.fd', reg))),
                                                              FEve.fd = lm(formula(paste('FEve.fd', reg))),
                                                              FDiv.fd = lm(formula(paste('FDiv.fd', reg))),
                                                              FDis.fd = lm(formula(paste('FDis.fd', reg))),
                                                              RaoQ.fd = lm(formula(paste('RaoQ.fd', reg))))))
LM <- lapply(LM, function(y){lapply(y, function(x){step(x, direction = 'both', trace = 0)})})
model <- null_model(com, Trees, PFT_sp, lapply(LM, function(y){lapply(y, function(x){x$call})}), SpCode, n = 999, verbose = F, time = T)
```


## Community weighted means

Table 4: Summary for linear models and null models for traits community weighted means. _Linear model results for each trait community weighted means (by abundance (AB), presence-absence (PA) and basal area (BA)) after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). Model deviance was compared to 999 null model deviances in which traits were randomized among species. See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWM}
kable(regression_table(LM, model, reg, select = '.cwm'))
```

### Abiotic factors

First we can notice that, whereas the leaf economic spectrum shows significantly non-random links with abiotic factors, most of weighted means associated to the wood economic spectrum on our principal component analysis (see figure 1) didn't differ from null models. A spatial structure due to local individual history and dispersion is responsible for the observed links between abiotic factors and weighted mean associated to the wood economic spectrum. Outside from the leaf economic spectrum (LES), topography doesn't localy afect Uppangala plot trees as an environmental filter.

Leaf economic spectrum (LES) and specific leaf area (SLA) is associated non-randomly with convex and dry surfaces, as the thickness for basal area community weighted mean. Trees will tend to increase their surface compare to their carbon invest ment in areas where the water will flow but not accumulate nor stay, and where the soil will tend to accumulate and be stabilized. In favourable water and soil conditions, trees will tend to invest more in leaf ressource capture at the expense of leaf defense, adopting the acquisitive [@sterck_functional_2011] our fast growing strategy [@reich_world-wide_2014]. 

Wood density (WD) in presence absence shows a non-random association with southwest steep slope and concave surfaces with a relatively important explanation level ($R^2=0.25$). Trees will increase their wood density in thin soil and water and soil departure conditions under potential monsoon winds *(We need to decide or not if regarding the plot condition we can accept or not the southwest orientation as being linked to monsoon winds)*. In water stress and mechanical hazard conditions, trees will compensate by increasing their water transport safety and mechanical resistance and resilience with an increased wood density [@chave_towards_2009].

### Biotic factors

Most of community weighted means don't show association with biotic factors, and most of the rare association are not significantly different from null models randomly generated. Still leaf area (LA) in basal area is associated with high trees. Voluminous individuals tend to increase their leaf surface in heigher canopy condition to compensate understory shadow. And wood density tends also to increase with tree height for rare species, suggesting that with higher canopy denser wood species will tend to grow in a community, as shade species.

## Community weighted variances

Table 5: Summary for linear models and null models for traits community weighted variances. _Linear model results for each trait community weighted variances (by abundance (AB), presence-absence (PA) and basal area (BA)) after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). Model deviance was compared to 999 null model deviances in which traits were randomized among species. See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWV}
kable(regression_table(LM, model, reg, select = '.cwv'))
```

Most of traits and tree strategy axes didn't show linear models for community weighted variances (CWV) significantyl differently affected by both abiotic and biotic environment compare to null models. Only the leaf economic spectrum (LES) and wood density (WD) showed linear models significantly different from null models for their community weighted variances (CWV) for all wieghts (abundance, presence-absence, and basal area). Leaf area community weighted variance by basal area showed also a significantly positive linear model with slope compare to null models.

Leaf economic spectra (LES) converge with better soil and water conditions in convex situations, and for abundant species oriented under monsoon wind LES diverge suggesting different adaptive strategies from species. Whereas wood density from abundant and rare species also diverged with the southwest orientation to monsoon winds, wood density from voluminous species converge with slope and diverge with the canopy height. Effectively under high canopy trees will be under a lot of shade situation, implying differing growth strategies and further more different wood densities. Leaf area also converge for voluminous species with slope.

## Functionnal diversity

Whereas functionnal richness (FRic) standardized by the *'global FRic'* that include all species is low and relatively stable (mean = 0.05, sd = 0.04);
functionnal eveness is high and relatively stable (mean = `r round(mean(com$abundance@data$FEve.fd), 2)`, sd = `r round(sd(com$abundance@data$FEve.fd), 2)`) in our communities as the functionnal diversity (mean = `r round(mean(com$abundance@data$FDiv.fd), 2)`, sd = `r round(sd(com$abundance@data$FDiv.fd), 2)`). Our communties are relatively poor in functionnal values but with an even and diverse trait distribution.

Table 6: Summary for linear models and null models for functionnal diversity indices (FD). _Linear model results for each community functionnal indices weighted by abundances after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). Model deviance was compared to 999 null model deviances in which traits were randomized among species. FRic, FEve, FDiv, FDis  and RaoQ stand respectively for functionnal richness, eveness, diversity dispersion and  Rao's quadratic entropy. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._ 

```{r FD}
kable(regression_table(LM, model, reg, select = '.fd')[-2], row.names = F)
```

At the exception of the functionnal richness (FRic), all linear models for functionnal diversity indices didn't differ from null models suggesting that our bioctic and abitotic factors are not responsible for their distribution in our communities. Still functionnal richness increases with slope, suggesting as commmunity weighted variances (CWV) that our traits diverge in different adaptive strategies in steeper slopes.

## Models residuals

Table 6: Spatial autocorrelation measured by Moran's I for linear regression model residuals from community weighted means (CWM) and variances (CWV) and functionnal diversity indices (FD). _Spatial autocorrelation for residuals from each trait community weighted means and variances (by abundance, presence-absence and basal area) linear models and for functionnal diversity (FD) linear models, see table 1 for abbreviations. FRic, FEve, FDiv, FDis  and RaoQ stand respectively for functionnal richness, eveness, diversity dispersion and  Rao's quadratic entropy. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r SAC residuals}
library(ape)
weights <- 1 / as.matrix(dist(coordinates(com$abundance)))
diag(weights) <- 0
SAC <- lapply(LM, function(x){lapply(x, function(y){Moran.I(residuals(y), weights)})})
SAC <- lapply(SAC, function(x){do.call(rbind.data.frame, x)})
SAC <- lapply(SAC, function(x){paste(round(x$observed, 2), unlist(lapply(as.list(x$p.value), stars)))})
SAC[[2]] <- c(SAC[[2]], rep('', 5)) ; SAC[[3]] <- c(SAC[[3]], rep('', 5))
SAC <- data.frame(SAC)
names(SAC) <- c('Abundance', 'Presence-absence', 'Basal area')
SAC$Indice <- c(rep(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'Thick', 'LA'), 2), c('FRic', 'FEve', 'FDiv', 'FDis', 'RaoQ'))
SAC$Type <- ''
SAC$Type[c(1,8,15)] <- c('CWM', 'CWV','FD')
SAC <- SAC[c('Type', 'Indice', 'Abundance', 'Presence-absence', 'Basal area')]
kable(SAC, row.names = F)
```

Model residuals spatial autocorrelation (SAC)  for our community weighted means (CWM) is null confirming that our models explain fully the spatial structure of our 5 traits and 2 strategy axes (compare to table 3). At the exception of thickness that still shows a significant spatial autocorrelation, suggesting that our model missed spatially structured factors in this case. For models residuals from community weighted variances, specific leaf area, wood economic spectrum and leaf dry matter content still show a spatial structure. This spatial structure in local trait variances linked to alpha diversity may be explained by local history and stochasticty associated with a null distribution of individuals not directly shaped by their environment. Finally we find back this spatial structure unexplained by model for functionnal diversity indices.

## Individual filters

Absence of significant results with biotic factors and null results with abiotic factors on communities weighted mean brought us to study environmental filtering at the individual level. To do so we realized a fourthcorner (our RLQ) analysis with three matrices: *L*, the $Individuals*Species$ matrix linking the two other matrices, *Q*, the $Trait*Species$ matrix representing our functionnal traits, and *R* the $Environment*Individuals$ matrix representing both biotic and abiotic filtering. As a result, fourthcorner analysis brought no significant adjusted p-values between our functionnal traits and biotic and abiotic filters at the individual levels. Whereas communities show environmental filtering on tree functionnal traits and strategies, environmental filtering doesn't strongly affect trees on the individual level.

```{r RLQ}
library(ade4)
Deriv <- DEMderiv(Env$DEM, c('slope', 'curvature', 'aspect', 'wetness'))
Deriv$SW <- cos(Deriv$Aspect + 220)
Deriv <- Deriv[[-3]]

# Individuals
TreesNA <- Trees[-which(is.na(Trees$X)),]
TreesNA <- TreesNA[-which(is.na(TreesNA$`2013_girth`)),]
TreesNA <- TreesNA[-which(is.na(extract(Env$DEM, TreesNA[2:3], df = T)[2])),]
TreesNA <- TreesNA[-which(TreesNA$SpCode %in% levels(droplevels(PFT_sp[which(is.na(PFT_sp$WD)),1]))),]

# Matrices
Lm <- TreesNA[1]
Lm <- data.frame(tapply(rep(1, length(Lm[,1])), list(row.names(Lm), Lm$SpCode), sum))
Lm[is.na(Lm)] <- 0
Qm <- PFT_sp[which(names(PFT_sp) %in% c('SLA', 'LDMC', 'WD', 'Thick', 'LA'))]
row.names(Qm) <- PFT_sp$Sp_Code
Qm <- Qm[-which(is.na(Qm$WD)),]
Qm <- Qm[names(Lm),]
Rm <- cbind(extract(Deriv, TreesNA[2:3], df = T)[-1], TreesNA$`2013_girth`)
names(Rm)[5] <- 'Girth'
row.names(Rm) <- row.names(Lm)

# RLQ
L <- dudi.coa(Lm, scannf = FALSE)
R <- dudi.pca(Rm, scannf = FALSE, row.w = L$lw)
Q <- dudi.pca(Qm, scannf = FALSE, row.w = L$cw)
rlq <- rlq(R, L, Q, scannf = FALSE)
rd <- randtest(rlq)
fq <- fourthcorner.rlq(rlq, type = "Q.axes")
fr <- fourthcorner.rlq(rlq, type = "R.axes")
fqr <- fourthcorner(Rm, Lm, Qm)
fqr.adj <- p.adjust.4thcorner(fqr, p.adjust.method.G = "fdr", p.adjust.method.D = "fdr")

# Results
# summary(rlq)
# plot(rlq)
# s.arrow(rlq$l1)
# s.arrow(rlq$c1)
# s.label(rlq$lQ, boxes = FALSE)
# plot(fqr.adj, alpha = 0.5, stat = "D2")
# plot(fqr.adj, x.rlq = rlq, alpha = 0.05, stat = "D2", type = "biplot")
# plot(fq, alpha = 0.1, stat = "D2")
# plot(fr, alpha = 0.1, stat = "D2")
# print(fq, stat = 'D')
# print(fr, stat = 'D')
```

## Phylogenetic signal

Phylogenetic autocorrelation was investigated with Morans'I indice on 60 species that had information for all 5 measured traits and the two strategy axes and by looking at the phylogenetic correlogram wiht the `phylosignal` R package [@keck_phylosignal:_2016]. Thickness, leaf dry matter content, and wood economic spectrum were the only one to be significantly non null with a positive correlation for all of theim (between 0.01 and 0.03) in a short phylogenetic distance between 0 and approximatively 100. 

```{r phylosignal, include=FALSE}
library(phylosignal)
library(phytools)
library(phylobase)

# Building species list
sp <- Species[which(Species$LatinName %in% row.names(PFT_sp)), 2:3]
sp$genus <- unlist(lapply(strsplit(sp$LatinName, ' ', fixed = T), function(x){x[1]}))
sp$species <- sub(' ', '_', sp$LatinName, fixed = T)
sp$family <- sp$Family
sp <- sp[c('species', 'genus', 'family')]
sp[which(sp$family == 'Flacourtiaceae'),3] <- 'Salicaceae'
sp[which(sp$family == 'Steruliaceae'),3] <- 'Malvaceae'
sp[which(sp$family == 'Cesaliniaceae'),3] <- 'Fabaaceae'
# sp['cato','family'] <- 'Lamiaceae'
# sp['clvi',] <- c('Clerodendrum_infortunatum', 'Clerodendrum', 'Lamiaceae')
# sp['glma','family'] <-'Phyllanthaceae'
# sp['gote','family'] <- 'Stemonuraceae'
# sp['goca','family'] <- 'Annonaceae'
# sp['liol','family'] <- 'Lauraceae'
# sp['mewi','family'] <- 'Melastomataceae'
# sp['blde',] <- c('Blachia_andamanica', 'Blachia', 'Euphorbiaceae')
sp['hepa','family'] <- 'Malvaceae'
# sp['lemo','family'] <- 'Malvaceae'
# sp['hubr','family'] <- 'Leguminosae' # Humboldtia is unmatched !
sp <- sp[-which(row.names(sp) == 'hubr'),]
sp <- sp[-which(row.names(sp) %in% levels(droplevels(PFT_sp[which(is.na(PFT_sp$WD)),1]))),]

# Getting phylogeny
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
results <- S.PhyloMaker(sp, phylo, nodes)

# Phylosignal
tree <- results$Scenario.1
data <- PFT_sp
row.names(data) <- sub(' ', '_', row.names(data), fixed = T)
data <- data[tree$tip.label,c(2:5,7,9:10)]
p4d <- phylo4d(tree, data)
barplot.phylo4d(p4d, tree.type = "phylo", tree.ladderize = TRUE)
# phylosim <- phyloSim(tree = tre, method = "all", nsim = 100, reps = 99)
# plot.phylosim(phylosim, what = "pval", stacked.methods = TRUE)
phyCor <- lapply(as.list(names(data)), function(x){phyloCorrelogram(p4d, trait = as.character(x))})
# par(mfrow = c(2,4))
# for(i in 1:length(names(data))) plot(phyCor[[i]], main = names(data)[i])
lipa <- lipaMoran(p4d)
# barplot.phylo4d(p4d, bar.col=(lipa$p.value < 0.05) + 1, center = F, scale = F)
```


# *Future directions*

- Tree estimated height with `BIOMASS`

# References
