---
title: "Uppangala trees functionnal traits"
author: "Sylvain Schmitt"
date: '`r Sys.Date()`'
output: html_document
fig_caption: yes
vignette: |
  %\VignetteIndexEntry{Uppangala PFT} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---
# Data

## Data cleaning

### Load data

Data loading from gen functions, that open data from raw tables in *inst/extdata*

```{r Load data, echo=TRUE, message=FALSE, warning=FALSE}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
```

#### Uncorrectable errors

Errors in PFT values :

* Wood density > 1, being Gummi gutta sample P5.122 to small to measure a correct wood density
* Thickness outliers due to veins but correct entered data

### Outlier research

```{r variances, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(3,1))
bymedian <- with(PFT, reorder(Sp_Code, -Thick,  mean, na.rm = T))
boxplot(Thick ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['Thick'])
bymedian <- with(PFT, reorder(Sp_Code, -LA,  mean, na.rm = T))
boxplot(log(LA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(LA)'])
bymedian <- with(PFT, reorder(Sp_Code, -LDMC,  mean, na.rm = T))
boxplot(LDMC ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['LDMC'])
bymedian <- with(PFT, reorder(Sp_Code, -SLA,  mean, na.rm = T))
boxplot(log(SLA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(SLA)'])
bymedian <- with(PFT, reorder(Sp_Code, -log(SHA),  mean, na.rm = T))
boxplot(log(SHA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(SHA)'])
bymedian <- with(PFT, reorder(Sp_Code, -WD,  mean, na.rm = T))
boxplot(WD ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['WD'])
rm(bymedian)
```

### Leaf Principal component analysis

```{r Leaf PCA, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
pca <- princomp(~ LA + WD + Thick + LDMC + SLA + SHA, data = PFT, cor = T)
par(mfrow = c(1,1))
col = rainbow(93)[as.numeric(PFT[row.names(pca$scores),3])]
plot(pca$scores[,1:2], pch = 16, cex = 0.6, col = col)
rm(col, pca)
```

## Traits informations

#### Distributions

```{r distributions, echo=FALSE, fig.height=8, fig.width=8}
par(mfrow = c(3,2))
hist(PFT$Thick, prob = T)
lines(density(PFT$Thick, na.rm = T), col = "red")
hist(log(PFT$LA), prob = T)
lines(density(log(PFT$LA), na.rm = T), col = "red")
hist(PFT$LDMC, prob = T)
lines(density(PFT$LDMC, na.rm = T), col = "red")
hist(log(PFT$SLA), prob = T)
lines(density(log(PFT$SLA), na.rm = T), col = "red")
hist(log(PFT$SHA), prob = T)
lines(density(log(PFT$SHA), na.rm = T), col = "red")
hist(PFT$WD, prob = T)
lines(density(PFT$WD, na.rm = T), col = "red")
```

### Individual aggregation

```{r Individual aggragetion, message=FALSE, warning=FALSE}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
rm(SpT, Sp, SpCodeT, CET, CE, PFT)
```

### Tree Principal component analysis

```{r Tree PCA, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
library(vegan)
pca <- princomp(~ LA + WD + Thick + LDMC + SLA + SHA, data = PFT_ind, cor = T)
par(mfrow = c(1,1))
pca.var = apply(pca$score, 2, var)
barplot((pca.var / sum(pca.var)), las = 2, 
        main = 'StdInertia', ylim = c(0,range(bstick(7))[2]))
lines(bstick(7), col = 'red')
legend('bottomleft', c('PCA', 'broken stick'), fill = c('grey', 'red'))
biplot(pca, col = c('grey', 'red'), choices = c(1,2))
PCAscores <- as.data.frame(pca$scores) # Adding PCA axis in PFT values
PCAscores$ID <- row.names(PCAscores)
PFT_ind$ID <- row.names(PFT_ind)
PFT_ind <- merge(PFT_ind, PCAscores, all = T)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
rm(pca.var, PCAscores)
```


### Traits relations

```{r Traits relations, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
library(smatr)
par(mfrow = c(2,2))
PFTrel("LDMC", "Thick", PFT_ind, captions, cex = 0.7)
PFTrel("LDMC", "WD", PFT_ind, captions)
PFTrel("LDMC", "log(SLA)",  PFT_ind, captions)
PFTrel("Thick", "log(SLA)",  PFT_ind, captions)
PFTrel('log(LA)', "LDMC", PFT_ind, captions)
PFTrel('log(LA)', "WD", PFT_ind, captions)
PFTrel('log(LA)', "Thick", PFT_ind, captions)
X = PFT_ind$SLA*PFT_ind$LDMC
Y = PFT_ind$Thick
plot(Y ~ X, xlab = paste(captions['SLA'], 'x', captions['LDMC']), ylab = captions['Thick'], main = 'Thick ~ (SLA*LDMC)')
abline(sma(Y ~ X), col = 'red')
mtext(paste('Standardized Major Axis : R\u00b2 =',round(sma(Y ~ X)$r2[[1]], 2)), 1, col = 'red')
c <- cor.test(X, Y, method = 'spearman')
mtext(paste('Spearman\'s correlation : cor =', round(c$estimate, 2), stars(c$p.value)) , 3, col = 'blue')
rm(c, X, Y)
```

### Crown exposure effect

```{r CE, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
# library(lme4)
# CEtest <- data.frame(pca1 = pca$scores[,1],
#                      CEs = PFT_ind[row.names(pca$scores),which(names(PFT) == 'CEs')],
#                      Sp = PFT_ind[row.names(pca$scores),3])
# CEtest <- CEtest[-which(is.na(CEtest$CEs)),]
# m0 <- lmer(pca1 ~ CEs + (1 | CEs), CEtest)
# m1 <- lmer(pca1 ~ CEs + (Sp | CEs), CEtest)
# anova(m0, m1)
# rm(CEtest)
```


# Trees and environment

## Environment

### Load data

```{r Load env, echo=TRUE, message=FALSE, warning=FALSE}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Species <- genSpecies()
hillshade <- DEMderiv(Env$DEM, c("slope", "aspect", "hillshade"))$Hillshade # For plotting purposes
```

```{r Trees plot, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(1,1))
plot(hillshade, col = grey(0:100/100), main = 'Trees ~ Girth + Sp')
points(Y ~ X, Trees, col = SpCode, cex = `2013_girth`/100, pch = 20)
legend("bottomleft", legend = 'Species', fill = 'lightgrey')
```

## Trees

```{r Species aggregation, message=FALSE, warning=FALSE}
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
Trees$SpCode <- tolower(Trees$SpCode)
rm(PFT_ind)
setdiff(PFT_sp$Sp_Code, Trees$SpCode)
setdiff(Trees$SpCode, PFT_sp$Sp_Code)
```

Difference between species

* Agrosystachis indica (agin) is not yet registered in the database
* Toona ciliata (toci) is not yet removed from the database
* We didn't collect 25 rare species from Uppangala plots

```{r Merging Trees and traits}
Trees$ID <- row.names(Trees)
l <- length(row.names(Trees))
Trees <- merge(Trees, PFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
l - length(row.names(Trees))
rm(l)
```

There is 91 trees in missing species of our PFT dataset.

```{r Plot WD, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
plot(hillshade, col=grey(0:100/100), main = 'Trees ~ Girth + WD')
col = heat.colors(100)[as.numeric(cut(Trees$WD, breaks = 100))]
points(Y ~ X, Trees, col = "black", cex = `2013_girth`/100, pch = 20)
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = captions['WD'], fill = 'orange')
rm(col)
```


# Null Models

## Community

Community definition by quadrat

```{r Community}
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
Trees_bin <- Trees[-which(duplicated(cbind(Trees$SpCode, Trees$com))),] ; Trees <- Trees_bin # For presence absence analysis
```
```{r Plot com, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
plot(hillshade, col=grey(0:100/100), main = 'Communities')
plot(as(com, "SpatialPolygons"), add = T)
col =  sample(rainbow(length(levels(as.factor(Trees$com)))))[as.numeric(as.factor(Trees$com))]
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = 'community', fill = 'grey')
rm(col, XY, Trees_bin)
```

### Distribution of traits

Some species distribtuion for SLA and WD by community

```{r dist com, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
library(cati)
par(mfrow = c(4,4), cex = 0.5)
rows = which(Trees$com %in% sample(levels(as.factor(Trees$com)), 8))
plotDistri(as.matrix(Trees$SLA[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0, 35))
plotDistri(as.matrix(Trees$WD[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0.3, 0.85))
rm(rows)
```

## Topographical classes definition

### Adding topo to communities

```{r com topo, echo=TRUE, message=FALSE, warning=FALSE}
com@data$id <- paste0('C', com@data$id)
com@data$DEM <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'DEM'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'aspect', 'wetness'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$SouthWesterness <- sin((com@data$Aspect + 202.5) / 180 * pi)
com@data$NorthEasterness <- cos((com@data$Aspect + 202.5) / 180 * pi)
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
rm(Deriv)
```

### Adding CWM to communities

```{r CWM}
CWM <- aggregate(Trees, by = list(Trees$com), mean, na.rm = T)
names(CWM)[1] <- 'id'
CWM <- CWM[-c(2:6,19)]
com <- merge(com, CWM)
summary(com)
plot(stack(com)[[12:23]])
rm(CWM)
```

### Topographical variables selection

Linear regression on all variables

```{r lm(CWm ~ topo), message=FALSE, warning=FALSE}
reg <- '~ DEM + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SouthWesterness*NorthEasterness'
LM <- with(com@data, list(Comp.1 = lm(formula(paste('Comp.1', reg))),
                          Comp.2 = lm(formula(paste('Comp.2', reg))),
                          Comp.3 = lm(formula(paste('Comp.3', reg))),
                          logSLA = lm(formula(paste('log(SLA)', reg))),
                          LDMC = lm(formula(paste('LDMC', reg))),
                          logLA = lm(formula(paste('log(LA)', reg))),
                          Thick = lm(formula(paste('Thick', reg))),
                          WD = lm(formula(paste('WD', reg)))))
cat('Shapiro test p-values :\n') ; unlist(lapply(LM, function(x){stars(shapiro.test(x$residuals)$p.value)})) # Homoscedasticity
# lapply(LM, summary)
lapply(LM, function(x){summary(step(x, trace = 0))})
rm(LM, reg)
```

Classes assignation and plot
```{r Plot pop, echo=FALSE, fig.height=8, fig.width=9, message=FALSE, warning=FALSE}
com@data$topo <- as.factor(with(com@data, topo_classes(Slope, Curvature, Aspect)))
par(mfrow = c(1,1))
col <- terrain.colors(7)[c(1,2,5,6,3,4)]
plot(raster(com, 'topo'), col = col, main = 'Topographical classes')
contour(Env$DEM, add = T)
legend('bottomleft', fill = col, legend = c('Concave surface', 'Convex plane surface', 'North-East steep slope', 'South-West steep slope', 'North-East mean slope', 'South-West mean slope'), cex = 0.7)
rm(col)
```

Species distribtuion for SLA and WD by populations

```{r dist pop, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(3,4))
Trees$topo <- extract(raster(com, 'topo'), Trees[2:3])
plotDistri(as.matrix(Trees$SLA), Trees$topo, Trees$SpCode, xlim = c(0, 35), ylim.cex = 1, plot.ask = F, multipanel = F, leg = F)
plotDistri(as.matrix(Trees$WD) , Trees$topo, Trees$SpCode, xlim = c(0.3, 0.85), ylim.cex = 3, plot.ask = F, multipanel = F, leg = F)
```

Anova with topographical classes

```{r ANOVA, message=FALSE, warning=FALSE}
ANOVA <- with(com@data, list(Comp.1 = aov(Comp.1 ~ topo),
                             Comp.2 = aov(Comp.2 ~ topo),
                             Comp.3 = aov(Comp.3 ~ topo),
                             SLA = aov(SLA ~ topo),
                             LDMC = aov(LDMC ~ topo),
                             LA = aov(LA ~ topo),
                             Thick = aov(Thick ~ topo),
                             WD = aov(WD ~ topo)))
cat('ANOVA p-values :\n') ; unlist(lapply(ANOVA, function(x){stars(summary(x)[[1]][['Pr(>F)']][1])}))
ANOVA <- ANOVA[which(lapply(ANOVA, function(x){summary(x)[[1]][['Pr(>F)']][1]}) < 0.05)]
lapply(ANOVA, TukeyHSD)
rm(ANOVA)
```

## Hypothesis

* Tree species mortality can be induced by both hydraulic failure as emboly or predation as herbivory
* PCA first compoment his loaded mainly by wood density, thickness ans leaf dry matter content
* Wood density is a proxy of species security face to water stress
* Both thickness and leaf dry matter content are proxy of resistance to herbivory
* As a conclusion PCA first component can be considered as link to tree species strategy for demographic performance
* We can consider Uppangala plots as relatively even in terms of precipitation, temperature, and soil properties (!strong assumption!)
* So far, influencing environmental filter on tree species demographic performance will be topography
* Topography will induced differences in water flow and soil accretion and stability
* Finally, PCA first component, as proxy of tree species demographic performance, should be non randomly distributed in communities because filtered by topography represented by defined topographical classes

## Model

```{r Model}
n <- 1000 # Number of wanted values
stat <-  c()
t0 <- Sys.time()
for(i in 1:(n-1)){ 
  NullPFT_sp <- PFT_sp
  row.names(NullPFT_sp) <- sample(row.names(PFT_sp))
  NullPFT_sp$Sp_Code <- SpCode[row.names(NullPFT_sp)]
  NullTrees <- Trees[c(1:4,18)]
  NullTrees$ID <- row.names(Trees)
  NullTrees <- merge(NullTrees, NullPFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
  row.names(NullTrees) <- NullTrees$ID
  NullTrees <- NullTrees[-which(names(NullTrees) == 'ID')]
  NullCWM <- aggregate(NullTrees, by = list(NullTrees$com), mean, na.rm = T)
  names(NullCWM)[1] <- 'id'
  NullCWM <- NullCWM[-c(2:6)]
  Nullcom <- com
  Nullcom@data <- Nullcom@data[c(1:10,24)]
  Nullcom <- merge(Nullcom, NullCWM)
  # plot(stack(raster(com, 'Comp.1'), raster(Nullcom, 'Comp.1')), 
  #      main = c('Reality', paste('Null model', i)))
  # cat(i, '\n')
  Fval <- summary(aov(WD ~ topo, Nullcom@data))[[1]][['F value']][1]
  stat <- c(stat, Fval)
}
stat.val <- summary(aov(WD ~ topo, com@data))[[1]][['F value']][1]
(Sys.time() - t0)
rm(NullPFT_sp, NullTrees, NullCWM, Nullcom)
```

## Result

```{r Result, echo=FALSE, fig.height=9, fig.width=9, message=FALSE, warning=FALSE}
par(mfrow = c(1,1))
ranks <- (rank(c(stat.val, stat))/n)
pval <- ranks[1]
if(pval > 0.5){
  pval <- 1 - pval # Two sided
}
plot(density(stat), main = 'Null Model with ANOVA F.stat : CWMbin(WD) ~ topo.classes')
lines(c(stat.val, stat.val), c(0,1), col = 'red', lwd = 2)
text(stat.val + 0.2, 0.1, 'Com\nval', col = 'red')
mtext(paste('p-value =', pval, stars(pval)), 3)
mtext(paste('Repetitions =', n), 1)
```

