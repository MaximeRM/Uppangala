---
title: "Uppangala trees functionnal traits"
author: "Sylvain Schmitt"
date: '`r Sys.Date()`'
output: html_document
fig_caption: yes
vignette: |
  %\VignetteIndexEntry{Uppangala PFT} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
---
# Traits

## Data cleaning

### Load data

Data loading from gen functions, that open data from raw tables in *inst/extdata*

```{r Load data, echo=TRUE, message=FALSE, warning=FALSE}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
```

#### Uncorrectable errors

Errors in PFT values :

* Wood density > 1, being Gummi gutta sample P5.122 to small to measure a correct wood density
* Thickness outliers due to veins but correct entered data

### Outlier research

```{r variances, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(3,2))
bymedian <- with(PFT, reorder(Sp_Code, -Thick,  mean, na.rm = T))
boxplot(Thick ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['Thick'])
bymedian <- with(PFT, reorder(Sp_Code, -LA,  mean, na.rm = T))
boxplot(log(LA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(LA)'])
bymedian <- with(PFT, reorder(Sp_Code, -LDMC,  mean, na.rm = T))
boxplot(LDMC ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['LDMC'])
bymedian <- with(PFT, reorder(Sp_Code, -SLA,  mean, na.rm = T))
boxplot(log(SLA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(SLA)'])
bymedian <- with(PFT, reorder(Sp_Code, -log(SHA),  mean, na.rm = T))
boxplot(log(SHA) ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['log(SHA)'])
bymedian <- with(PFT, reorder(Sp_Code, -WD,  mean, na.rm = T))
boxplot(WD ~ bymedian, data = PFT, las = 2, horizontal = F, main = captions['WD'])
rm(bymedian)
```

### Leaf Principal component analysis

```{r Leaf PCA, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
pca <- princomp(~ LA + WD + Thick + LDMC + SLA + SHA, data = PFT, cor = T)
par(mfrow = c(1,1))
col = rainbow(93)[as.numeric(PFT[row.names(pca$scores),3])]
plot(pca$scores[,1:2], pch = 16, cex = 0.6, col = col)
rm(col, pca)
```

## Traits informations

#### Distributions

```{r distributions, echo=FALSE, fig.height=8, fig.width=8}
par(mfrow = c(3,2))
hist(PFT$Thick, prob = T)
lines(density(PFT$Thick, na.rm = T), col = "red")
hist(log(PFT$LA), prob = T)
lines(density(log(PFT$LA), na.rm = T), col = "red")
hist(PFT$LDMC, prob = T)
lines(density(PFT$LDMC, na.rm = T), col = "red")
hist(log(PFT$SLA), prob = T)
lines(density(log(PFT$SLA), na.rm = T), col = "red")
hist(log(PFT$SHA), prob = T)
lines(density(log(PFT$SHA), na.rm = T), col = "red")
hist(PFT$WD, prob = T)
lines(density(PFT$WD, na.rm = T), col = "red")
```

### Individual aggregation

```{r Individual aggragetion, message=FALSE, warning=FALSE}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
rm(SpT, Sp, SpCodeT, CET, CE, PFT)
```

### Tree Principal component analysis

```{r Tree PCA, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE}
library(vegan)
pca <- princomp(~ LA + WD + Thick + LDMC + SLA + SHA, data = PFT_ind, cor = T)
par(mfrow = c(1,1))
pca.var = apply(pca$score, 2, var)
barplot((pca.var / sum(pca.var)), las = 2, 
        main = 'StdInertia', ylim = c(0,range(bstick(7))[2]))
lines(bstick(7), col = 'red')
legend('bottomleft', c('PCA', 'broken stick'), fill = c('grey', 'red'))
biplot(pca, col = c('grey', 'red'), choices = c(1,2))
PCAscores <- as.data.frame(pca$scores)[1:3] # Adding PCA axis in PFT values
names(PCAscores) <- c('PCA1', 'PCA2', 'PCA3')
PCAscores$ID <- row.names(PCAscores)
PFT_ind$ID <- row.names(PFT_ind)
PFT_ind <- merge(PFT_ind, PCAscores, all = T)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
rm(pca.var, PCAscores)
```


### Traits relations

```{r Traits relations, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
library(smatr)
par(mfrow = c(2,2))
PFTrel("LDMC", "Thick", PFT_ind, captions, cex = 0.7)
PFTrel("LDMC", "WD", PFT_ind, captions)
PFTrel("LDMC", "log(SLA)",  PFT_ind, captions)
PFTrel("Thick", "log(SLA)",  PFT_ind, captions)
PFTrel('log(LA)', "LDMC", PFT_ind, captions)
PFTrel('log(LA)', "WD", PFT_ind, captions)
PFTrel('log(LA)', "Thick", PFT_ind, captions)
X = PFT_ind$SLA*PFT_ind$LDMC
Y = PFT_ind$Thick
plot(Y ~ X, xlab = paste(captions['SLA'], 'x', captions['LDMC']), ylab = captions['Thick'], main = 'Thick ~ (SLA*LDMC)')
abline(sma(Y ~ X), col = 'red')
mtext(paste('Standardized Major Axis : R\u00b2 =',round(sma(Y ~ X)$r2[[1]], 2)), 1, col = 'red')
c <- cor.test(X, Y, method = 'spearman')
mtext(paste('Spearman\'s correlation : cor =', round(c$estimate, 2), stars(c$p.value)) , 3, col = 'blue')
rm(c, X, Y)
```

### Crown exposure effect

```{r CE, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
# library(lme4)
# CEtest <- data.frame(pca1 = pca$scores[,1],
#                      CEs = PFT_ind[row.names(pca$scores),which(names(PFT) == 'CEs')],
#                      Sp = PFT_ind[row.names(pca$scores),3])
# CEtest <- CEtest[-which(is.na(CEtest$CEs)),]
# m0 <- lmer(pca1 ~ CEs + (1 | CEs), CEtest)
# m1 <- lmer(pca1 ~ CEs + (Sp | CEs), CEtest)
# anova(m0, m1)
# rm(CEtest)
```


# Environment

## Load data

```{r Load env, echo=TRUE, message=FALSE, warning=FALSE}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Species <- genSpecies()
hillshade <- DEMderiv(Env$DEM, c("slope", "aspect", "hillshade"))$Hillshade # For plotting purposes
```

## Trees
```{r Trees plot, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
par(mfrow = c(1,1))
plot(hillshade, col = grey(0:100/100), main = 'Trees ~ Girth + Sp')
points(Y ~ X, Trees, col = SpCode, cex = `2013_girth`/100, pch = 20)
legend("bottomleft", legend = 'Species', fill = 'lightgrey')
```

## Traits

```{r Species aggregation, message=FALSE, warning=FALSE}
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
Trees$SpCode <- tolower(Trees$SpCode)
rm(PFT_ind)
setdiff(PFT_sp$Sp_Code, Trees$SpCode)
setdiff(Trees$SpCode, PFT_sp$Sp_Code)
```

Difference between species

* Agrosystachis indica (agin) is not yet registered in the database
* Toona ciliata (toci) is not yet removed from the database
* We didn't collect 25 rare species from Uppangala plots

```{r Merging Trees and traits}
Trees$ID <- row.names(Trees)
l <- length(row.names(Trees))
Trees <- merge(Trees, PFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
l - length(row.names(Trees))
rm(l)
```

There is 91 trees in missing species of our PFT dataset.

```{r Plot WD, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
plot(hillshade, col=grey(0:100/100), main = 'Trees ~ Girth + WD')
col = heat.colors(100)[as.numeric(cut(Trees$WD, breaks = 100))]
points(Y ~ X, Trees, col = "black", cex = `2013_girth`/100, pch = 20)
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = captions['WD'], fill = 'orange')
rm(col)
```


# Null Models

## Communities

Community definition by quadrat

```{r Communities}
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
Trees_bin <- Trees[-which(duplicated(cbind(Trees$SpCode, Trees$com))),] ; Trees <- Trees_bin # For presence absence analysis
```
```{r Plot com, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
plot(hillshade, col=grey(0:100/100), main = 'Communities')
plot(as(com, "SpatialPolygons"), add = T)
col =  sample(rainbow(length(levels(as.factor(Trees$com)))))[as.numeric(as.factor(Trees$com))]
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = 'community', fill = 'grey')
rm(col, XY, Trees_bin)
```

Some species distribtuion for SLA and WD by community

```{r dist com, echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}
library(cati)
par(mfrow = c(4,4), cex = 0.5)
rows = which(Trees$com %in% sample(levels(as.factor(Trees$com)), 8))
plotDistri(as.matrix(Trees$SLA[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0, 35))
plotDistri(as.matrix(Trees$WD[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0.3, 0.85))
rm(rows)
```

Adding topo to communities

```{r com topo, echo=TRUE, message=FALSE, warning=FALSE}
com@data$id <- paste0('C', com@data$id)
com@data$DEM <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'DEM'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'aspect', 'wetness'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$SouthWesterness <- sin((com@data$Aspect + 225) / 180 * pi)
com@data$NorthEasterness <- cos((com@data$Aspect + 225) / 180 * pi)
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
rm(Deriv)
```

Topographical classes assignation and plot

```{r Plot topo, echo=FALSE, fig.height=8, fig.width=9, message=FALSE, warning=FALSE}
com@data$topo <- as.factor(with(com@data, topo_classes(Slope, Curvature, Aspect)))
par(mfrow = c(1,1))
col <- c("#008B00", "#00CD00", "#009ACD", "#00BFFF", "#CD9B1D", "#FFC125")
# col <- terrain.colors(7)[c(1,2,5,6,3,4)]
plot(raster(com, 'topo'), col = col, main = 'Topographical classes', legend = F)
contour(Env$DEM, add = T)
legend('bottomleft', fill = col, legend = levels(com@data$topo), cex = 0.7)
rm(col)
```

Adding CWM to communities

```{r CWM, message=FALSE, warning=FALSE}
CWM <- aggregate(Trees, by = list(Trees$com), mean, na.rm = T)
names(CWM)[1] <- 'id'
CWM <- CWM[which(names(CWM) %in% c('id', 'Thick', 'LA', 'LDMC', 'SLA', 'WD', 'PCA1', 'PCA2', 'PCA3'))]
com <- merge(com, CWM)
rm(CWM)
summary(com)
plot(stack(com)[[which(names(com) %in% c('Thick', 'LA', 'LDMC', 'SLA', 'WD', 'PCA1', 'PCA2', 'PCA3'))]])
```

## Filters

Linear regression on all variables

```{r lm, echo=FALSE, message=FALSE, warning=FALSE}
reg <- '~ DEM + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SouthWesterness'
reg
LM <- with(com@data, list(PCA1 = lm(formula(paste('PCA1', reg))),
                          PCA2 = lm(formula(paste('PCA2', reg))),
                          PCA3 = lm(formula(paste('PCA3', reg))),
                          logSLA = lm(formula(paste('log(SLA)', reg))),
                          LDMC = lm(formula(paste('LDMC', reg))),
                          logLA = lm(formula(paste('log(LA)', reg))),
                          Thick = lm(formula(paste('Thick', reg))),
                          WD = lm(formula(paste('WD', reg)))))
cat('Shapiro test p-values :\n') ; unlist(lapply(LM, function(x){stars(shapiro.test(x$residuals)$p.value)})) # Homoscedasticity
lapply(LM, function(x){summary(step(x, trace = 0))})
rm(LM, reg)

```

Anova with topographical classes

```{r anova, echo=FALSE, message=FALSE, warning=FALSE}
ANOVA <- with(com@data, list(PCA1 = aov(PCA1 ~ topo),
                             PCA2 = aov(PCA2 ~ topo),
                             PCA3 = aov(PCA3 ~ topo),
                             SLA = aov(SLA ~ topo),
                             LDMC = aov(LDMC ~ topo),
                             LA = aov(LA ~ topo),
                             Thick = aov(Thick ~ topo),
                             WD = aov(WD ~ topo)))
cat('ANOVA p-values :\n') ; unlist(lapply(ANOVA, function(x){stars(summary(x)[[1]][['Pr(>F)']][1])}))
ANOVA <- ANOVA[which(lapply(ANOVA, function(x){summary(x)[[1]][['Pr(>F)']][1]}) < 0.05)]
lapply(ANOVA, TukeyHSD)
rm(ANOVA)
```

## Hypothesis

## Null models

```{r Model, echo=FALSE, fig.height=9, fig.width=9, message=FALSE, warning=FALSE}
model <- null_model(formula = 'WD ~ SouthWesterness', 
                    test = 'Anova lm Fvalue',
                    PFT_sp = PFT_sp, Trees = Trees, com = com, SpCode = SpCode,
                    n = 1000, plot = F, count = T, time = T)
plot_model(model)
```
