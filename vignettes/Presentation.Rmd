---
title: Study of spatial structure of taxonomic and functional diversity in a tropical
  forest tree community
author: "Sylvain Schmitt"
date: "June 9, 2016"
output:
  ioslides_presentation: default
  beamer_presentation:
    fig_caption: yes
    fig_height: 8
    fig_width: 10
    fonttheme: professionalfonts
  slidy_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Sampling

- 92 species
- 272 trees
- 1362 dried leaves
- 272 fresh leaves
- 272 fresh branch wood sample

## Direct measurements {.build}

- Tree crown exposure
- Leaf fresh weight
- Leaf thickness
- Leaf area
- Leaf dry weight
- Wood volume
- Wood dry weight

## Traits {.smaller}

```{r Traits, echo=FALSE, message=FALSE, warning=FALSE}
rm(list = ls()); invisible(gc())
library(Uppangala)
PFT <- genPFT()
captions <- genCaptions()
table <- data.frame(
  traits = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  `mean (sd)` = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  unit = c('um', 'mm2', 'mg.g-1', 'm2.kg-1', 'g.cm-3'),
  strategy = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
names(table)[3] <- 'mean (sd)'
library(knitr)
kable(table)
```

Table 1: Functionnal traits measured

## Traits variation {.smaller}

```{r Coefficients of variation, echo=FALSE, message=FALSE, warning=FALSE}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$SP
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$Sp_Code
names(SpCode) <- SpCodeT$SP
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$SP <- Sp[row.names(PFT_ind)]
PFT_ind$Sp_Code <- SpCode[as.character(PFT_ind$SP)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)), 
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)), 
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$SP), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)), 
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))                 
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
knitr::kable(cv)
```

Table 2: Coefficient of variation intra-individual, intra-specific and inter-specific

## Pricnipal component analysis {.smaller}

```{r PCA, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Principal component analysis (PCA) performed on individual trait means.', fig.height=5}
library(vegan)
pca <- princomp(~ LA + WD + Thick + LDMC + SLA, data = PFT_ind, cor = T)
lambda <- pca$sdev * sqrt(nrow(pca$scores))
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(lambda[1]/sum(lambda)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(lambda[2]/sum(lambda)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
par(mfrow = c(1,1))
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
pca.var = apply(pca$score, 2, var)
Hmisc::subplot(function(){
  barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(bstick(6), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3) ; axis (4)
PCAscores <- as.data.frame(pca$scores)[1:3] # Adding PCA axis in PFT values
names(PCAscores) <- c('PCA1', 'PCA2', 'PCA3')
PCAscores$ID <- row.names(PCAscores)
PFT_ind$ID <- row.names(PFT_ind)
PFT_ind <- merge(PFT_ind, PCAscores, all = T)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
```

##  Traits relations {.smaller}

```{r Traits relations, echo=FALSE, message=FALSE, warning=FALSE}
library(smatr)
par(mfrow = c(2,2))
PFTrel("WD", "log(SLA)", PFT_ind, captions)
PFTrel("log(LA)", "WD", PFT_ind, captions)
PFTrel("LDMC", "WD",  PFT_ind, captions)
X = PFT_ind$SLA*PFT_ind$LDMC
Y = PFT_ind$Thick
plot(Y ~ X, xlab = paste(captions['SLA'], 'x', captions['LDMC']), ylab = captions['Thick'], main = 'Thick ~ (SLA*LDMC)')
abline(sma(Y ~ X), col = 'red')
mtext(paste('Standardized Major Axis : R\u00b2 =',round(sma(Y ~ X)$r2[[1]], 2)), 1, col = 'red')
c <- cor.test(X, Y, method = 'spearman')
mtext(paste('Spearman\'s correlation : cor =', round(c$estimate, 2), stars(c$p.value)) , 3, col = 'blue')

```

## Uppangala plot trees {.smaller}

```{r Traits and Trees, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Mean species WD with all Uppangala individuals'}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Species <- genSpecies()
hillshade <- DEMderiv(Env$DEM, c("slope", "aspect", "hillshade"))$Hillshade
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$SP), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$Sp_Code <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
Trees$SpCode <- tolower(Trees$SpCode)
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp, by.x = 'SpCode', by.y = 'Sp_Code')
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
par(mfrow = c(1,1))
plot(hillshade, col=grey(0:100/100))
col = heat.colors(100)[as.numeric(cut(Trees$WD, breaks = 100))]
points(Y ~ X, Trees, col = "black", cex = `2013_girth`/100, pch = 20)
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = captions['WD'], fill = 'orange')
```

- 92 over 117 species (79%) & 98.8% tree individuals

## Communities definition {.smaller}

```{r Communities definition, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='20*20m2 communities'}
com <- quadrats()
Trees$com <- NA
XY <- data.frame(X = Trees$X, Y = Trees$Y)
XY <- XY[-which(is.na(XY$X)),] # Removing NA
coordinates(XY) <- ~ X + Y
proj4string(XY) <- crs(com)
Trees$com[which(!is.na(Trees$X))] <- (XY %over% com)[,1]
Trees$com[which(!is.na(Trees$com))] <- paste0('C', Trees$com[which(!is.na(Trees$com))])
plot(hillshade, col=grey(0:100/100))
plot(as(com, "SpatialPolygons"), add = T)
col =  sample(rainbow(length(levels(as.factor(Trees$com)))))[as.numeric(as.factor(Trees$com))]
points(Y ~ X, Trees, cex = `2013_girth`/100, pch = 20, col = col)
legend("bottomleft", legend = 'community', fill = 'grey')
```

## Communities distribution {.smaller}

```{r Communities distribution, echo=FALSE, fig.cap='2 examples of community trait distribution for SLA and WD', message=FALSE, warning=FALSE}
library(cati)
par(mfrow = c(2,2), cex = 0.5)
rows = which(Trees$com %in% sample(levels(as.factor(Trees$com)), 2))
plotDistri(as.matrix(Trees$SLA[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0, 35))
plotDistri(as.matrix(Trees$WD[rows]), Trees$com[rows], Trees$SpCode[rows],
           ylim.cex = 3, plot.ask = F, multipanel = F, leg = F, xlim = c(0.3, 0.85))
```

## Topography - Conitnuous variable {.smaller}

```{r Topography continous, echo=FALSE, fig.cap='Community topography', message=FALSE, warning=FALSE}
com@data$id <- paste0('C', com@data$id)
com@data$DEM <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'DEM'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'aspect'))
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$SouthWesterness <- sin((com@data$Aspect + 225) / 180 * pi)
com@data$NorthEasterness <- cos((com@data$Aspect + 225) / 180 * pi)
com@data$Rivers <- extract(Env$Rivers, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
par(mfrow = c(1,1), cex = 1)
plot(stack(com)[[-1]])
```


## Topography - Classes {.smaller}

```{r Topgraphy clases, echo=FALSE, fig.cap='Topographical classes', message=FALSE, warning=FALSE}
com@data$topo <- as.factor(with(com@data, topo_classes(Slope, Curvature, Aspect)))
col <- c("#008B00", "#00CD00", "#009ACD", "#00BFFF", "#CD9B1D", "#FFC125")
plot(raster(com, 'topo'), col = col, legend = F)
contour(Env$DEM, add = T)
legend('bottomleft', fill = col, legend = levels(com@data$topo), cex = 0.7)
```

## CWM - Abundances {.smaller}

```{r CWM ab, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Community weighted mean by abundance'}
CWM <- aggregate(Trees, by = list(Trees$com), mean, na.rm = T) #CWM abundance
names(CWM)[1] <- 'id'
CWM <- CWM[which(names(CWM) %in% c('id', 'Thick', 'LA', 'LDMC', 'SLA', 'WD', 'PCA1', 'PCA2'))]
com_abund <- merge(com, CWM)
plot(stack(com_abund[13:19]))
```

## CWM - Presence-Absence {.smaller}

```{r CWM bin, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Community weighted mean by presence-absence'}
Trees_bin <- Trees[-which(duplicated(cbind(Trees$SpCode, Trees$com))),] #CWM binary
CWM <- aggregate(Trees_bin, by = list(Trees_bin$com), mean, na.rm = T)
names(CWM)[1] <- 'id'
CWM <- CWM[which(names(CWM) %in% c('id', 'Thick', 'LA', 'LDMC', 'SLA', 'WD', 'PCA1', 'PCA2', 'PCA3'))]
com_bin <- merge(com, CWM)
plot(stack(com_bin[13:19]))
```

## CWM - Basal Area {.smaller}

```{r CWM ba, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Community weighted mean by basal area'}
library(plyr)
TreesBA <- Trees[-which(is.na(Trees$`2013_girth`)),] #CWM ba
CWM <- ddply(TreesBA, .(com), function(x){
  weighted.mean(x$SLA, x$`2013_girth`/2*pi, na.rm = T)})
CWM <- data.frame(id = CWM$com,
                  Thick = CWM$V1,
                  LA = ddply(TreesBA, .(com), function(x){weighted.mean(x$LA, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  LDMC = ddply(TreesBA, .(com), function(x){weighted.mean(x$SLA, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  SLA = ddply(TreesBA, .(com), function(x){weighted.mean(x$SLA, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  WD = ddply(TreesBA, .(com), function(x){weighted.mean(x$WD, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  PCA1 = ddply(TreesBA, .(com), function(x){weighted.mean(x$PCA1, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  PCA2 = ddply(TreesBA, .(com), function(x){weighted.mean(x$PCA2, x$`2013_girth`/2*pi, na.rm = T)})[,2],
                  PCA3 = ddply(TreesBA, .(com), function(x){weighted.mean(x$PCA3, x$`2013_girth`/2*pi, na.rm = T)})[,2])
com_ba <- merge(com, CWM)
plot(stack(com_ba[13:19]))
```

## Spatial organization {.smaller}

```{r Variogram, echo=FALSE, message=FALSE, warning=FALSE, fig.cap='Variogram example'}
plot(gstat::variogram(WD~1, as(com_abund, 'SpatialPointsDataFrame')))
```

## Continuous models {.smaller}

<img src="table.png" width="700" height="500" />

